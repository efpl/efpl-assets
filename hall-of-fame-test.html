<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>eFPL Hall of Fame</title>
<meta name="color-scheme" content="dark">

<link rel="preconnect" href="https://docs.google.com" crossorigin>
<link rel="preconnect" href="https://www.google.com" crossorigin>

<style>
:root{
  --bg: transparent;

  --card:#0f1e49;
  --card2:#13265b;
  --ink:#ffffff;
  --muted:#b8c6e3;
  --accent:#f9d71c;

  --line:rgba(249,215,28,.28);
  --hover:rgba(255,255,255,.05);
  --shadow:0 16px 32px rgba(0,0,0,.55);

  --ok:#2fbf71;
  --mid:#9aa4b2;
  --bad:#e01c71;
}

*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif}
img{max-width:100%;height:auto;display:inline-block}

.wrap{width:100%;max-width:1180px;margin:0 auto;padding:10px 10px 26px}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:14px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.pad{padding:12px}
.note{color:var(--muted);font-size:12px}

/* Mini hero (stats-style) */
.mini-hero{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);
  background:linear-gradient(90deg, rgba(249,215,28,.10), rgba(0,0,0,0));
}
.mh-left{display:flex;align-items:center;gap:10px;min-width:0}
.mh-logo{
  height:34px;width:auto;border-radius:10px;object-fit:contain;
  box-shadow:0 0 10px rgba(0,0,0,.6);
}
.mh-eyebrow{font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted)}
.mh-title{font-size:18px;font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mh-right{display:flex;align-items:center;gap:8px}
.mh-pill{
  border-radius:999px;border:1px solid rgba(249,215,28,.65);
  padding:5px 10px;font-size:12px;font-weight:900;
  background:linear-gradient(90deg, rgba(249,215,28,.18), rgba(249,215,28,.06));
  white-space:nowrap;
}

/* Tabs */
.tabs{
  display:flex;flex-wrap:wrap;gap:8px;
  padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);
}
.tab{
  border:1px solid rgba(249,215,28,.25);
  background:rgba(5,34,90,.35);
  color:var(--ink);
  padding:7px 12px;border-radius:999px;
  font-weight:1000;font-size:12px;cursor:pointer;
}
.tab.active{
  background:rgba(249,215,28,.18);
  border-color:rgba(249,215,28,.75);
}

.panel{padding:12px}
.panel[hidden]{display:none}

.sep{height:1px;background:rgba(255,255,255,.08);margin:10px 0}

/* Tables */
.table{width:100%;border-collapse:collapse;table-layout:auto}
thead th{
  background:var(--accent);
  color:#0b1b3d;
  padding:10px;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.04em;
  text-align:center;
}
tbody td{
  padding:10px;
  font-weight:650;
  text-align:center;
  vertical-align:middle;
}
tbody tr:nth-child(odd){background:var(--card)}
tbody tr:nth-child(even){background:var(--card2)}
tbody tr:hover{background:var(--hover)}
.left{text-align:left}
.right{text-align:right}
.numeric{font-variant-numeric:tabular-nums;font-feature-settings:"tnum" 1}

/* Rank medal style (leaderboard + podium) */
.rank-medal{
  display:inline-flex;align-items:center;justify-content:center;
  width:28px;height:28px;border-radius:999px;
  background:rgba(0,0,0,.20);
  border:1px solid rgba(255,255,255,.12);
  font-weight:1000;
}
.rank-medal.r1{background:rgba(249,215,28,.20);border-color:rgba(249,215,28,.65)}
.rank-medal.r2{background:rgba(192,192,192,.12)}
.rank-medal.r3{background:rgba(205,127,50,.12)}

/* Pill */
.pill{
  display:inline-flex;align-items:center;justify-content:center;
  padding:4px 10px;border-radius:999px;
  font-weight:1000;font-size:12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.18);
}
.pill.accent{
  border-color:rgba(249,215,28,.7);
  background:linear-gradient(90deg, rgba(249,215,28,.18), rgba(249,215,28,.06));
}

/* Player link styling (both tabs) */
.player-link{
  cursor:pointer;
  font-weight:1000;
  text-decoration:none;
  color:var(--ink);
}
.player-link:hover{ text-decoration:underline; }

/* Leaderboard top row treatment */
tr.top1 td{
  background:linear-gradient(90deg, rgba(249,215,28,.26), rgba(249,215,28,.06)) !important;
  font-weight:1000;
}

/* ===== Season cards (desktop + mobile) ===== */
.season-list{display:grid;gap:10px}
.season-card{
  border:1px solid rgba(255,255,255,.12);
  border-radius:14px;
  overflow:hidden;
  background:rgba(0,0,0,.10);
}
.season-head{
  padding:10px 12px;
  display:flex;justify-content:space-between;align-items:center;gap:10px;
  cursor:pointer;
  background:linear-gradient(90deg, rgba(5,34,90,.60), rgba(0,0,0,0));
}
.season-title{
  display:flex;flex-direction:column;gap:2px;min-width:0;
}
.season-name{font-weight:1000;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.season-sub{font-size:12px;color:var(--muted)}
.chev{color:var(--accent);font-weight:1000}
.season-body{display:none;padding:10px 12px}

.podium{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  margin-bottom:10px;
}
@media(max-width:720px){
  .podium{grid-template-columns:1fr}
}
.podium-card{
  border:1px solid rgba(255,255,255,.12);
  border-radius:14px;
  padding:10px;
  background:rgba(0,0,0,.14);
}
.podium-top{display:flex;justify-content:space-between;align-items:center;gap:8px}
.podium-name{font-weight:1000}
.podium-sub{color:var(--muted);font-size:12px;margin-top:4px}

/* Flyout */
.flyout{
  position:absolute;z-index:9999;
  background:var(--card2);
  border:1px solid var(--line);
  border-radius:14px;
  padding:10px 12px;
  box-shadow:0 20px 38px rgba(0,0,0,.7);
  min-width:230px;max-width:320px;
  display:none;pointer-events:none;
}
.flyout .name{font-weight:1000;font-size:15px}
.flyout .sub{color:var(--muted);font-size:12px;margin-top:2px}
.flyout .mini{
  display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;
}
.flyout .stat{
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.14);
  border-radius:12px;
  padding:8px;
}
.flyout .stat .t{color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.06em}
.flyout .stat .v{font-weight:1000;font-size:16px;margin-top:2px}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <header class="mini-hero">
      <div class="mh-left">
        <img src="https://efpl-assets.pages.dev/img/logo.png" alt="eFPL logo" class="mh-logo">
        <div style="min-width:0">
          <div class="mh-eyebrow">Hall of Fame</div>
          <div class="mh-title">eFPL Season History and Leaderboard</div>
        </div>
      </div>
      <div class="mh-right">
        <span class="mh-pill" id="pill-updated">Loading…</span>
      </div>
    </header>

    <nav class="tabs" aria-label="Hall of Fame sections">
      <button class="tab active" data-tab="history" onclick="showTab('history')">Season History</button>
      <button class="tab" data-tab="leaderboard" onclick="showTab('leaderboard')">Leaderboard</button>
    </nav>

    <!-- SEASON HISTORY -->
    <section class="panel" id="history">
      <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap">
        <div>
          <div style="font-weight:1000;font-size:16px">Season History</div>
          <div class="note">Each season is collapsible. Winners are clickable/hoverable for trophy breakdown.</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <span class="note">Season</span>
          <select id="seasonFilter" onchange="applySeasonFilter()" style="
            background:#05225a;color:#fff;border:1px solid rgba(255,255,255,.2);
            border-radius:10px;padding:7px 10px;font-size:12px;font-weight:1000">
            <option value="all">All seasons</option>
          </select>
          <span class="pill accent" id="season-count-pill">-</span>
        </div>
      </div>

      <div class="sep"></div>

      <div id="seasonCards" class="season-list">
        <div class="note">Loading seasons…</div>
      </div>
    </section>

    <!-- LEADERBOARD -->
    <section class="panel" id="leaderboard" hidden>
      <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap">
        <div>
          <div style="font-weight:1000;font-size:16px">All-time Leaderboard</div>
          <div class="note">Hover or click a player to see what trophies they’ve won.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <span class="pill accent" id="lb-total">-</span>
          <span class="pill" id="lb-unique">-</span>
        </div>
      </div>

      <div class="sep"></div>

      <table class="table" id="t-leader"></table>
    </section>

  </div>
</div>

<div class="flyout" id="flyout"></div>

<script>
/* ================= CONFIG ================= */
const SHEET_ID="1DaYTkVVWiQVg7aianACoIfxXBZSKYqtycyuofX8WXj8";
const HISTORY_GID="1032615815";
const LEADER_GID="1964938799"; // optional, not required for this build

/* ================= STATE ================= */
let historyGV = null;

let HISTORY = { headers: [], rows: [] }; // rows: [{season, cells:[...]}]
let COMPETITIONS = []; // [{label, index}]
let COUNTS = null;     // overall player trophy counts
let ACTIVE_SEASON_FILTER = "all";

/* ================= UTILS ================= */
function esc(s){return String(s ?? '').replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));}
function gv(gid,range){
  return fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}&range=${range}`)
    .then(r=>r.text())
    .then(t=>JSON.parse(t.slice(t.indexOf('{'),t.lastIndexOf('}')+1)));
}
function val(c){ return (c && (c.v ?? c.f)) ?? ""; }
function key(x){ return String(x ?? "").trim(); }
function byId(id){ return document.getElementById(id); }
function normName(s){ return String(s ?? "").trim().replace(/\s+/g," "); }

function safeSeasonSortKey(seasonStr){
  const s = String(seasonStr ?? "");
  const m = s.match(/(\d+)/);
  if(m) return Number(m[1]);
  return -1;
}
function showTab(id){
  ["history","leaderboard"].forEach(pid=> byId(pid).hidden = (pid !== id));
  document.querySelectorAll(".tab").forEach(b=> b.classList.toggle("active", b.dataset.tab === id));
}

/* ================= PARSE ================= */
function parseHistory(gvData){
  const headers = (gvData.table.cols || []).map(c => (c.label || "").trim());
  const rows = (gvData.table.rows || []).map(r => (r.c || []).map(val));

  const cleanRows = rows
    .filter(r => r && r.some(x => String(x ?? "").trim() !== ""))
    .map(r => ({
      season: key(r[0]),
      cells: r.map(v => normName(v))
    }))
    .filter(r => r.season);

  return { headers, rows: cleanRows };
}

function buildCompetitions(headers){
  const comps = [];
  for(let i=1;i<headers.length;i++){
    const label = headers[i] || `Col ${i+1}`;
    comps.push({ label, index:i });
  }
  return comps;
}

/* ================= COUNTS (All-time trophies) ================= */
function computeAllTimeCounts(){
  const countsByPlayer = new Map();
  const breakdownByPlayer = new Map(); // player -> Map(compLabel -> count)

  HISTORY.rows.forEach(r=>{
    COMPETITIONS.forEach(c=>{
      const winner = normName(r.cells[c.index]);
      if(!winner) return;

      countsByPlayer.set(winner, (countsByPlayer.get(winner) || 0) + 1);

      if(!breakdownByPlayer.has(winner)) breakdownByPlayer.set(winner, new Map());
      const m = breakdownByPlayer.get(winner);
      m.set(c.label, (m.get(c.label) || 0) + 1);
    });
  });

  return { countsByPlayer, breakdownByPlayer };
}

function topBreakdownText(name, limit=3){
  const m = COUNTS.breakdownByPlayer.get(name);
  if(!m) return "-";
  const rows = [...m.entries()]
    .map(([comp,count])=>({comp,count}))
    .sort((a,b)=> b.count - a.count || a.comp.localeCompare(b.comp))
    .slice(0,limit);
  return rows.length ? rows.map(x=>`${x.comp}: ${x.count}`).join(" | ") : "-";
}

/* ================= FLYOUT ================= */
const fly = byId("flyout");
const supportsHover = window.matchMedia && window.matchMedia("(hover:hover)").matches;

function showFlyout(name, anchor){
  const total = COUNTS.countsByPlayer.get(name) || 0;
  const m = COUNTS.breakdownByPlayer.get(name);
  const rows = m ? [...m.entries()].map(([comp,count])=>({comp,count})) : [];
  rows.sort((a,b)=> b.count - a.count || a.comp.localeCompare(b.comp));

  fly.innerHTML = `
    <div class="name">${esc(name)}</div>
    <div class="sub">All-time trophy breakdown</div>
    <div class="mini">
      <div class="stat"><div class="t">Trophies</div><div class="v">${total}</div></div>
      <div class="stat"><div class="t">Competitions</div><div class="v">${rows.length}</div></div>
    </div>
    <div class="note" style="margin-top:10px">
      ${rows.length ? rows.slice(0,8).map(x=>`
        <div style="display:flex;justify-content:space-between;gap:10px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.06)">
          <span>${esc(x.comp)}</span><strong>${x.count}</strong>
        </div>
      `).join("") : "No trophies recorded yet."}
    </div>
  `;

  fly.style.display = "block";

  const rect = anchor.getBoundingClientRect();
  const scrollY = window.scrollY || document.documentElement.scrollTop || 0;
  const vw = document.documentElement.clientWidth;

  const w = fly.offsetWidth || 260;
  let left = rect.right + 10;
  const maxLeft = vw - w - 10;
  if(left > maxLeft) left = Math.max(10, rect.left - w - 10);
  const topPos = rect.top + scrollY - 8;

  fly.style.left = left + "px";
  fly.style.top = topPos + "px";
}
function hideFlyout(){ fly.style.display = "none"; }

/* ================= RENDER: LEADERBOARD ================= */
function renderLeaderboard(){
  const entries = [...COUNTS.countsByPlayer.entries()]
    .map(([name,count])=>({name,count}))
    .sort((a,b)=> b.count - a.count || a.name.localeCompare(b.name));

  byId("lb-total").textContent = `${entries.length} players`;
  byId("lb-unique").textContent = `${entries.length} unique winners`;

  let html = `
    <thead>
      <tr>
        <th style="width:5ch">#</th>
        <th class="left">Player</th>
        <th style="width:14ch">Trophies</th>
        <th class="left">Top trophies</th>
      </tr>
    </thead>
    <tbody>
  `;

  entries.forEach((r,i)=>{
    const medal =
      i===0 ? `<span class="rank-medal r1">1</span>` :
      i===1 ? `<span class="rank-medal r2">2</span>` :
      i===2 ? `<span class="rank-medal r3">3</span>` :
              `<span class="rank-medal">${i+1}</span>`;

    const breakdown = topBreakdownText(r.name, 2);
    const cls = (i===0) ? "top1" : "";

    html += `
      <tr class="${cls}">
        <td class="right numeric">${medal}</td>
        <td class="left">
          <span class="player-link" data-player="${esc(r.name)}">${esc(r.name)}</span>
        </td>
        <td class="center"><span class="pill accent">${r.count}</span></td>
        <td class="left note">${esc(breakdown)}</td>
      </tr>
    `;
  });

  html += `</tbody>`;
  byId("t-leader").innerHTML = html;

  // attach hover/click
  document.querySelectorAll(".player-link").forEach(el=>{
    const name = el.dataset.player;
    if(supportsHover){
      el.addEventListener("mouseenter", ()=> showFlyout(name, el));
      el.addEventListener("mouseleave", ()=> setTimeout(hideFlyout, 80));
    }
    el.addEventListener("click", ()=> showFlyout(name, el));
  });
}

/* ================= SEASON HISTORY (Collapsible) ================= */
function seasonWinnersList(row){
  // return list of {comp, winner}
  const out = [];
  COMPETITIONS.forEach(c=>{
    const w = normName(row.cells[c.index]);
    if(!w) return;
    out.push({ comp: c.label, winner: w });
  });
  return out;
}

function top3ForSeason(row){
  // based on who appears most in that season row (some seasons have multiple trophies)
  const m = new Map();
  seasonWinnersList(row).forEach(it=>{
    m.set(it.winner, (m.get(it.winner) || 0) + 1);
  });
  const arr = [...m.entries()].map(([name,count])=>({name,count}))
    .sort((a,b)=> b.count - a.count || a.name.localeCompare(b.name))
    .slice(0,3);
  return arr;
}

function renderSeasonCards(){
  const host = byId("seasonCards");

  let rows = [...HISTORY.rows]
    .sort((a,b)=> safeSeasonSortKey(b.season) - safeSeasonSortKey(a.season)); // newest first

  if(ACTIVE_SEASON_FILTER !== "all"){
    rows = rows.filter(r => key(r.season) === key(ACTIVE_SEASON_FILTER));
  }

  byId("season-count-pill").textContent = `${rows.length} season${rows.length===1?"":"s"}`;

  if(!rows.length){
    host.innerHTML = `<div class="note">No seasons found.</div>`;
    return;
  }

  host.innerHTML = rows.map((r,idx)=>{
    const winners = seasonWinnersList(r);
    const trophiesCount = winners.length;

    const top3 = top3ForSeason(r);
    const podiumHtml = top3.length ? `
      <div class="podium">
        ${top3.map((p,i)=>{
          const medal =
            i===0 ? `<span class="rank-medal r1">1</span>` :
            i===1 ? `<span class="rank-medal r2">2</span>` :
                    `<span class="rank-medal r3">3</span>`;
          return `
            <div class="podium-card">
              <div class="podium-top">
                ${medal}
                <span class="pill accent">${p.count} trophy${p.count===1?"":"ies"}</span>
              </div>
              <div style="margin-top:8px">
                <span class="player-link" data-player="${esc(p.name)}">${esc(p.name)}</span>
                <div class="podium-sub">Top winner this season</div>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    ` : `<div class="note">No trophies recorded for this season yet.</div>`;

    const itemsHtml = winners.length ? winners.map(it=>`
      <tr>
        <td class="left">${esc(it.comp)}</td>
        <td class="left"><span class="player-link" data-player="${esc(it.winner)}">${esc(it.winner)}</span></td>
        <td class="center"><span class="pill">Winner</span></td>
      </tr>
    `).join("") : `
      <tr><td colspan="3" class="note" style="text-align:center;padding:12px">No winners recorded.</td></tr>
    `;

    const bodyId = `season-body-${idx}`;
    return `
      <div class="season-card">
        <div class="season-head" onclick="toggleSeason('${bodyId}', this)">
          <div class="season-title">
            <div class="season-name">${esc(r.season)}</div>
            <div class="season-sub">${trophiesCount} trophy${trophiesCount===1?"":"ies"} recorded</div>
          </div>
          <div class="chev">▼</div>
        </div>

        <div class="season-body" id="${bodyId}">
          ${podiumHtml}

          <table class="table" style="margin-top:8px">
            <thead>
              <tr>
                <th class="left">Competition</th>
                <th class="left">Winner</th>
                <th style="width:14ch">Status</th>
              </tr>
            </thead>
            <tbody>
              ${itemsHtml}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }).join("");

  // attach player hover/click inside season cards
  document.querySelectorAll("#seasonCards .player-link").forEach(el=>{
    const name = el.dataset.player;
    if(supportsHover){
      el.addEventListener("mouseenter", ()=> showFlyout(name, el));
      el.addEventListener("mouseleave", ()=> setTimeout(hideFlyout, 80));
    }
    el.addEventListener("click", ()=> showFlyout(name, el));
  });
}

function toggleSeason(bodyId, headEl){
  const body = byId(bodyId);
  if(!body) return;

  const isOpen = body.style.display === "block";
  body.style.display = isOpen ? "" : "block";

  const chev = headEl.querySelector(".chev");
  if(chev) chev.textContent = isOpen ? "▼" : "▲";
}

function applySeasonFilter(){
  ACTIVE_SEASON_FILTER = byId("seasonFilter").value;
  renderSeasonCards();
}

/* ================= BOOT ================= */
(async function boot(){
  try{
    historyGV = await gv(HISTORY_GID, "A1:L");
  }catch(e){
    byId("pill-updated").textContent = "Sheet error";
    byId("seasonCards").innerHTML = `<div class="note">Could not load Hall of Fame sheet.</div>`;
    return;
  }

  HISTORY = parseHistory(historyGV);
  COMPETITIONS = buildCompetitions(HISTORY.headers);
  COUNTS = computeAllTimeCounts();

  // Season filter options
  const seasons = [...new Set(HISTORY.rows.map(r=>r.season))]
    .sort((a,b)=> safeSeasonSortKey(a) - safeSeasonSortKey(b));

  const sel = byId("seasonFilter");
  seasons.forEach(s=>{
    sel.insertAdjacentHTML("beforeend", `<option value="${esc(s)}">${esc(s)}</option>`);
  });

  // Render
  renderSeasonCards();
  renderLeaderboard();

  // Updated pill
  const now = new Date();
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const stamp = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
  byId("pill-updated").textContent = `Live • ${stamp}`;

  // Hide flyout on scroll/tap away
  window.addEventListener("scroll", ()=>{ if(supportsHover) hideFlyout(); }, { passive:true });
  document.addEventListener("click", (e)=>{
    const isPlayer = e.target.closest && e.target.closest(".player-link");
    const isFly = e.target.closest && e.target.closest("#flyout");
    if(!isPlayer && !isFly) hideFlyout();
  });
})();
</script>
</body>
</html>
