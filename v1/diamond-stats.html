<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>eFPL — Full Stats</title>

<!--
- Pulls live data from Standings + Fixtures (Embed)
- Uses Date Completed (col D) when present to order results for form/streaks
- Adds a player filter (dropdown) that re-renders KPIs, Records, Leaderboards, and Form
- 5-minute localStorage caching (like your other embeds)
-->

<style>
  :root{
    --bg:#000b26;
    --card:#00143b;
    --card2:#05225a;
    --ink:#ffffff;
    --muted:#cbd5e1;
    --accent:#f9d71c;
    --line:rgba(249,215,28,.35);
    --row1:#001a4d; --row2:#002060; --hover:#002b80;
  }
  html,body{background:transparent}
  body{margin:0;font:16px/1.6 system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}

  .wrap{max-width:1160px;margin:24px auto;padding:16px}
  .title{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px}
  .title h1{margin:0;font-size:clamp(24px,4.8vw,34px)}
  .badge{background:var(--accent);color:#0b1b3d;padding:4px 12px;border-radius:999px;font-weight:900}

  /* Filter UI */
  .filters{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin:6px 0 12px}
  .filters label{font-weight:800}
  .filters select{background:var(--card2);color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-weight:700}
  .filters button{background:var(--accent);color:#0b1b3d;border:none;border-radius:10px;padding:8px 12px;font-weight:900;cursor:pointer}
  .filters button:hover{opacity:.95}

  .grid{display:grid;gap:14px;grid-template-columns:1fr}
  @media (min-width:960px){ .grid{grid-template-columns:1.2fr .8fr} }

  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .card h2{margin:0 0 10px;font-size:20px}
  .sub{color:var(--muted);margin:2px 0 10px}

  .kpis{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
  .kpi{background:var(--card2);border:1px solid var(--line);border-radius:12px;padding:12px}
  .kpi .label{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.06em}
  .kpi .value{font-weight:900;font-size:22px;margin-top:4px}

  table{width:100%;border-collapse:collapse}
  thead th{background:var(--accent);color:#00143b;font-size:13px;text-transform:uppercase;letter-spacing:.03em;padding:10px;text-align:left}
  tbody td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06)}
  tbody tr:nth-child(odd){background:var(--row1)}
  tbody tr:nth-child(even){background:var(--row2)}
  tbody tr:hover{background:var(--hover)}
  .right{text-align:right}
  .center{text-align:center}
  .pill{display:inline-block;background:var(--accent);color:#00143b;font-weight:900;border-radius:999px;padding:2px 8px;font-size:12px}
  .muted{color:var(--muted)}

  .form{display:inline-grid;grid-auto-flow:column;gap:4px;align-items:center}
  .f{width:12px;height:12px;border-radius:3px;display:inline-block}
  .w{background:#22c55e}.d{background:#eab308}.l{background:#ef4444}

  .skeleton{background:linear-gradient(90deg,rgba(255,255,255,.05),rgba(255,255,255,.12),rgba(255,255,255,.05));background-size:200% 100%;animation:sk 1.1s infinite;border-radius:12px;min-height:160px;margin:8px 0}
  @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .fade-in{opacity:0;transition:opacity .18s ease}
  .fade-in.ready{opacity:1}

  @media (max-width:680px){ .wrap{padding:12px} .card{border-radius:10px} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <h1>League Stats Dashboard</h1>
      <div class="badge" id="updated">Loading…</div>
    </div>

    <!-- Player/Team filter -->
    <div class="filters">
      <label for="teamFilter">Filter:</label>
      <select id="teamFilter" aria-label="Filter by team">
        <option value="">All teams</option>
      </select>
      <button id="clearFilter" type="button">Reset</button>
    </div>

    <div class="grid">
      <section class="card fade-in" id="overview-card">
        <h2>Overview</h2>
        <p class="sub">Live KPIs computed from your fixtures and standings.</p>
        <div id="sk-overview" class="skeleton"></div>
        <div class="kpis" id="kpis"></div>
      </section>

      <section class="card fade-in" id="records-card">
        <h2>Records</h2>
        <p class="sub">Biggest win and highest scoring match.</p>
        <div id="sk-records" class="skeleton"></div>
        <div id="records"></div>
      </section>
    </div>

    <section class="card fade-in" id="leaderboards-card" style="margin-top:14px">
      <h2>Team Leaderboards</h2>
      <p class="sub">Top attack, best defense, points per game, and win rate.</p>
      <div id="sk-leaders" class="skeleton"></div>
      <div id="leaders"></div>
    </section>

    <section class="card fade-in" id="form-card" style="margin-top:14px">
      <h2>Form & Streaks</h2>
      <p class="sub">Last 5 results and current streak per team (uses Date Completed when available).</p>
      <div id="sk-form" class="skeleton"></div>
      <div id="form"></div>
    </section>
  </div>

<script>
/******************* CONFIG *******************/
const SHEET_ID   = '1pPQbrjEivgy88KtyVe5ABsKjQSDutZwEO51TgKIPF5E'; // <- replace if needed
const STAND_TAB  = 'Standings';
const STAND_RANGE= 'P1:Y17';
const FIX_TAB    = 'Fixtures (Embed)';
const FIX_RANGE  = 'A1:D1000';   // A=Home, B=Score or 'v', C=Away, D=Date Completed (optional)
const BUCKET_MS  = 5 * 60 * 1000;
const CB         = Math.floor(Date.now() / BUCKET_MS);

/***************** Helpers *****************/
const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
function parseGviz(txt){ const a=txt.indexOf('{'), b=txt.lastIndexOf('}'); if(a===-1||b===-1) throw new Error('Bad GViz'); return JSON.parse(txt.slice(a,b+1)); }
async function fetchSheet(sheet, range){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}&range=${encodeURIComponent(range)}&cachebust=${CB}`;
  const res = await fetch(url); const txt = await res.text(); if(!res.ok) throw new Error(res.status+' '+txt.slice(0,200));
  const json = parseGviz(txt); const headers = (json.table.cols||[]).map(c => (c.label||'').toString());
  const rows = (json.table.rows||[]).map(r => (r.c||[]).map(c => c ? c.v : ''));
  return { headers, rows };
}
function toNum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
function parseScore(str){ const m = String(str||'').match(/^(\d+)\s*[-–]\s*(\d+)$/); return m ? ({hg:+m[1], ag:+m[2]}) : null; }
function parseDateRaw(v){
  if(v instanceof Date) return v.getTime();
  if(typeof v === 'number'){
    if(v > 1e10) return v;
    const epoch = new Date(Date.UTC(1899,11,30));
    return new Date(epoch.getTime() + v*86400000).getTime();
  }
  const s = String(v||'').trim(); if(!s) return NaN;
  const t = Date.parse(s); return Number.isFinite(t) ? t : NaN;
}

/*************** LocalStorage paint ***************/
function paintInstant(id, key){
  try{
    const html = localStorage.getItem(key);
    if(html){
      document.getElementById(id).innerHTML = html;
      document.getElementById(id).closest('.fade-in')?.classList.add('ready');
      const sk = document.querySelector('#'+id).previousElementSibling;
      if(sk && sk.classList.contains('skeleton')) sk.style.display='none';
    }
  }catch(e){}
}
function saveHTML(key, html){ try{ localStorage.setItem(key, html); }catch(e){} }

paintInstant('kpis',    'efpl:stats:kpis');
paintInstant('records', 'efpl:stats:records');
paintInstant('leaders', 'efpl:stats:leaders');
paintInstant('form',    'efpl:stats:form');

// Global store for filtering
const STATE = { ready:false, base:null, filter:"" };

/***************** Main load *****************/
(async function main(){
  const updated = document.getElementById('updated');
  try{
    const [stand, fix] = await Promise.all([
      fetchSheet(STAND_TAB, STAND_RANGE),
      fetchSheet(FIX_TAB,   FIX_RANGE)
    ]);

    // 1) Parse standings headers
    const hL = stand.headers.map(h=>h.toLowerCase());
    const idx = {
      team:  hL.findIndex(h => /team|club|name/.test(h)),
      played:hL.findIndex(h => /\b(p|pl|played)\b/.test(h)),
      w:     hL.findIndex(h => /^w(?!\w)/.test(h) || /\bwon\b/.test(h)),
      d:     hL.findIndex(h => /^d(?!\w)/.test(h) || /\bdraw/.test(h)),
      l:     hL.findIndex(h => /^l(?!\w)/.test(h) || /\bloss|lost/.test(h)),
      gf:    hL.findIndex(h => /\bgf|for\b/.test(h)),
      ga:    hL.findIndex(h => /\bga|against\b/.test(h)),
      gd:    hL.findIndex(h => /\bgd|diff/.test(h)),
      pts:   hL.findIndex(h => /pts|points/.test(h))
    };

    // Build teams from standings
    const teams = {};
    for(const r of stand.rows){
      const name = r[idx.team]; if(!name) continue;
      teams[name] = {
        name,
        P: toNum(r[idx.played]), W: toNum(r[idx.w]), D: toNum(r[idx.d]), L: toNum(r[idx.l]),
        GF: toNum(r[idx.gf]), GA: toNum(r[idx.ga]), GD: toNum(r[idx.gd]), Pts: toNum(r[idx.pts]),
        results: [] // filled from fixtures by date
      };
    }

    // 2) Parse fixtures (use Date if present)
    const fxRows = fix.rows.filter(r => (r[0]||r[2]));
    const haveDate = fxRows.length && (fix.headers[3] || fxRows.some(r => r[3]));

    const matches = [];
    for(const r of fxRows){
      const home = r[0] ? String(r[0]).trim() : '';
      const mid  = r[1];
      const away = r[2] ? String(r[2]).trim() : '';
      if(!home && !away) continue;
      const score = parseScore(mid);
      const dateMs = haveDate ? parseDateRaw(r[3]) : NaN;
      const done = !!score;
      matches.push({home, away, score, done, date: dateMs});

      if(done){
        const {hg, ag} = score;
        if(teams[home]){
          teams[home].results.push({ts: Number.isFinite(dateMs)?dateMs:Infinity, gf: hg, ga: ag, outcome: hg>ag?'W':hg===ag?'D':'L', opp: away});
        }
        if(teams[away]){
          teams[away].results.push({ts: Number.isFinite(dateMs)?dateMs:Infinity, gf: ag, ga: hg, outcome: ag>hg?'W':ag===hg?'D':'L', opp: home});
        }
      }
    }

    // Sort results per team by date (fallback to sheet order if no dates)
    for(const t of Object.values(teams)){
      t.results.sort((a,b)=> a.ts - b.ts);
      const last5 = t.results.slice(-5);
      t.form = last5.map(x => x.outcome==='W'?'W':x.outcome==='D'?'D':'L');
      let streakType=null, streakLen=0; for(let i=t.results.length-1;i>=0;i--){
        const o=t.results[i].outcome; if(!streakType) { streakType=o; streakLen=1; }
        else if(o===streakType) streakLen++; else break;
      }
      t.streak = { type: streakType||'-', len: streakLen };
      const P = t.P || t.results.length; const W = t.W || t.results.filter(r=>r.outcome==='W').length;
      t.winRate = P? (W/P) : 0; t.ppg = P? ((t.Pts|| (W*3 + t.results.filter(r=>r.outcome==='D').length))/P) : 0;
    }

    // Completed, clean sheets
    const completed = matches.filter(m => m.done);
    const cleanSheets = {};
    for(const m of completed){
      if(m.score.ag === 0){ cleanSheets[m.home] = (cleanSheets[m.home]||0)+1; }
      if(m.score.hg === 0){ cleanSheets[m.away] = (cleanSheets[m.away]||0)+1; }
    }

    // Save base for filtering + populate dropdown
    STATE.base = { teams, matches, completed, cleanSheets };
    STATE.ready = true;

    const sel = document.getElementById('teamFilter');
    const names = Object.keys(teams).sort();
    sel.innerHTML = '<option value="">All teams</option>' + names.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
    sel.onchange = ()=> { STATE.filter = sel.value; applyFilter(); };
    document.getElementById('clearFilter').onclick = ()=> { sel.value=''; STATE.filter=''; applyFilter(); };

    // Initial render
    applyFilter();

    // Reveal + cache
    document.querySelectorAll('.fade-in').forEach(n => n.classList.add('ready'));
    document.querySelectorAll('.skeleton').forEach(n => n.style.display='none');

    document.getElementById('updated').textContent = 'Updated ' + new Date().toLocaleString();
  }catch(err){
    console.error(err);
    document.getElementById('updated').textContent = 'Error — ' + err.message;
    ['kpis','records','leaders','form'].forEach(id => document.getElementById(id).innerHTML = '');
  }
})();

/*************** Render with filter ***************/
function tb(rows, cols){
  let h='<table><thead><tr>'+cols.map(c=>`<th>${esc(c)}</th>`).join('')+'</tr></thead><tbody>';
  for(const r of rows){ h+='<tr>'+r.map((c,i)=>`<td class="${i>0?'right':''}">${esc(c)}</td>`).join('')+'</tr>'; }
  h+='</tbody></table>'; return h;
}
function formDots(f){ return `<span class="form">${f.map(x=>`<i class="f ${x==='W'?'w':x==='D'?'d':'l'}" title="${x}"></i>`).join('')}</span>`; }

function applyFilter(){
  const f = STATE.filter;
  const {teams, completed, cleanSheets} = STATE.base;
  const allTeams = Object.values(teams);

  // Scope
  const scopeMatches = f ? completed.filter(m=> m.home===f || m.away===f) : completed;
  const scopeTeams   = f ? allTeams.filter(t=> t.name===f) : allTeams;

  // KPIs
  const totalGames = scopeMatches.length;
  const totalGoals = scopeMatches.reduce((a,m)=> a + m.score.hg + m.score.ag, 0);
  const avgGPG = totalGames ? (totalGoals/totalGames) : 0;
  document.getElementById('kpis').innerHTML = `
    <div class="kpi"><div class="label">${f? 'Matches Played (for '+esc(f)+')':'Matches Played'}</div><div class="value">${totalGames}</div></div>
    <div class="kpi"><div class="label">Total Goals${f?' (both teams)':''}</div><div class="value">${totalGoals}</div></div>
    <div class="kpi"><div class="label">Avg Goals / Game</div><div class="value">${avgGPG.toFixed(2)}</div></div>
    <div class="kpi"><div class="label">Teams</div><div class="value">${f?1:Object.keys(teams).length}</div></div>
    <div class="kpi"><div class="label">Filter</div><div class="value">${f?esc(f):'All teams'}</div></div>
  `;

  // Records (within scope)
  let biggestWin=null, highestScoring=null;
  for(const m of scopeMatches){
    const diff=Math.abs(m.score.hg-m.score.ag), sum=m.score.hg+m.score.ag;
    if(!biggestWin || diff>biggestWin.diff) biggestWin={diff,m};
    if(!highestScoring || sum>highestScoring.sum) highestScoring={sum,m};
  }
  const fmt = o => o ? `<div><span class="pill">${o.m.score.hg}-${o.m.score.ag}</span> <span class="muted">${esc(o.m.home)} vs ${esc(o.m.away)}</span></div>` : '<div class="muted">—</div>';
  document.getElementById('records').innerHTML = `
    <table><thead><tr><th>Record${f? ' — '+esc(f):''}</th><th>Fixture</th></tr></thead><tbody>
      <tr><td>Biggest Win</td><td>${fmt(biggestWin)}</td></tr>
      <tr><td>Highest Scoring</td><td>${fmt(highestScoring)}</td></tr>
    </tbody></table>
  `;

  // Leaderboards (collapse to selected team when filtered)
  const topAttack   = [...scopeTeams].sort((a,b)=> b.GF - a.GF).slice(0, f?1:10);
  const bestDefense = [...scopeTeams].sort((a,b)=> a.GA - b.GA).slice(0, f?1:10);
  const topPPG      = [...scopeTeams].sort((a,b)=> b.ppg - a.ppg).slice(0, f?1:10);
  const topWR       = [...scopeTeams].sort((a,b)=> b.winRate - a.winRate).slice(0, f?1:10);
  document.getElementById('leaders').innerHTML = `
    <div style="display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
      <div class="card" style="padding:10px"><h3 style="margin:0 0 6px">Top Attack (GF)</h3>${tb(topAttack.map(t=>[t.name, t.GF]), ['Team','GF'])}</div>
      <div class="card" style="padding:10px"><h3 style="margin:0 0 6px">Best Defense (GA)</h3>${tb(bestDefense.map(t=>[t.name, t.GA]), ['Team','GA'])}</div>
      <div class="card" style="padding:10px"><h3 style="margin:0 0 6px">Points per Game</h3>${tb(topPPG.map(t=>[t.name, t.ppg.toFixed(2)]), ['Team','PPG'])}</div>
      <div class="card" style="padding:10px"><h3 style="margin:0 0 6px">Win Rate</h3>${tb(topWR.map(t=>[t.name, (t.winRate*100).toFixed(1)+'%']), ['Team','Win%'])}</div>
    </div>
  `;

  // Form table
  const formRows = scopeTeams.map(t=>{
    const cs = (cleanSheets[t.name]||0);
    const s  = t.streak;
    const P  = t.P || t.results.length;
    const GD = (t.GD || (t.GF - t.GA));
    return [ t.name, formDots(t.form), (s.type? `${s.type} ×${s.len}` : '—'), P, t.GF, t.GA, GD, (t.ppg||0).toFixed(2), ((t.winRate||0)*100).toFixed(1)+'%', cs ];
  }).sort((a,b)=> parseFloat(b[7]) - parseFloat(a[7]));
  document.getElementById('form').innerHTML = tb(formRows, ['Team','Form (Last 5)','Streak','P','GF','GA','GD','PPG','Win%','Clean Sheets']);

  // Cache filtered views too
  saveHTML('efpl:stats:kpis',    document.getElementById('kpis').innerHTML);
  saveHTML('efpl:stats:records', document.getElementById('records').innerHTML);
  saveHTML('efpl:stats:leaders', document.getElementById('leaders').innerHTML);
  saveHTML('efpl:stats:form',    document.getElementById('form').innerHTML);
}
</script>
</body>
</html>
