<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>eFPL Stats — Diamond</title>
<meta name="color-scheme" content="dark">
<link rel="preconnect" href="https://docs.google.com" crossorigin>
<link rel="preconnect" href="https://www.google.com" crossorigin>
<style>
  :root{
    --bg:#00143b; --ink:#ffffff; --muted:#cbd5e1;
    --card:#031e4a; --card2:#07265a; --accent:#f9d71c;
    --line:rgba(249,215,28,.25);
  }
  html,body{background:var(--bg)}
  body{margin:0;font:16px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}

  /* Header */
  .bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .bar h1{
    margin:0;font-weight:900;font-size:26px;display:flex;align-items:center;gap:10px;color:var(--ink);
  }
  .title-sponsor-logo{height:26px;transition:transform .2s}
  .bar a:hover .title-sponsor-logo{transform:scale(1.08)}
  .stamp{background:var(--accent);color:#00143b;font-weight:900;padding:10px 16px;border-radius:999px;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,.25);font-size:15px}

  /* Grid of stat cards */
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
  .card h3{margin:0 0 6px;font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
  .stat{font-size:24px;font-weight:900}
  .sub{font-size:13px;color:var(--muted);margin-top:4px}
  .wide{grid-column:1 / -1;background:linear-gradient(180deg, rgba(255,255,255,.03), transparent), var(--card2)}

  /* Tables */
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px;text-align:left}
  thead th{background:var(--accent);color:#00143b;font-weight:900;letter-spacing:.03em;font-size:13px}
  tbody td{border-bottom:1px solid rgba(255,255,255,.06)}
  .right{text-align:right}

  /* Sponsor footer */
  .sponsor-footer{margin-top:16px;text-align:center;font-size:13px;color:var(--muted);opacity:.9;padding:12px;border-top:1px solid var(--line);line-height:1.6}
  .sponsor-footer .footer-logo{height:28px;vertical-align:middle;margin:0 6px;transition:transform .2s}
  .sponsor-footer a:hover .footer-logo{transform:scale(1.08)}

  /* Mobile */
  @media (max-width:860px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:560px){
    .bar{flex-wrap:wrap;gap:8px}
    .bar h1{flex:1 1 100%;font-size:20px}
    .title-sponsor-logo{height:20px}
    .stamp{order:2;width:100%;font-size:12px;padding:6px 10px;text-align:left}
    .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <h1>
        <a href="https://www.instant-gaming.com/?igr=eFPL" target="_blank" rel="sponsored noopener noreferrer nofollow" aria-label="Instant Gaming — save on games">
          <img src="https://efpl-assets.pages.dev/img/instant-gaming.png" alt="Instant Gaming" class="title-sponsor-logo">
        </a>
        Diamond League | Season 1 — Stats
      </h1>
      <div id="stamp" class="stamp">Updated …</div>
    </div>

    <!-- Top stats -->
    <div class="grid" id="topStats">
      <div class="card"><h3>Total matches</h3><div class="stat" id="s-matches">–</div><div class="sub">Games with a recorded score</div></div>
      <div class="card"><h3>Total goals</h3><div class="stat" id="s-goals">–</div><div class="sub">Across all played matches</div></div>
      <div class="card"><h3>Avg goals / match</h3><div class="stat" id="s-avg">–</div><div class="sub">Total goals ÷ matches</div></div>

      <div class="card"><h3>Best attack (GF)</h3><div class="stat" id="s-best-attack">–</div><div class="sub" id="s-best-attack-team">–</div></div>
      <div class="card"><h3>Leakiest defence (GA)</h3><div class="stat" id="s-worst-def">–</div><div class="sub" id="s-worst-def-team">–</div></div>
      <div class="card"><h3>Clean sheets (most)</h3><div class="stat" id="s-cleansheets">–</div><div class="sub" id="s-cleansheets-team">–</div></div>

      <div class="card wide">
        <h3>Match highlights</h3>
        <div class="sub" id="s-highlights">–</div>
      </div>
    </div>

    <!-- Optional team tables -->
    <div class="card" style="margin-top:12px">
      <h3>Clean sheets by team</h3>
      <table id="tbl-clean">
        <thead><tr><th>Team</th><th class="right">Clean sheets</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Goals conceded by team</h3>
      <table id="tbl-ga">
        <thead><tr><th>Team</th><th class="right">GA</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Sponsor footer -->
    <div class="sponsor-footer">
      This page is sponsored by
      <a href="https://www.instant-gaming.com/?igr=eFPL" target="_blank" rel="sponsored noopener noreferrer nofollow" aria-label="Instant Gaming — save on games">
        <img src="https://efpl-assets.pages.dev/img/instant-gaming.png" alt="Instant Gaming" class="footer-logo">
      </a>
      Save up to <strong>90%</strong> on all digital games!
    </div>
  </div>

<script>
(async function(){
  /* ===== CONFIG (swap per league) ===== */
  const LEAGUE_NAME = 'Diamond League';
  const SHEET_ID    = '17OW81tsw1w2dCeP4AzcJlxa7gr6eFE9ExXJbuovLNNQ';   // Diamond
  const FIX_TAB     = 'Fixtures (Embed)';                                  // same tab you use
  const FIX_RANGE   = 'A1:C241';
  /* =================================== */

  // Utilities
  const pad = n => String(n).padStart(2,'0');
  function setStamp(){
    const d = new Date(); const yy = String(d.getFullYear()).slice(-2);
    document.getElementById('stamp').textContent = `Updated ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${yy}`;
  }
  setStamp();

  function parseGViz(text){
    const s = text.indexOf('{'), e = text.lastIndexOf('}');
    if(s===-1||e===-1) throw new Error('Bad GViz response');
    return JSON.parse(text.slice(s,e+1));
  }
  function scoreFrom(mid){
    // Accept formats like "2-1", "3 – 2", "1 : 0"
    const m = String(mid||'').match(/(\d+)\s*[-–:]\s*(\d+)/);
    return m ? [parseInt(m[1],10), parseInt(m[2],10)] : null;
  }

  // Fetch fixtures
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(FIX_TAB)}&range=${encodeURIComponent(FIX_RANGE)}`;
  const res = await fetch(url); const text = await res.text();
  const data = parseGViz(text);
  const rows = (data.table.rows||[]).map(r => (r.c||[]).map(c => c ? c.v : ''));

  // Detect header row
  const looksHeader = rows.length && (
    String(rows[0][0]||'').toLowerCase().includes('home') ||
    String(rows[0][2]||'').toLowerCase().includes('away')
  );
  const start = looksHeader ? 1 : 0;

  // Accumulators
  let matches=0, goals=0;
  const teams = new Map(); // name -> {gf,ga,cs,unbeaten}
  function teamRec(name){
    if(!teams.has(name)) teams.set(name,{gf:0,ga:0,cs:0,unbeaten:0,_currUnb:0});
    return teams.get(name);
  }
  let biggestWin = null;       // {home, away, diff, score}
  let highestScoring = null;   // {home, away, total, score}

  for(let i=start;i<rows.length;i++){
    const [home, mid, away] = [rows[i][0]||'', rows[i][1]||'', rows[i][2]||''];
    if(!home && !mid && !away) continue;

    const s = scoreFrom(mid);
    if(!s) continue; // not played yet
    const [h,a] = s;

    matches++;
    goals += h + a;

    const H = teamRec(home), A = teamRec(away);
    H.gf += h; H.ga += a; A.gf += a; A.ga += h;

    // Clean sheets
    if(a===0) H.cs++;
    if(h===0) A.cs++;

    // Unbeaten (very simple: +1 if not lost)
    if(h >= a){ H._currUnb++; A._currUnb = 0; } else { A._currUnb++; H._currUnb = 0; }
    H.unbeaten = Math.max(H.unbeaten, H._currUnb);
    A.unbeaten = Math.max(A.unbeaten, A._currUnb);

    // Biggest win (by goal difference)
    const diff = Math.abs(h-a);
    if(!biggestWin || diff > biggestWin.diff){
      biggestWin = {home,away,diff,score:`${h}-${a}`};
    }

    // Highest scoring (by total goals)
    const total = h + a;
    if(!highestScoring || total > highestScoring.total){
      highestScoring = {home,away,total,score:`${h}-${a}`};
    }
  }

  // Derive tops
  function topBy(key, dir='desc'){
    let topName = '-', topVal = 0;
    for(const [name, rec] of teams){
      const v = rec[key] || 0;
      if((dir==='desc' && v>topVal) || (dir==='asc' && (topName==='-' || v<topVal))){
        topVal = v; topName = name;
      }
    }
    return {name: topName, val: topVal};
  }
  const bestAttack = topBy('gf','desc');
  const worstDef   = topBy('ga','desc');
  const mostCS     = topBy('cs','desc');
  const bestUnb    = topBy('unbeaten','desc');

  // Paint top cards
  const set = (id,v) => document.getElementById(id).textContent = v;
  set('s-matches', matches || '0');
  set('s-goals', goals || '0');
  set('s-avg', matches ? (goals/matches).toFixed(2) : '0.00');

  set('s-best-attack', bestAttack.val || '0');
  set('s-best-attack-team', bestAttack.name);
  set('s-worst-def', worstDef.val || '0');
  set('s-worst-def-team', worstDef.name);
  set('s-cleansheets', mostCS.val || '0');
  set('s-cleansheets-team', mostCS.name);

  const hi = [];
  if(biggestWin) hi.push(`Biggest win: <strong>${biggestWin.home}</strong> vs <strong>${biggestWin.away}</strong> (${biggestWin.score}, +${biggestWin.diff})`);
  if(highestScoring) hi.push(`Highest scoring: <strong>${highestScoring.home}</strong> vs <strong>${highestScoring.away}</strong> (${highestScoring.score}, ${highestScoring.total} goals)`);
  if(bestUnb.name !== '-') hi.push(`Longest unbeaten run: <strong>${bestUnb.name}</strong> (${bestUnb.val})`);
  document.getElementById('s-highlights').innerHTML = hi.length ? hi.join(' &nbsp;•&nbsp; ') : 'No finished matches yet.';

  // Tables: clean sheets & GA
  function fillTable(tbodyId, rows){
    const tb = document.querySelector(`#${tbodyId} tbody`);
    tb.innerHTML = rows.map(([name,val]) => `<tr><td>${name}</td><td class="right">${val}</td></tr>`).join('');
  }
  // Clean sheets desc
  const csRows = Array.from(teams.entries()).map(([n,r])=>[n,r.cs]).sort((a,b)=>b[1]-a[1]);
  fillTable('tbl-clean', csRows);
  // GA desc
  const gaRows = Array.from(teams.entries()).map(([n,r])=>[n,r.ga]).sort((a,b)=>b[1]-a[1]);
  fillTable('tbl-ga', gaRows);

})();
</script>
</body>
</html>
