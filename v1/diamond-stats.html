<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>eFPL Stats — Diamond</title>
<meta name="color-scheme" content="dark">
<link rel="preconnect" href="https://docs.google.com" crossorigin>
<link rel="preconnect" href="https://www.google.com" crossorigin>
<style>
  :root{
    --bg:#00143b; --ink:#ffffff; --muted:#cbd5e1;
    --card:#031e4a; --card2:#07265a; --accent:#f9d71c;
    --line:rgba(249,215,28,.25);
  }
  html,body{background:var(--bg)}
  body{margin:0;font:16px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}

  /* Header */
  .bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .bar h1{margin:0;font-weight:900;font-size:26px;display:flex;align-items:center;gap:10px;color:var(--ink)}
  .title-sponsor-logo{height:26px;transition:transform .2s}
  .bar a:hover .title-sponsor-logo{transform:scale(1.08)}
  .stamp{background:var(--accent);color:#00143b;font-weight:900;padding:10px 16px;border-radius:999px;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,.25);font-size:15px}

  /* Grid of stat cards */
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
  .card h3{margin:0 0 6px;font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
  .stat{font-size:24px;font-weight:900}
  .sub{font-size:13px;color:var(--muted);margin-top:4px}
  .wide{grid-column:1 / -1;background:linear-gradient(180deg, rgba(255,255,255,.03), transparent), var(--card2)}

  /* Tables */
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px;text-align:left}
  thead th{background:var(--accent);color:#00143b;font-weight:900;letter-spacing:.03em;font-size:13px}
  tbody td{border-bottom:1px solid rgba(255,255,255,.06)}
  .right{text-align:right}

  /* Form chips */
  .form{display:flex;gap:6px;flex-wrap:wrap}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:900;font-size:12px}
  .W{background:#14b8a6;color:#072014}
  .D{background:#94a3b8;color:#0b1220}
  .L{background:#ef4444;color:#2a0e0e}

  /* Sponsor footer */
  .sponsor-footer{margin-top:16px;text-align:center;font-size:13px;color:var(--muted);opacity:.9;padding:12px;border-top:1px solid var(--line);line-height:1.6}
  .sponsor-footer .footer-logo{height:28px;vertical-align:middle;margin:0 6px;transition:transform .2s}
  .sponsor-footer a:hover .footer-logo{transform:scale(1.08)}

  /* Mobile */
  @media (max-width:860px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:560px){
    .bar{flex-wrap:wrap;gap:8px}
    .bar h1{flex:1 1 100%;font-size:20px}
    .title-sponsor-logo{height:20px}
    .stamp{order:2;width:100%;font-size:12px;padding:6px 10px;text-align:left}
    .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <h1>
        <a href="https://www.instant-gaming.com/?igr=eFPL" target="_blank" rel="sponsored noopener noreferrer nofollow" aria-label="Instant Gaming — save on games">
          <img src="https://efpl-assets.pages.dev/img/instant-gaming.png" alt="Instant Gaming" class="title-sponsor-logo">
        </a>
        Diamond League | Season 1 — Stats
      </h1>
      <div id="stamp" class="stamp">Updated …</div>
    </div>

    <!-- Top stats -->
    <div class="grid" id="topStats">
      <div class="card"><h3>Total matches</h3><div class="stat" id="s-matches">–</div><div class="sub">Games with a recorded score</div></div>
      <div class="card"><h3>Total goals</h3><div class="stat" id="s-goals">–</div><div class="sub">Across all played matches</div></div>
      <div class="card"><h3>Avg goals / match</h3><div class="stat" id="s-avg">–</div><div class="sub">Total goals ÷ matches</div></div>

      <div class="card"><h3>Home win %</h3><div class="stat" id="s-homewin">–%</div><div class="sub">Home wins / matches</div></div>
      <div class="card"><h3>Away win %</h3><div class="stat" id="s-awaywin">–%</div><div class="sub">Away wins / matches</div></div>
      <div class="card"><h3>Draws (total)</h3><div class="stat" id="s-draws">–</div><div class="sub">League-wide</div></div>

      <div class="card"><h3>Most draws (team)</h3><div class="stat" id="s-mostdraws-val">–</div><div class="sub" id="s-mostdraws-team">–</div></div>
      <div class="card"><h3>Fewest defeats</h3><div class="stat" id="s-fewestL-val">–</div><div class="sub" id="s-fewestL-team">–</div></div>
      <div class="card"><h3>Best attack (GF/avg)</h3><div class="stat" id="s-best-avg-gf">–</div><div class="sub" id="s-best-avg-gf-team">–</div></div>

      <div class="card"><h3>Best defence (lowest GA/avg)</h3><div class="stat" id="s-best-avg-ga">–</div><div class="sub" id="s-best-avg-ga-team">–</div></div>
      <div class="card"><h3>Most goals by one team (match)</h3><div class="stat" id="s-most-one-match">–</div><div class="sub" id="s-most-one-match-desc">–</div></div>
      <div class="card"><h3>Most conceded (match)</h3><div class="stat" id="s-most-conc-match">–</div><div class="sub" id="s-most-conc-match-desc">–</div></div>

      <div class="card"><h3>Longest winning streak</h3><div class="stat" id="s-streak-W">–</div><div class="sub" id="s-streak-W-team">–</div></div>
      <div class="card"><h3>Longest losing streak</h3><div class="stat" id="s-streak-L">–</div><div class="sub" id="s-streak-L-team">–</div></div>
      <div class="card"><h3>Longest draw streak</h3><div class="stat" id="s-streak-D">–</div><div class="sub" id="s-streak-D-team">–</div></div>

      <div class="card wide">
        <h3>Match highlights</h3>
        <div class="sub" id="s-highlights">–</div>
      </div>
    </div>

    <!-- Form table -->
    <div class="card" style="margin-top:12px">
      <h3>Current form (last 5)</h3>
      <table id="tbl-form">
        <thead><tr><th>Team</th><th>Form</th><th class="right">W–D–L</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="sub" style="margin-top:6px">Form is calculated by <em>Date Completed</em> (column I) so out-of-order results reflect real timing.</div>
    </div>

    <!-- Clean sheets & GA -->
    <div class="card" style="margin-top:12px">
      <h3>Clean sheets by team</h3>
      <table id="tbl-clean">
        <thead><tr><th>Team</th><th class="right">Clean sheets</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Goals conceded by team</h3>
      <table id="tbl-ga">
        <thead><tr><th>Team</th><th class="right">GA</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Sponsor footer -->
    <div class="sponsor-footer">
      This page is sponsored by
      <a href="https://www.instant-gaming.com/?igr=eFPL" target="_blank" rel="sponsored noopener noreferrer nofollow" aria-label="Instant Gaming — save on games">
        <img src="https://efpl-assets.pages.dev/img/instant-gaming.png" alt="Instant Gaming" class="footer-logo">
      </a>
      Save up to <strong>90%</strong> on all digital games!
    </div>
  </div>

<script>
(async function(){
  /* ===== SWAP THESE PER LEAGUE ===== */
  const LEAGUE_NAME = 'Diamond League';
  const SHEET_ID    = '17OW81tsw1w2dCeP4AzcJlxa7gr6eFE9ExXJbuovLNNQ'; // Diamond
  const FIX_TAB     = 'Fixtures (Embed)';
  // IMPORTANT: include column I now
  const FIX_RANGE   = 'A1:I241';  // A:Home, B:Score, C:Away, ... I:Date Completed
  /* ================================= */

  // Utils
  const pad = n => String(n).padStart(2,'0');
  function setStamp(){
    const d = new Date(); const yy = String(d.getFullYear()).slice(-2);
    document.getElementById('stamp').textContent = `Updated ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${yy}`;
  }
  setStamp();

  function parseGViz(text){
    const s = text.indexOf('{'), e = text.lastIndexOf('}');
    if(s===-1||e===-1) throw new Error('Bad GViz response');
    return JSON.parse(text.slice(s,e+1));
  }
  function scoreFrom(mid){
    const m = String(mid||'').match(/(\d+)\s*[-–:]\s*(\d+)/); // 2-1, 3 – 2, 1:0
    return m ? [parseInt(m[1],10), parseInt(m[2],10)] : null;
  }
  function parseDateCell(v){
    // GViz JSON sometimes returns "Date(YYYY,MM,DD,...)" or a plain string/date
    if(!v) return null;
    if(typeof v === 'string'){
      const m = v.match(/^Date\((\d+),\s*(\d+),\s*(\d+)(?:,[^)]+)?\)$/);
      if(m){
        const Y = +m[1], M = +m[2], D = +m[3];
        return new Date(Y, M, D);
      }
      const d = new Date(v);
      return isNaN(d) ? null : d;
    }
    if(v instanceof Date) return v;
    // sometimes Google returns objects like { "v": "Date(...)" } but we already pulled .v
    return null;
  }

  // Fetch fixtures
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(FIX_TAB)}&range=${encodeURIComponent(FIX_RANGE)}`;
  const res = await fetch(url); const text = await res.text();
  const data = parseGViz(text);
  const raw = (data.table.rows||[]).map((r,i) => ({ i, cells:(r.c||[]).map(c => c ? c.v : '') }));

  // Detect header row
  const looksHeader = raw.length && (
    String(raw[0].cells[0]||'').toLowerCase().includes('home') ||
    String(raw[0].cells[2]||'').toLowerCase().includes('away')
  );
  const start = looksHeader ? 1 : 0;

  // Build finished matches with a date
  const matchesList = [];
  for(let idx=start; idx<raw.length; idx++){
    const row = raw[idx].cells;
    const home = row[0]||'', mid = row[1]||'', away = row[2]||'';
    const dtVal = row[8]; // column I = index 8
    const sc = scoreFrom(mid);
    const dt = parseDateCell(dtVal);
    if(!home && !mid && !away) continue;
    if(!sc) continue;          // must have a score
    if(!dt) continue;          // must have a completion date
    matchesList.push({home, away, h:sc[0], a:sc[1], date:dt, rowIndex:idx});
  }

  // Sort by completion date (oldest -> newest). Tie-break by row index for stability.
  matchesList.sort((A,B) => (A.date - B.date) || (A.rowIndex - B.rowIndex));

  // Per-team record
  function newRec(){
    return {
      played:0, W:0, D:0, L:0, gf:0, ga:0, cs:0,
      streakW:0, bestW:0, streakL:0, bestL:0, streakD:0, bestD:0,
      form:[] // chronological; we'll keep last 5 for the UI
    };
  }
  const teams = new Map();
  const T = n => { if(!teams.has(n)) teams.set(n, newRec()); return teams.get(n); };

  // League accumulators & highlights
  let played=0, goals=0, homeWins=0, awayWins=0, draws=0;
  let biggestWin=null, highestScoring=null, mostByOne=null, mostConcededOne=null;

  // Process in chronological order
  for(const m of matchesList){
    const {home, away, h, a} = m;
    played++; goals += h+a;

    const H=T(home), A=T(away);
    H.played++; A.played++;
    H.gf+=h; H.ga+=a; A.gf+=a; A.ga+=h;
    if(a===0) H.cs++;
    if(h===0) A.cs++;

    let outcomeH, outcomeA;
    if(h>a){ outcomeH='W'; outcomeA='L'; homeWins++; }
    else if(h<a){ outcomeH='L'; outcomeA='W'; awayWins++; }
    else { outcomeH='D'; outcomeA='D'; draws++; }

    H[outcomeH]++; A[outcomeA]++;

    // streaks & form (date-aware)
    function updateStreak(rec, out){
      if(out==='W'){ rec.streakW++; rec.bestW=Math.max(rec.bestW, rec.streakW); rec.streakL=0; rec.streakD=0; }
      else if(out==='L'){ rec.streakL++; rec.bestL=Math.max(rec.bestL, rec.streakL); rec.streakW=0; rec.streakD=0; }
      else { rec.streakD++; rec.bestD=Math.max(rec.bestD, rec.streakD); rec.streakW=0; rec.streakL=0; }
      rec.form.push(out); // chronological push
    }
    updateStreak(H, outcomeH);
    updateStreak(A, outcomeA);

    // Highlights
    const diff = Math.abs(h-a);
    if(!biggestWin || diff > biggestWin.diff){ biggestWin = {home, away, diff, score:`${h}-${a}`}; }
    const total = h+a;
    if(!highestScoring || total > highestScoring.total){ highestScoring = {home, away, total, score:`${h}-${a}`}; }
    if(!mostByOne || h>mostByOne.goals){ mostByOne = {team:home, opponent:away, goals:h, score:`${h}-${a}`}; }
    if(!mostByOne || a>mostByOne.goals){ mostByOne = {team:away, opponent:home, goals:a, score:`${h}-${a}`}; }
    if(!mostConcededOne || a>mostConcededOne.goalsAgainst){ mostConcededOne = {team:away, opponent:home, goalsAgainst:a, score:`${h}-${a}`}; }
    if(!mostConcededOne || h>mostConcededOne.goalsAgainst){ mostConcededOne = {team:home, opponent:away, goalsAgainst:h, score:`${h}-${a}`}; }
  }

  // Leader pickers
  function topBy(fn, dir='desc'){
    let winner='–', val=null;
    for(const [name,rec] of teams){
      const v = fn(rec);
      if(v==null) continue;
      if(val==null || (dir==='desc' ? v>val : v<val)){ val=v; winner=name; }
    }
    return {name:winner, val:val==null?0:val};
  }
  function withPlayed(fn, dir='desc'){ return topBy(r=>r.played?fn(r):null, dir); }

  // Derivatives
  const homePct = played ? Math.round((homeWins/played)*100) : 0;
  const awayPct = played ? Math.round((awayWins/played)*100) : 0;

  const mostDraws = topBy(r=>r.D,'desc');
  const fewestL   = withPlayed(r=>r.L,'asc');

  const bestAvgGF = withPlayed(r=>r.gf/r.played,'desc');
  const bestAvgGA = withPlayed(r=>r.ga/r.played,'asc');

  const bestStreakW = topBy(r=>r.bestW,'desc');
  const bestStreakL = topBy(r=>r.bestL,'desc');
  const bestStreakD = topBy(r=>r.bestD,'desc');

  // Paint top cards
  const set = (id,v) => document.getElementById(id).textContent = v;
  set('s-matches', played || '0');
  set('s-goals', goals || '0');
  set('s-avg', played ? (goals/played).toFixed(2) : '0.00');
  set('s-homewin', homePct + '%');
  set('s-awaywin', awayPct + '%');
  set('s-draws', draws);

  set('s-mostdraws-val', mostDraws.val || '0'); set('s-mostdraws-team', mostDraws.name);
  set('s-fewestL-val', (fewestL.val ?? '0'));   set('s-fewestL-team', fewestL.name);

  set('s-best-avg-gf', bestAvgGF.val ? bestAvgGF.val.toFixed(2) : '0.00');
  set('s-best-avg-gf-team', bestAvgGF.name);
  set('s-best-avg-ga', bestAvgGA.val ? bestAvgGA.val.toFixed(2) : '0.00');
  set('s-best-avg-ga-team', bestAvgGA.name);

  set('s-most-one-match', mostByOne ? mostByOne.goals : '0');
  document.getElementById('s-most-one-match-desc').innerHTML = mostByOne ? `${mostByOne.team} vs ${mostByOne.opponent} (${mostByOne.score})` : '–';

  set('s-most-conc-match', mostConcededOne ? mostConcededOne.goalsAgainst : '0');
  document.getElementById('s-most-conc-match-desc').innerHTML = mostConcededOne ? `${mostConcededOne.team} vs ${mostConcededOne.opponent} (${mostConcededOne.score})` : '–';

  set('s-streak-W', bestStreakW.val || '0'); document.getElementById('s-streak-W-team').textContent = bestStreakW.name;
  set('s-streak-L', bestStreakL.val || '0'); document.getElementById('s-streak-L-team').textContent = bestStreakL.name;
  set('s-streak-D', bestStreakD.val || '0'); document.getElementById('s-streak-D-team').textContent = bestStreakD.name;

  // Highlights line
  const hi = [];
  if(biggestWin) hi.push(`Biggest win: <strong>${biggestWin.home}</strong> vs <strong>${biggestWin.away}</strong> (${biggestWin.score}, +${biggestWin.diff})`);
  if(highestScoring) hi.push(`Highest scoring: <strong>${highestScoring.home}</strong> vs <strong>${highestScoring.away}</strong> (${highestScoring.score}, ${highestScoring.total} goals)`);
  document.getElementById('s-highlights').innerHTML = hi.length ? hi.join(' &nbsp;•&nbsp; ') : 'No finished matches yet.';

  // Tables: Form (date-aware), Clean sheets, GA
  function fillTable(tbodyId, rows){
    const tb = document.querySelector(`#${tbodyId} tbody`);
    tb.innerHTML = rows.map(html => `<tr>${html}</tr>`).join('');
  }

  // Form points helper
  function formPoints(f){ return f.reduce((s,ch)=>s+(ch==='W'?3:ch==='D'?1:0),0); }

  // Build form entries using the *last 5 chronological* results
  const formRows = Array.from(teams.entries()).map(([name,r])=>{
    const f = r.form.slice(-5); // last 5 by date
    const pts = formPoints(f);
    const w = f.filter(x=>x==='W').length, d = f.filter(x=>x==='D').length, l = f.filter(x=>x==='L').length;
    const chips = f.map(x=>`<span class="chip ${x}">${x}</span>`).join(' ');
    return {name, html:`<td>${name}</td><td><div class="form">${chips || '<span class="sub">No recent games</span>'}</div></td><td class="right">${w}–${d}–${l} (${pts} pts)</td>`, pts};
  }).sort((a,b)=> b.pts - a.pts || a.name.localeCompare(b.name));
  fillTable('tbl-form', formRows.map(r=>r.html));

  // Clean sheets desc
  const csRows = Array.from(teams.entries()).map(([n,r])=>[n,r.cs]).sort((a,b)=>b[1]-a[1])
    .map(([n,v])=>`<td>${n}</td><td class="right">${v}</td>`);
  fillTable('tbl-clean', csRows);

  // GA desc
  const gaRows = Array.from(teams.entries()).map(([n,r])=>[n,r.ga]).sort((a,b)=>b[1]-a[1])
    .map(([n,v])=>`<td>${n}</td><td class="right">${v}</td>`);
  fillTable('tbl-ga', gaRows);

})();
</script>
</body>
</html>
