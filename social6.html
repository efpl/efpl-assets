<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>eFPL Season 2 ‚Äî Live Stats (Broadcast View)</title>
<meta name="color-scheme" content="dark">

<style>
/* ========= Base / Palette ========= */
:root{
  --bg:#020b2a;
  --bg-soft:#04163a;

  --ink:#f9fafb;
  --muted:#9ca3af;
  --accent:#f9d71c;
  --accent-soft:rgba(249,215,28,.18);
  --accent-line:rgba(249,215,28,.7);

  --line:rgba(148,163,184,.35);
  --ok:#22c55e;
  --mid:#9aa4b2;
  --away:#38bdf8;

  --diamond:#99ecff;
  --ruby:#e01c71;
  --sapphire:#008af1;
  --crystal:#868af1;
  --emerald:#3d9a5c;
  --gold:#f4d03f;
}

*,
*::before,
*::after{box-sizing:border-box}

html,body{
  margin:0;
  width:100%;
  min-height:100%;
  background:radial-gradient(140% 160% at 0% 0%, #0b1a3c, transparent 55%),
             radial-gradient(120% 180% at 100% 100%, #111827, transparent 55%),
             #020617;
  color:var(--ink);
  font:15px/1.5 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
}

img{max-width:100%;height:auto;display:inline-block}

/* ========= Shell ========= */
.wrap{
  width:100%;
  max-width:1280px;
  margin:0 auto;
  padding:20px 14px 40px;
}

/* ========= Top broadcast header ========= */
.broadcast-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
  gap:12px;
}
.broadcast-left{
  display:flex;
  align-items:center;
  gap:10px;
}
.broadcast-logo{
  height:40px;
  width:auto;
  border-radius:12px;
  background:#020b2a;
  padding:6px 8px;
  box-shadow:0 16px 40px rgba(0,0,0,.9);
}
.broadcast-title-block{
  display:flex;
  flex-direction:column;
  gap:2px;
}
.broadcast-eyebrow{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.26em;
  color:var(--muted);
}
.broadcast-title{
  font-size:22px;
  font-weight:900;
  letter-spacing:.08em;
  text-transform:uppercase;
}
.broadcast-right{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:4px;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.18em;
  color:var(--muted);
}
.broadcast-live-pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  background:linear-gradient(90deg,#dc2626,#facc15);
  color:#111827;
  font-weight:800;
  box-shadow:0 12px 30px rgba(0,0,0,.9);
}
.broadcast-live-dot{
  width:8px;
  height:8px;
  border-radius:999px;
  background:#ef4444;
}

/* ========= Scene tabs (segment bar) ========= */
.scene-tabs{
  display:flex;
  gap:8px;
  padding:8px;
  margin-bottom:16px;
  border-radius:999px;
  background:rgba(15,23,42,.9);
  box-shadow:0 18px 40px rgba(0,0,0,.8);
}
.scene-tab{
  flex:1;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.5);
  font-size:12px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.16em;
  color:var(--muted);
  text-align:center;
  cursor:pointer;
  background:rgba(15,23,42,.9);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  user-select:none;
  transition:
    background .18s ease,
    color .18s ease,
    border-color .18s ease,
    transform .12s ease;
}
.scene-tab span.icon{
  font-size:14px;
}
.scene-tab.active{
  background:linear-gradient(135deg,#facc15,#fef9c3);
  color:#111827;
  border-color:rgba(250,204,21,1);
  transform:translateY(-1px);
}
.scene-tab:hover:not(.active){
  border-color:rgba(249,215,28,.7);
}

/* ========= Scene panel (single ‚ÄúTV card‚Äù) ========= */
.scene{
  display:none;
}
.scene.active{
  display:block;
}

.scene-card{
  position:relative;
  max-width:1080px;
  margin:0 auto;
  border-radius:28px;
  padding:20px 22px 26px;
  background:radial-gradient(160% 200% at 0% 0%, rgba(249,215,28,.13), transparent 55%),
             radial-gradient(140% 180% at 100% 100%, rgba(56,189,248,.14), transparent 55%),
             linear-gradient(145deg,#020b2a,#020617);
  border:1px solid rgba(148,163,184,.6);
  box-shadow:
    0 26px 70px rgba(0,0,0,.95),
    0 0 0 1px rgba(15,23,42,1);
  overflow:hidden;
}
.scene-card::after{
  content:"eFPL ‚Ä¢ Season 2 ‚Ä¢ efpl.gg";
  position:absolute;
  left:0;
  right:0;
  bottom:0;
  padding:6px 22px 8px;
  font-size:10px;
  letter-spacing:.18em;
  text-transform:uppercase;
  color:rgba(148,163,184,.9);
  border-top:1px solid rgba(31,41,55,.9);
  background:linear-gradient(180deg,rgba(15,23,42,.8),rgba(15,23,42,1));
}

/* Inner container so footer strip doesn‚Äôt overlap content */
.scene-body{
  position:relative;
  z-index:1;
  padding-bottom:18px;
}

/* Scene headings */
.scene-heading{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:14px;
}
.scene-heading-main{
  display:flex;
  flex-direction:column;
  gap:2px;
}
.scene-eyebrow{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.24em;
  color:var(--muted);
}
.scene-title{
  font-size:18px;
  font-weight:900;
  letter-spacing:.1em;
  text-transform:uppercase;
}
.scene-tagline{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.16em;
  color:rgba(209,213,219,.9);
}

/* ========= Hero mini-hero inside Story scene ========= */
.mini-hero{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  margin:0 0 12px;
  padding:10px 14px;
  border-radius:18px;
  background:rgba(15,23,42,.9);
  border:1px solid rgba(55,65,81,.9);
}
.mh-left{
  display:flex;
  align-items:center;
  gap:10px;
}
.mh-logo{
  height:36px;
  width:auto;
  border-radius:10px;
  object-fit:contain;
}
.mh-eyebrow{
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:.2em;
  color:var(--muted);
}
.mh-title{
  font-size:15px;
  font-weight:800;
}
.mh-right{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.15em;
  color:var(--muted);
}

/* ========= League filter strip ========= */
.badges{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin:4px 0 10px;
}
.badge{
  background:rgba(15,23,42,.9);
  border-radius:999px;
  padding:5px 10px;
  display:flex;
  align-items:center;
  gap:6px;
  cursor:pointer;
  border:1px solid rgba(75,85,99,.8);
  font-size:11px;
  font-weight:700;
  letter-spacing:.14em;
  text-transform:uppercase;
  color:var(--muted);
  transition:
    background .16s ease,
    border-color .16s ease,
    transform .12s ease,
    color .16s ease;
}
.badge img{
  height:18px;
  width:auto;
  object-fit:contain;
}
.badge:hover{
  transform:translateY(-1px);
}
.badge.active{
  background:linear-gradient(135deg,#facc15,#fef9c3);
  border-color:#facc15;
  color:#111827;
}

/* ========= KPI rail ========= */
.rail{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  margin:4px 0 10px;
}
.kpi{
  border-radius:16px;
  padding:10px 12px 14px;
  background:radial-gradient(circle at 0% 0%, rgba(250,204,21,.16), transparent 55%),
             rgba(15,23,42,.95);
  border:1px solid rgba(55,65,81,.9);
}
.kpi .t{
  font-size:10px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:.18em;
}
.kpi .v{
  margin-top:6px;
  font-weight:900;
  font-size:22px;
  letter-spacing:.04em;
}

/* ========= Bars ========= */
.mini-two{
  display:grid;
  grid-template-columns:1.1fr 1fr;
  gap:10px;
  margin:2px 0 10px;
}
.bar-card-title{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.18em;
}
.note{color:var(--muted);font-size:12px}

.bar{
  height:11px;
  border-radius:999px;
  background:#020b2a;
  overflow:hidden;
  border:1px solid rgba(55,65,81,.9);
  display:flex;
}
.seg{height:100%}
.home{background:linear-gradient(90deg,#22c55e,#4ade80);}
.draw{background:linear-gradient(90deg,#9ca3af,#e5e7eb);}
.away{background:linear-gradient(90deg,#38bdf8,#0ea5e9);}

/* ========= Story scene grid ========= */
.story-grid{
  display:grid;
  grid-template-columns:1.2fr 1fr;
  gap:14px;
  margin-top:10px;
}

/* Activity blocks */
.activity-block{
  display:flex;
  flex-direction:column;
  gap:6px;
  font-size:13px;
}
.activity-row{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  align-items:center;
}
.activity-pill{
  border-radius:999px;
  border:1px solid var(--line);
  padding:3px 9px;
  font-size:11px;
  background:rgba(15,23,42,.95);
  color:#e5e7eb;
  font-weight:600;
}
.activity-pill.accent{
  border-color:var(--accent-line);
  background:linear-gradient(120deg, rgba(249,215,28,.3), rgba(253,224,71,.9));
  color:#111827;
}
.activity-note{font-size:11px;opacity:.9;}
.activity-empty{font-size:11px;color:var(--muted);}

/* Highlights */
#tbl-hi{
  width:100%;
  border-collapse:separate;
  border-spacing:0 6px;
  margin-top:4px;
}
#tbl-hi td{
  white-space:normal;
  line-height:1.35;
  padding:8px 10px;
  background:rgba(15,23,42,.95);
  border-radius:10px;
  border:1px solid rgba(55,65,81,.9);
}
.hi-label{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.18em;
  color:var(--muted);
  display:flex;
  align-items:center;
  gap:8px;
}
.hi-icon{
  width:24px;
  height:24px;
  border-radius:999px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:13px;
  background:radial-gradient(circle at 30% 0%, #fef9c3, #facc15);
}
.hi-value{
  font-weight:600;
  font-size:13px;
  text-align:right;
}

/* Latest Results */
.latest-shell{
  margin-top:10px;
  border-radius:14px;
  padding:8px 10px;
  background:rgba(15,23,42,.95);
  border:1px solid rgba(55,65,81,.9);
}
.latest-item{
  display:flex;
  align-items:center;
  gap:10px;
  padding:7px 0;
  border-bottom:1px solid rgba(31,41,55,.8);
}
.latest-item:last-child{border-bottom:none;}

.latest-meta{
  width:46px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  text-transform:uppercase;
  color:var(--muted);
}
.latest-date-day{
  font-size:14px;
  font-weight:800;
  line-height:1;
}
.latest-date-mon{
  font-size:10px;
  letter-spacing:.18em;
  margin-top:1px;
}

.latest-badge{
  height:24px;
  width:auto;
  flex:0 0 auto;
}
.latest-main{
  flex:1;
  display:grid;
  grid-template-columns:1.2fr auto auto;
  align-items:center;
  column-gap:10px;
}
.latest-teams{
  display:flex;
  flex-direction:column;
  gap:1px;
}
.latest-team{font-size:13px;}
.latest-scores{
  display:flex;
  flex-direction:column;
  gap:1px;
  text-align:right;
}
.latest-score-num{
  font-weight:800;
  font-size:15px;
}
.latest-league-wrapper{
  min-width:80px;
  display:flex;
  justify-content:flex-end;
}
.latest-league-pill{
  padding:2px 8px;
  border-radius:999px;
  font-size:10px;
  font-weight:800;
  text-transform:uppercase;
  letter-spacing:.16em;
  text-align:center;
  color:#111827;
  box-shadow:0 0 0 1px rgba(15,23,42,1);
}
.latest-league-pill.Diamond{background:var(--diamond);}
.latest-league-pill.Ruby{background:var(--ruby);}
.latest-league-pill.Sapphire{background:var(--sapphire);}
.latest-league-pill.Crystal{background:var(--crystal);}
.latest-league-pill.Emerald{background:var(--emerald);}
.latest-league-pill.Gold{background:var(--gold);}

/* ========= Leaderboard scene ========= */
table{
  width:100%;
  border-collapse:collapse;
}
thead th{
  background:rgba(15,23,42,.98);
  color:#e5e7eb;
  padding:8px 9px;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.16em;
  border-bottom:1px solid rgba(31,41,55,.9);
}
tbody td{
  padding:8px 9px;
  font-weight:600;
  font-size:13px;
  vertical-align:middle;
}
tbody tr:nth-child(odd){background:rgba(15,23,42,.97);}
tbody tr:nth-child(even){background:rgba(17,24,39,.97);}
tbody tr:hover{
  background:linear-gradient(90deg,rgba(17,24,39,1),rgba(30,64,175,.8));
}
.left{text-align:left}
.right{text-align:right}
.center{text-align:center}
.numeric{
  font-variant-numeric:tabular-nums;
  font-feature-settings:"tnum" 1;
}

/* Selected row highlight */
tr.row-selected{
  outline:2px solid var(--accent);
  outline-offset:-2px;
  position:relative;
  z-index:2;
}

/* Team cell */
.teamwrap{
  display:flex;
  align-items:center;
  gap:8px;
  min-width:0;
  padding-left:10px;
  position:relative;
  cursor:pointer;
}
.teamwrap::before{
  content:"";
  position:absolute;
  left:0;
  top:4px;
  bottom:4px;
  width:4px;
  border-radius:999px;
}
.teamwrap.Diamond::before{background:var(--diamond);}
.teamwrap.Ruby::before{background:var(--ruby);}
.teamwrap.Sapphire::before{background:var(--sapphire);}
.teamwrap.Crystal::before{background:var(--crystal);}
.teamwrap.Emerald::before{background:var(--emerald);}
.teamwrap.Gold::before{background:var(--gold);}
.lg{
  height:18px;
  width:auto;
}
.teamname{
  display:block;
  white-space:normal;
}

/* Table scene layout */
.table-layout{
  display:grid;
  grid-template-columns:1.4fr 1fr;
  gap:14px;
}

/* Player panel */
#player-panel{
  border-radius:18px;
  background:rgba(15,23,42,.97);
  border:1px solid rgba(55,65,81,.9);
}
.player-card{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.player-header{
  display:flex;
  align-items:center;
  gap:10px;
}
.player-badge{
  height:34px;
  border-radius:10px;
}
.player-name{
  font-size:16px;
  font-weight:900;
}
.player-league{
  font-size:12px;
  color:var(--muted);
}
.player-grid{
  display:grid;
  grid-template-columns:auto 1fr;
  column-gap:8px;
  row-gap:4px;
  font-size:12px;
}
.pg-label{
  color:var(--muted);
}
.pg-value{
  text-align:right;
  font-weight:600;
}
.pg-form{
  display:flex;
  justify-content:flex-end;
  gap:3px;
  flex-wrap:wrap;
}
.form-pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:20px;
  padding:1px 5px;
  border-radius:999px;
  font-size:10px;
  font-weight:700;
  border:1px solid rgba(75,85,99,.9);
  background:rgba(17,24,39,1);
}
.form-pill.win{
  border-color:#22c55e;
  background:linear-gradient(135deg,#16a34a,#4ade80);
  color:#f0fdf4;
}
.form-pill.draw{
  border-color:#9ca3af;
  background:linear-gradient(135deg,#9ca3af,#e5e7eb);
  color:#111827;
}
.form-pill.loss{
  border-color:#f97373;
  background:linear-gradient(135deg,#ef4444,#f97373);
  color:#fef2f2;
}

/* Player flyout */
.player-flyout{
  position:absolute;
  z-index:9999;
  background:rgba(15,23,42,.98);
  border:1px solid rgba(55,65,81,.9);
  border-radius:16px;
  padding:10px 12px;
  box-shadow:0 26px 60px rgba(0,0,0,.95);
  min-width:230px;
  max-width:280px;
  display:none;
}

/* ========= Power scene ========= */
.power-layout{
  display:grid;
  grid-template-columns:1.3fr 1fr;
  gap:14px;
}

/* Power table styles */
.power-title-main{
  font-size:15px;
  font-weight:800;
  text-transform:uppercase;
  letter-spacing:.16em;
}
.power-eyebrow{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.18em;
  color:var(--muted);
}
.power-note{
  font-size:11px;
  color:var(--muted);
  margin-top:4px;
}
.power-badge{
  border-radius:999px;
  border:1px solid rgba(249,215,28,.85);
  padding:3px 9px;
  font-size:10px;
  font-weight:700;
  background:linear-gradient(135deg,#fef9c3,#facc15);
  color:#111827;
  white-space:nowrap;
}
#tbl-power tbody tr.power-1 td{
  background:linear-gradient(135deg, rgba(249,215,28,.35), rgba(251,191,36,.25)) !important;
  color:#111827;
}
#tbl-power tbody tr.power-2-3 td{
  background:linear-gradient(135deg, rgba(249,215,28,.22), rgba(17,24,39,1)) !important;
}
.power-score-pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:3.5ch;
  padding:3px 8px;
  border-radius:999px;
  font-size:13px;
  font-weight:900;
  background:#020617;
  color:#facc15;
  border:1px solid rgba(234,179,8,1);
}

/* ========= Per-league scene ========= */
.league-mini-grid{
  display:grid;
  grid-template-columns:repeat(3,minmax(0,1fr));
  gap:10px;
  margin-top:6px;
}
.league-mini-card{
  background:rgba(15,23,42,.97);
  border-radius:14px;
  padding:8px 10px;
  border:1px solid rgba(55,65,81,.9);
  display:flex;
  align-items:center;
  gap:8px;
}
.league-strip{
  width:3px;
  align-self:stretch;
  border-radius:999px;
}
.league-mini-card.Diamond .league-strip{background:var(--diamond);}
.league-mini-card.Ruby .league-strip{background:var(--ruby);}
.league-mini-card.Sapphire .league-strip{background:var(--sapphire);}
.league-mini-card.Crystal .league-strip{background:var(--crystal);}
.league-mini-card.Emerald .league-strip{background:var(--emerald);}
.league-mini-card.Gold .league-strip{background:var(--gold);}
.league-mini-badge{
  height:26px;
  width:auto;
}
.league-mini-text-title{
  font-size:13px;
  font-weight:700;
}
.league-mini-text-sub{
  font-size:11px;
  color:var(--muted);
}

/* ========= Responsive ========= */
@media (max-width:980px){
  .rail{grid-template-columns:repeat(2,1fr);}
  .story-grid{grid-template-columns:1fr;}
  .table-layout{grid-template-columns:1fr;}
  .power-layout{grid-template-columns:1fr;}
  .league-mini-grid{grid-template-columns:repeat(2,1fr);}
}
@media (max-width:720px){
  .broadcast-header{
    flex-direction:column;
    align-items:flex-start;
  }
  .scene-card{
    padding:16px 14px 22px;
    border-radius:22px;
  }
}
@media (max-width:520px){
  .rail{grid-template-columns:1fr;}
  thead th{padding:7px;font-size:10px;}
  tbody td{padding:7px;font-size:12px;}
  #tbl-leader th:nth-child(5),
  #tbl-leader td:nth-child(5),
  #tbl-leader th:nth-child(6),
  #tbl-leader td:nth-child(6){
    display:none !important;
  }
  .league-mini-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>
  <div class="wrap">

    <!-- Broadcast header strip -->
    <header class="broadcast-header">
      <div class="broadcast-left">
        <img src="https://efpl-assets.pages.dev/img/logo.png" alt="eFPL logo" class="broadcast-logo">
        <div class="broadcast-title-block">
          <div class="broadcast-eyebrow">Season 2 ‚Ä¢ Live Studio</div>
          <div class="broadcast-title">eFPL Global Stats</div>
        </div>
      </div>
      <div class="broadcast-right">
        <div class="broadcast-live-pill">
          <span class="broadcast-live-dot"></span>
          <span>Live Data</span>
        </div>
        <div>60 players ‚Ä¢ 6 leagues</div>
      </div>
    </header>

    <!-- Segment bar -->
    <nav class="scene-tabs" id="scene-tabs">
      <div class="scene-tab active" data-scene="story">
        <span class="icon">üì∫</span><span>Story</span>
      </div>
      <div class="scene-tab" data-scene="table">
        <span class="icon">üìä</span><span>Table</span>
      </div>
      <div class="scene-tab" data-scene="power">
        <span class="icon">‚ö°</span><span>Power</span>
      </div>
      <div class="scene-tab" data-scene="leagues">
        <span class="icon">üèÜ</span><span>Leagues</span>
      </div>
    </nav>

    <!-- ========== SCENE: STORY ========== -->
    <section class="scene active" id="scene-story">
      <div class="scene-card">
        <div class="scene-body">
          <div class="scene-heading">
            <div class="scene-heading-main">
              <div class="scene-eyebrow">Matchday story</div>
              <div class="scene-title">Results & Season Flow</div>
            </div>
            <div class="scene-tagline">Live overview across all divisions</div>
          </div>

          <!-- Mini hero & badges -->
          <div class="mini-hero">
            <div class="mh-left">
              <img src="https://efpl-assets.pages.dev/img/logo.png" alt="eFPL logo" class="mh-logo">
              <div>
                <div class="mh-eyebrow">Filter by league</div>
                <div class="mh-title">All Leagues</div>
              </div>
            </div>
            <div class="mh-right">Tap a badge to focus a league</div>
          </div>

          <nav class="badges" id="badges"></nav>

          <!-- KPIs -->
          <section class="rail" aria-label="Key metrics">
            <div class="kpi"><div class="t">Matches</div><div class="v" id="kpi-matches">-</div></div>
            <div class="kpi"><div class="t">Goals</div><div class="v" id="kpi-goals">-</div></div>
            <div class="kpi"><div class="t">Avg / match</div><div class="v" id="kpi-avg">-</div></div>
            <div class="kpi"><div class="t">Leagues</div><div class="v" id="kpi-leagues">-</div></div>
          </section>

          <!-- Bars -->
          <div class="mini-two">
            <div>
              <div class="bar-card-title">
                <span>Result split</span>
                <span id="split-text" class="note">-</span>
              </div>
              <div class="bar" title="Home / Draw / Away">
                <span id="seg-home" class="seg home" style="width:0%"></span>
                <span id="seg-draw" class="seg draw" style="width:0%"></span>
                <span id="seg-away" class="seg away" style="width:0%"></span>
              </div>
            </div>
            <div>
              <div class="bar-card-title">
                <span>Completion</span>
                <span id="prog-text" class="note">-</span>
              </div>
              <div class="bar" title="Completed / Scheduled">
                <span id="seg-prog" class="seg" style="width:0%;background:linear-gradient(90deg,#ffd03b,#f9d71c)"></span>
              </div>
            </div>
          </div>

          <!-- Story grid: Weekly + Days / Highlights + Latest -->
          <div class="story-grid">
            <div>
              <h3>Weekly Games Played</h3>
              <div class="note" style="margin-bottom:4px">This week vs last week and the last 7 days.</div>
              <div id="season-activity" class="activity-block">
                <div class="activity-empty">Weekly stats will appear once some matches have been completed.</div>
              </div>

              <h3 style="margin-top:14px">Most Active Days</h3>
              <div class="note" style="margin-bottom:4px">Which days see the most completed fixtures.</div>
              <div id="matchday-trends" class="activity-block">
                <div class="activity-empty">Most Active Days will appear once some matches have been completed.</div>
              </div>
            </div>

            <div>
              <h3>Highlights</h3>
              <table id="tbl-hi">
                <tbody>
                  <tr class="hi-big">
                    <td class="left hi-label">
                      <span class="hi-icon">üèÜ</span>
                      <span>Biggest win</span>
                    </td>
                    <td id="hi-big" class="hi-value">-</td>
                  </tr>
                  <tr class="hi-hsg">
                    <td class="left hi-label">
                      <span class="hi-icon">üî•</span>
                      <span>Highest scoring game</span>
                    </td>
                    <td id="hi-hsg" class="hi-value">-</td>
                  </tr>
                  <tr class="hi-topgf">
                    <td class="left hi-label">
                      <span class="hi-icon">üéØ</span>
                      <span>Top scoring team</span>
                    </td>
                    <td id="hi-topgf" class="hi-value">-</td>
                  </tr>
                  <tr class="hi-mostga">
                    <td class="left hi-label">
                      <span class="hi-icon">üö®</span>
                      <span>Most conceded</span>
                    </td>
                    <td id="hi-mostga" class="hi-value">-</td>
                  </tr>
                  <tr class="hi-mostcs">
                    <td class="left hi-label">
                      <span class="hi-icon">üß±</span>
                      <span>Most clean sheets</span>
                    </td>
                    <td id="hi-mostcs" class="hi-value">-</td>
                  </tr>
                </tbody>
              </table>

              <h3 style="margin-top:12px">Latest Results</h3>
              <div id="latest-results" class="latest-shell">
                <div class="note">Loading latest results‚Ä¶</div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- ========== SCENE: TABLE ========== -->
    <section class="scene" id="scene-table">
      <div class="scene-card">
        <div class="scene-body">
          <div class="scene-heading">
            <div class="scene-heading-main">
              <div class="scene-eyebrow">League table & spotlight</div>
              <div class="scene-title">Overall leaderboard</div>
            </div>
            <div class="scene-tagline">Tap a team to highlight their season</div>
          </div>

          <div class="table-layout">
            <div>
              <h3>Leaderboard</h3>
              <table id="tbl-leader">
                <colgroup>
                  <col class="c-rank"><col class="c-team">
                  <col class="c-p"><col class="c-w"><col class="c-d"><col class="c-l">
                  <col class="c-gd"><col class="c-pts">
                </colgroup>
                <thead><tr>
                  <th>#</th><th class="left">Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th>
                </tr></thead>
                <tbody></tbody>
              </table>
            </div>

            <aside id="player-panel">
              <strong style="display:block;margin-bottom:6px;font-size:12px;text-transform:uppercase;letter-spacing:.18em;">Player spotlight</strong>
              <div id="player-panel-content" class="note">
                Tap or hover a team name in the leaderboard to view their profile here.
              </div>
            </aside>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== SCENE: POWER ========== -->
    <section class="scene" id="scene-power">
      <div class="scene-card">
        <div class="scene-body">
          <div class="scene-heading">
            <div class="scene-heading-main">
              <div class="scene-eyebrow">Form, momentum & dominance</div>
              <div class="scene-title">Power index & records</div>
            </div>
            <div class="scene-tagline">Who‚Äôs in form, who scores, who shuts teams out</div>
          </div>

          <div class="power-layout">
            <div>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                <div>
                  <div class="power-eyebrow">Season 2 ‚Ä¢ Live Power Index</div>
                  <div class="power-title-main">Power Rankings (Top 10)</div>
                </div>
                <span class="power-badge">Min. 5 games ‚Ä¢ (Pts √ó 2 + GD) √∑ GP</span>
              </div>

              <table id="tbl-power">
                <thead>
                  <tr>
                    <th>#</th>
                    <th class="left">Team</th>
                    <th>LG</th>
                    <th>Power</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <div class="power-note">
                Power Score rewards form, goal difference and consistency across all leagues.
              </div>
            </div>

            <div>
              <h3>Best offence (Top 10)</h3>
              <table id="tbl-gf" style="margin-top:4px">
                <thead>
                  <tr>
                    <th>#</th>
                    <th class="left">Team</th>
                    <th>GF</th>
                    <th>P</th>
                    <th>GF / game</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>

              <h3 style="margin-top:12px">Best defence (Top 10)</h3>
              <table id="tbl-ga" style="margin-top:4px">
                <thead>
                  <tr>
                    <th>#</th>
                    <th class="left">Team</th>
                    <th>GA</th>
                    <th>P</th>
                    <th>GA / game</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- ========== SCENE: LEAGUES ========== -->
    <section class="scene" id="scene-leagues">
      <div class="scene-card">
        <div class="scene-body">
          <div class="scene-heading">
            <div class="scene-heading-main">
              <div class="scene-eyebrow">Across every division</div>
              <div class="scene-title">Per-league comparison</div>
            </div>
            <div class="scene-tagline">Average goals, result split & completion</div>
          </div>

          <div class="league-mini-grid" id="league-mini"></div>
          <div class="note" style="margin-top:6px">
            Each card: Avg goals ‚Ä¢ Home / Draw / Away % ‚Ä¢ Completion %.
          </div>
        </div>
      </div>
    </section>

  </div>

<script>
/* ===== SCENE SWITCHING (presentation, not data) ===== */
(function(){
  const tabs = document.querySelectorAll('.scene-tab');
  const scenes = {
    story: document.getElementById('scene-story'),
    table: document.getElementById('scene-table'),
    power: document.getElementById('scene-power'),
    leagues: document.getElementById('scene-leagues'),
  };

  tabs.forEach(tab=>{
    tab.addEventListener('click', ()=>{
      const key = tab.dataset.scene;
      tabs.forEach(t=>t.classList.toggle('active', t === tab));
      Object.entries(scenes).forEach(([k,el])=>{
        if(!el) return;
        el.classList.toggle('active', k === key);
      });
    });
  });
})();

/* ===== ORIGINAL DATA / RENDER LOGIC (unchanged) ===== */
const LEAGUES = [
  { key:'All',      name:'All Leagues', badge:null, id:null },
  { key:'Diamond',  name:'Diamond',  badge:'Diamond-League.png',  id:'1vkDOFfwBJJnSHOPM0BFcrNyZd-2nIbiDKNnWGKT3OP0' },
  { key:'Ruby',     name:'Ruby',     badge:'Ruby-League.png',     id:'12Qg5yi3yQtsPSrd6EHxROkPNurVn5ylzELPvU4UOmGU' },
  { key:'Sapphire', name:'Sapphire', badge:'Sapphire-League.png', id:'1qa03hOquzVg8ithFLdhrel2O3k3nTQCQZp81AWFvECg' },
  { key:'Crystal',  name:'Crystal',  badge:'Crystal-League.png',  id:'1LqRM7ICWpENmsKH5tTuu7Bf7VQa7YoJ-9TAivruymvo' },
  { key:'Emerald',  name:'Emerald',  badge:'Emerald-League.png',  id:'1rD_03y276wGjjlukus6icgwq_FPcOgc70654dOOG6sg' },
  { key:'Gold',     name:'Gold',     badge:'Gold-League.png',     id:'1ACOQ3dffrjczk1LmBmPiC-wV37t9nQKEDwApOEEeFU8' },
];
const BADGE_BASE = 'https://efpl-assets.pages.dev/img/leagues/';

const FX_TAB = 'Fixtures', FX_RANGE='C4:I94';
const EM_TAB = 'Embed',    EM_RANGE='A15:C105';
const ST_TAB = 'Embed',    ST_RANGE='A1:K50';

const BUCKET_MS = 5*60*1000;
const CB = Math.floor(Date.now()/BUCKET_MS);

let TEAM_INDEX = new Map();
let FORM_INDEX = new Map();
let CURRENT_TEAM = null;

function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function parseGviz(txt){const a=txt.indexOf('{'),b=txt.lastIndexOf('}');if(a===-1||b===-1)throw new Error('Bad GViz');return JSON.parse(txt.slice(a,b+1))}
function num(x){const n=Number(x);return Number.isFinite(n)?n:null}
function truthy(v){return v===true || String(v).toLowerCase()==='true' || v==='‚òë'}
function pct(p,t){return t?((p*100/t).toFixed(1)+'%'):'0.0%'}
function fmt(n){return Number.isFinite(n)?n.toLocaleString():'0'}
function byId(id){return document.getElementById(id)}
function normTeamName(s){return String(s||'').toLowerCase().replace(/\*/g,'').trim();}

function safeDate(v){
  if(!v && v!==0) return null;
  if(typeof v === 'object'){
    if(v.v !== undefined) return safeDate(v.v);
    if(v.f){
      const d = new Date(v.f);
      if(!isNaN(d.getTime())) return d;
    }
  }
  if(typeof v === 'number'){
    const base = new Date(Date.UTC(1899,11,30));
    const d = new Date(base.getTime() + v*86400000);
    return isNaN(d.getTime()) ? null : d;
  }
  if(typeof v === 'string'){
    const s = v.trim();
    if(!s) return null;
    if(/^Date\(/i.test(s)){
      const nums = s.replace(/[^\d,]/g,'').split(',').map(n=>parseInt(n,10));
      if(nums.length>=3){
        const d = new Date(nums[0], nums[1], nums[2]);
        if(!isNaN(d.getTime())) return d;
      }
    }
    let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
    if(m){
      let day = parseInt(m[1],10), month = parseInt(m[2],10)-1, year = parseInt(m[3],10);
      if(year < 100) year += 2000;
      const d = new Date(year,month,day);
      if(!isNaN(d.getTime())) return d;
    }
    m = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
    if(m){
      const d = new Date(parseInt(m[1],10), parseInt(m[2],10)-1, parseInt(m[3],10));
      if(!isNaN(d.getTime())) return d;
    }
    const d = new Date(s);
    if(!isNaN(d.getTime())) return d;
  }
  return null;
}

function formatLatestDateParts(m){
  if(m.doneOn instanceof Date){
    const d = m.doneOn;
    const day = d.getDate();
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return { day:String(day), mon:months[d.getMonth()] };
  }
  return { day:'', mon:'' };
}

async function fetchRange(id, sheet, range){
  const url=`https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}&range=${encodeURIComponent(range)}&cachebust=${CB}`;
  const res=await fetch(url); const txt=await res.text();
  if(!res.ok) throw new Error(res.status+' '+txt.slice(0,160));
  return parseGviz(txt);
}

async function loadFromFixtures(id){
  const data=await fetchRange(id, FX_TAB, FX_RANGE);
  const rows=(data.table.rows||[]).map(r=>(r.c||[]).map(c=>c ? (c.f ?? c.v ?? '') : ''));
  let scheduled=0;
  const items=rows.map(c=>{
    const home=c[0]??'', hg=num(c[1]), ag=num(c[3]), away=c[4]??'';
    const completed=truthy(c[5]);
    const doneOn = safeDate(c[6]);
    if(home&&away) scheduled++;
    return {home,away,hg,ag,completed,doneOn};
  });
  return {items, scheduled};
}

async function loadFromEmbed(id){
  const data=await fetchRange(id, EM_TAB, EM_RANGE);
  const rows=(data.table.rows||[]).map(r=>(r.c||[]).map(c=>c?c.v:'')).filter(r=>r && !r.every(x=>String(x).trim()===''));
  const scheduled=rows.filter(r=>(r[0]||'').trim()&&(r[2]||'').trim()).length;
  const items=rows.map(r=>{
    const mid=r[1]??'', clean=String(mid).replace(/[^0-9\-]/g,'').trim();
    const m=clean.match(/^(\d+)\s*-\s*(\d+)$/);
    return {home:r[0]??'',away:r[2]??'',hg:m?Number(m[1]):null,ag:m?Number(m[2]):null,completed:!!m,doneOn:null};
  });
  return {items, scheduled};
}

async function loadForms(id){
  const data = await fetchRange(id, ST_TAB, ST_RANGE);
  const cols = data.table.cols || [];
  theaders = cols.map(c=>c.label || '');
  const lower = theaders.map(h=>h.toLowerCase().trim());

  const iForm = lower.findIndex(h=>h.includes('form'));
  const iTeam = lower.findIndex(h=>h.includes('team'));
  if(iForm === -1 || iTeam === -1) return new Map();

  const rows=(data.table.rows||[]).map(r=>(r.c||[]).map(c=>c ? (c.f ?? c.v ?? '') : ''));
  const map = new Map();

  rows.forEach(r=>{
    if(!r || r.every(x=>String(x).trim()==='')) return;
    const rawTeam = r[iTeam] ?? '';
    const rawForm = r[iForm] ?? '';
    const norm = normTeamName(rawTeam);
    if(norm && String(rawForm).trim()){
      map.set(norm, String(rawForm));
    }
  });
  return map;
}

async function loadLeagueBundle(lg){
  const bucket = {matches:[], scheduled:0};
  let leagueMatches = [];
  let scheduledTotal = 0;
  let formMap = new Map();

  const [formResult, fixturesResult] = await Promise.all([
    loadForms(lg.id).catch(()=>new Map()),
    loadFromFixtures(lg.id).catch(()=>null)
  ]);

  if(formResult instanceof Map) formMap = formResult;

  if(fixturesResult && Array.isArray(fixturesResult.items)){
    scheduledTotal += fixturesResult.scheduled;
    bucket.scheduled += fixturesResult.scheduled;
    fixturesResult.items.forEach(r=>{
      if(r.completed && Number.isFinite(r.hg) && Number.isFinite(r.ag)){
        const m = {
          league:lg.key,
          home:r.home,
          away:r.away,
          hg:r.hg,
          ag:r.ag,
          doneOn:r.doneOn
        };
        bucket.matches.push(m);
        leagueMatches.push(m);
      }
    });
  }

  if(bucket.matches.length === 0){
    try{
      const {items, scheduled} = await loadFromEmbed(lg.id);
      scheduledTotal += scheduled;
      bucket.scheduled += scheduled;
      items.forEach(r=>{
        if(r.completed && Number.isFinite(r.hg) && Number.isFinite(r.ag)){
          const m = {
            league:lg.key,
            home:r.home,
            away:r.away,
            hg:r.hg,
            ag:r.ag,
            doneOn:null
          };
          bucket.matches.push(m);
          leagueMatches.push(m);
        }
      });
    }catch(e){}
  }

  return { key: lg.key, bucket, matches: leagueMatches, scheduledTotal, formMap };
}

function aggregate(matches){
  const played=matches.length;
  const goals=matches.reduce((s,m)=>s+m.hg+m.ag,0);
  const avg=played?goals/played:0;

  let homeW=0,draw=0,awayW=0;
  let biggest=null, highest=null;

  const teams=new Map();
  function add(name){
    if(!teams.has(name)){
      teams.set(name,{
        team:name,league:null,
        gp:0,w:0,d:0,l:0,gf:0,ga:0,gd:0,pts:0,cs:0,
        results:[]
      });
    }
    return teams.get(name);
  }

  matches.forEach(m=>{
    if(m.hg>m.ag) homeW++; else if(m.hg<m.ag) awayW++; else draw++;

    const diff=Math.abs(m.hg-m.ag);
    if(!biggest || diff>biggest.diff){
      const text = m.hg>=m.ag ? `${m.home} ${m.hg}-${m.ag} ${m.away}` : `${m.away} ${m.ag}-${m.hg} ${m.home}`;
      biggest={diff,text,sub:`${m.league}`};
    }
    const total=m.hg+m.ag;
    if(!highest || total>highest.total){
      highest={total,text:`${m.home} ${m.hg}-${m.ag} ${m.away}`,sub:`${m.league}`};
    }

    const H=add(m.home), A=add(m.away);
    if(!H.league) H.league = m.league;
    if(!A.league) A.league = m.league;

    H.gp++; A.gp++;
    H.gf+=m.hg; H.ga+=m.ag;
    A.gf+=m.ag; A.ga+=m.hg;

    let hRes='D', aRes='D';
    if(m.hg>m.ag){
      H.w++; H.pts+=3; A.l++;
      hRes='W'; aRes='L';
    } else if(m.hg<m.ag){
      A.w++; A.pts+=3; H.l++;
      hRes='L'; aRes='W';
    } else {
      H.d++; A.d++; H.pts++; A.pts++;
      hRes='D'; aRes='D';
    }
    if(m.ag===0) H.cs++; if(m.hg===0) A.cs++;

    H.results.push(hRes);
    A.results.push(aRes);
  });

  const list=Array.from(teams.values()).map(t=>({...t,gd:t.gf-t.ga}));
  const topGF = [...list].sort((a,b)=> b.gf-a.gf || a.team.localeCompare(b.team))[0] || null;
  const mostGA = [...list].sort((a,b)=> b.ga-a.ga || a.team.localeCompare(b.team))[0] || null;
  const mostCS = [...list].sort((a,b)=> b.cs-a.cs || a.team.localeCompare(b.team))[0] || null;

  return {played,goals,avg,homeW,draw,awayW,teams:list,biggest,highest,topGF,mostGA,mostCS};
}

function leagueAggregates(perLeague){
  const out=[];
  for(const key of Object.keys(perLeague)){
    const bucket=perLeague[key];
    const ms=bucket.matches, scheduled=bucket.scheduled;
    const played=ms.length;
    const goals=ms.reduce((s,m)=>s+m.hg+m.ag,0);
    const avg=played?goals/played:0;
    const homeW=ms.filter(m=>m.hg>m.ag).length;
    const draw =ms.filter(m=>m.hg===m.ag).length;
    const awayW=ms.filter(m=>m.hg<m.ag).length;
    out.push({league:key,played,scheduled,avg,homeW,draw,awayW});
  }
  return out.sort((a,b)=>a.league.localeCompare(b.league));
}

function buildActivityStats(matches){
  const dated = (matches || []).filter(m => m.doneOn instanceof Date);
  if(!dated.length){
    return {
      activityHtml:
        '<div class="activity-block"><div class="activity-empty">Weekly stats will appear once some matches have been completed.</div></div>',
      trendHtml:
        '<div class="activity-block"><div class="activity-empty">Most Active Days will appear once some matches have been completed.</div></div>'
    };
  }

  dated.sort((a,b)=>a.doneOn - b.doneOn);

  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const day = today.getDay();
  const offsetToMonday = (day + 6) % 7;
  const startThisWeek = new Date(today.getTime() - offsetToMonday*86400000);
  const endThisWeek   = new Date(startThisWeek.getTime() + 7*86400000);
  const startLastWeek = new Date(startThisWeek.getTime() - 7*86400000);
  const last7Start    = new Date(today.getTime() - 7*86400000);

  let thisWeek = 0, lastWeek = 0, last7 = 0;
  const dowCounts = {0:0,1:0,2:0,3:0,4:0,5:0,6:0};

  dated.forEach(m=>{
    const d = m.doneOn;
    const dayOnly = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const t = dayOnly.getTime();

    if(t >= startThisWeek.getTime() && t < endThisWeek.getTime()){
      thisWeek++;
    }else if(t >= startLastWeek.getTime() && t < startThisWeek.getTime()){
      lastWeek++;
    }

    if(t >= last7Start.getTime() && t <= today.getTime()){
      last7++;
    }

    const dow = dayOnly.getDay();
    dowCounts[dow] = (dowCounts[dow] || 0) + 1;
  });

  const diff = thisWeek - lastWeek;
  let changeLabel;
  if(lastWeek === 0){
    if(thisWeek === 0){
      changeLabel = 'No change (no games last week)';
    }else{
      changeLabel = fmt(thisWeek) + ' more than last week';
    }
  }else{
    const word = Math.abs(diff) === 1 ? 'match' : 'matches';
    const sign = diff > 0 ? '+' : '';
    changeLabel = sign + diff + ' ' + word + ' vs last week';
  }

  const thisLabel  = fmt(thisWeek) + ' ' + (thisWeek===1 ? 'match' : 'matches') + ' this week';
  const lastLabel  = fmt(lastWeek) + ' ' + (lastWeek===1 ? 'match' : 'matches') + ' last week';
  const last7Label = 'Last 7 days: ' + fmt(last7) + ' ' + (last7===1 ? 'match' : 'matches') + ' played.';

  const activityHtml =
    '<div class="activity-block">' +
      '<div class="activity-row">' +
        '<span class="activity-pill accent">' + thisLabel + '</span>' +
        '<span class="activity-pill">' + lastLabel + '</span>' +
        '<span class="activity-pill">' + changeLabel + '</span>' +
      '</div>' +
      '<div class="activity-note">' + last7Label + '</div>' +
    '</div>';

  const dayNames=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const entries = Object.keys(dowCounts)
    .map(k=>({dayIndex:Number(k), count:dowCounts[k]}))
    .filter(x=>x.count>0)
    .sort((a,b)=>b.count-a.count);

  let trendHtml;
  if(!entries.length){
    trendHtml =
      '<div class="activity-block"><div class="activity-empty">Most Active Days will appear once some matches have been completed.</div></div>';
  }else{
    const total = entries.reduce((s,x)=>s+x.count,0);
    const top = entries[0];
    const topPct = ((top.count*100)/total).toFixed(1);

    if(entries.length>1){
      const next = entries[1];
      const nextPct = ((next.count*100)/total).toFixed(1);
      trendHtml =
        '<div class="activity-block">' +
          '<div class="activity-row">' +
            '<span class="activity-pill accent">Top day: ' + dayNames[top.dayIndex] + '</span>' +
            '<span class="activity-pill">' + topPct + '% of completed games</span>' +
            '<span class="activity-pill">Next: ' + dayNames[next.dayIndex] + ' (' + nextPct + '%)</span>' +
          '</div>' +
          '<div class="activity-note">Based on ' + fmt(total) + ' completed matches so far.</div>' +
        '</div>';
    }else{
      trendHtml =
        '<div class="activity-block">' +
          '<div class="activity-row">' +
            '<span class="activity-pill accent">Top day: ' + dayNames[top.dayIndex] + '</span>' +
            '<span class="activity-pill">' + topPct + '% of completed games</span>' +
          '</div>' +
          '<div class="activity-note">Based on ' + fmt(total) + ' completed matches so far.</div>' +
        '</div>';
    }
  }

  return {activityHtml, trendHtml};
}

function renderBadges(){
  const host=byId('badges'); host.innerHTML='';
  const all=document.createElement('div');
  all.className='badge active'; all.dataset.key='All';
  all.innerHTML=`<img src="https://efpl-assets.pages.dev/img/logo.png" alt="All"><span>All</span>`;
  all.onclick=()=>selectLeague('All');
  host.appendChild(all);
  LEAGUES.filter(x=>x.id).forEach(lg=>{
    const div=document.createElement('div');
    div.className='badge'; div.dataset.key=lg.key;
    div.innerHTML=`<img src="${BADGE_BASE}${lg.badge}" alt="${esc(lg.key)}"><span>${esc(lg.key)}</span>`;
    div.onclick=()=>selectLeague(lg.key);
    host.appendChild(div);
  });
}
function selectLeague(key){
  [...document.querySelectorAll('.badge')].forEach(b=>b.classList.toggle('active', b.dataset.key===key));
  CURRENT_TEAM = null;
  run([key]);
}

function teamCell(t){
  const lg = t.league || 'Diamond';
  return `<span class="teamwrap ${esc(lg)}" data-team="${esc(t.team)}">
    <img class="lg ${esc(lg)}" src="${BADGE_BASE}${lg}-League.png" alt="${esc(lg)}">
    <span class="teamname">${esc(t.team)}</span>
  </span>`;
}

function renderRails(agg, leagues, scheduledTotal){
  byId('kpi-matches').textContent = fmt(agg.played);
  byId('kpi-goals').textContent = fmt(agg.goals);
  byId('kpi-avg').textContent = agg.avg.toFixed(2);
  byId('kpi-leagues').textContent = leagues.length;
  byId('split-text').textContent =
    `${fmt(agg.homeW)} H ‚Ä¢ ${fmt(agg.draw)} D ‚Ä¢ ${fmt(agg.awayW)} A `
    + `‚Ä¢ ${pct(agg.homeW,agg.played)} / ${pct(agg.draw,agg.played)} / ${pct(agg.awayW,agg.played)}`;
  byId('seg-home').style.width = (agg.played?agg.homeW*100/agg.played:0) + '%';
  byId('seg-draw').style.width = (agg.played?agg.draw*100/agg.played:0) + '%';
  byId('seg-away').style.width = (agg.played?agg.awayW*100/agg.played:0) + '%';
  byId('prog-text').textContent = scheduledTotal
    ? `${fmt(agg.played)} / ${fmt(scheduledTotal)} ‚Ä¢ ${pct(agg.played,scheduledTotal)}`
    : '0 / 0 ‚Ä¢ 0.0%';
  byId('seg-prog').style.width = scheduledTotal ? (agg.played*100/scheduledTotal)+'%' : '0%';
}

function renderLeaderboard(teams){
  const tbody = byId('tbl-leader').querySelector('tbody'); tbody.innerHTML='';
  const rows=[...teams].sort((a,b)=> b.pts-a.pts || (b.gd-a.gd) || (b.gf-a.gf) || a.team.localeCompare(b.team));
  rows.forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.dataset.team = t.team;
    if(CURRENT_TEAM && t.team === CURRENT_TEAM) tr.classList.add('row-selected');
    tr.innerHTML = `
      <td class="right numeric">${i+1}</td>
      <td class="left">${teamCell(t)}</td>
      <td class="right numeric">${t.gp}</td>
      <td class="right numeric">${t.w}</td>
      <td class="right numeric">${t.d}</td>
      <td class="right numeric">${t.l}</td>
      <td class="right numeric">${t.gd}</td>
      <td class="right numeric"><strong>${t.pts}</strong></td>`;
    tbody.appendChild(tr);
  });
}

function renderHighlights(agg){
  byId('hi-big').textContent = agg.biggest ? `${agg.biggest.text} (${agg.biggest.sub})` : '-';
  byId('hi-hsg').textContent = agg.highest ? `${agg.highest.text} (${agg.highest.total} goals ‚Ä¢ ${agg.highest.sub})` : '-';
  byId('hi-topgf').textContent = agg.topGF ? `${agg.topGF.team} - ${agg.topGF.gf}` : '-';
  byId('hi-mostga').textContent = agg.mostGA ? `${agg.mostGA.team} - ${agg.mostGA.ga}` : '-';
  byId('hi-mostcs').textContent = agg.mostCS ? `${agg.mostCS.team} - ${agg.mostCS.cs}` : '-';
}

function renderPower(teams){
  const tbody = byId('tbl-power').querySelector('tbody');
  if(!tbody) return;
  tbody.innerHTML = '';

  const rows = [...teams]
    .filter(t => t.gp >= 5)
    .map(t => ({
      ...t,
      league: t.league || '',
      power: (t.gp > 0) ? ((t.pts * 2 + t.gd) / t.gp) : 0
    }))
    .sort((a,b)=>
      b.power - a.power ||
      b.pts - a.pts ||
      b.gd  - a.gd  ||
      b.gf  - a.gf  ||
      a.team.localeCompare(b.team)
    )
    .slice(0,10);

  rows.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.dataset.team = t.team;

    if(i === 0) tr.classList.add('power-1');
    else if(i === 1 || i === 2) tr.classList.add('power-2-3');

    if(CURRENT_TEAM && t.team === CURRENT_TEAM) tr.classList.add('row-selected');

    tr.innerHTML = `
      <td class="right numeric">${i+1}</td>
      <td class="left">${teamCell(t)}</td>
      <td class="center">${esc(t.league || '')}</td>
      <td class="right numeric">
        <span class="power-score-pill">${t.power.toFixed(2)}</span>
      </td>`;
    tbody.appendChild(tr);
  });

  if(rows.length === 0){
    tbody.innerHTML = `<tr><td colspan="4" class="center note">Power Rankings will appear once at least 5 games have been played.</td></tr>`;
  }
}

function renderTopTables(teams){
  const gfRows = [...teams]
    .filter(t => t.gp > 0)
    .map(t => ({...t,gfPerGame:t.gf/t.gp}))
    .sort((a,b)=>
      b.gfPerGame - a.gfPerGame ||
      b.gf - a.gf ||
      b.pts - a.pts ||
      a.team.localeCompare(b.team)
    )
    .slice(0,10);

  const gfBody = byId('tbl-gf').querySelector('tbody');
  gfBody.innerHTML = '';
  gfRows.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.dataset.team = t.team;
    if (CURRENT_TEAM && t.team === CURRENT_TEAM) tr.classList.add('row-selected');
    tr.innerHTML = `
      <td class="right numeric">${i+1}</td>
      <td class="left">${teamCell(t)}</td>
      <td class="right numeric">${t.gf}</td>
      <td class="right numeric">${t.gp}</td>
      <td class="right numeric">${t.gfPerGame.toFixed(2)}</td>`;
    gfBody.appendChild(tr);
  });

  const gaRows = [...teams]
    .filter(t => t.gp > 0)
    .map(t => ({...t,gaPerGame:t.ga/t.gp}))
    .sort((a,b)=>
      a.gaPerGame - b.gaPerGame ||
      a.ga - b.ga ||
      b.pts - a.pts ||
      a.team.localeCompare(b.team)
    )
    .slice(0,10);

  const gaBody = byId('tbl-ga').querySelector('tbody');
  gaBody.innerHTML = '';
  gaRows.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.dataset.team = t.team;
    if (CURRENT_TEAM && t.team === CURRENT_TEAM) tr.classList.add('row-selected');
    tr.innerHTML = `
      <td class="right numeric">${i+1}</td>
      <td class="left">${teamCell(t)}</td>
      <td class="right numeric">${t.ga}</td>
      <td class="right numeric">${t.gp}</td>
      <td class="right numeric">${t.gaPerGame.toFixed(2)}</td>`;
    gaBody.appendChild(tr);
  });
}

function renderMini(minis){
  const host=byId('league-mini'); if(!host) return;
  host.innerHTML='';
  minis.forEach(m=>{
    if(m.league === 'All') return;
    const line = `${m.played?m.avg.toFixed(2):'0.00'} avg ‚Ä¢ ${pct(m.homeW,m.played)} / ${pct(m.draw,m.played)} / ${pct(m.awayW,m.played)} ‚Ä¢ ${pct(m.played,m.scheduled||0)}`;
    const div=document.createElement('div');
    div.className='league-mini-card '+esc(m.league);
    div.innerHTML = `
      <div class="league-strip"></div>
      <img class="league-mini-badge" src="${BADGE_BASE}${m.league}-League.png" alt="${esc(m.league)}">
      <div>
        <div class="league-mini-text-title">${esc(m.league)}</div>
        <div class="league-mini-text-sub">${line}</div>
      </div>`;
    host.appendChild(div);
  });
}

function buildFormHtmlFromRaw(raw){
  const cleaned = String(raw ?? '')
    .replace(/[,\s\-_/|.]+/g,'')
    .toUpperCase()
    .replace(/[^WDL]/g,'');
  if(!cleaned) return '';
  const seq = [...cleaned].slice(-5);
  if(!seq.length) return '';
  return seq.map(ch=>{
    let cls='form-pill';
    if(ch==='W') cls+=' win';
    else if(ch==='D') cls+=' draw';
    else cls+=' loss';
    return `<span class="${cls}">${esc(ch)}</span>`;
  }).join('');
}

function buildPlayerProfileHtml(team){
  const league = team.league || '';
  const badgeUrl = `${BADGE_BASE}${league || 'Diamond'}-League.png`;
  const gdText = (team.gd>=0?'+':'') + team.gd;

  const norm = normTeamName(team.team);
  let formHtml = buildFormHtmlFromRaw(FORM_INDEX.get(norm));

  if(!formHtml){
    const results = Array.isArray(team.results) ? team.results : [];
    const lastFive = results.slice(-5);
    if(lastFive.length){
      formHtml = lastFive.map(res=>{
        let cls='form-pill';
        if(res==='W') cls+=' win';
        else if(res==='D') cls+=' draw';
        else cls+=' loss';
        return `<span class="${cls}">${esc(res)}</span>`;
      }).join('');
    }else{
      formHtml = '<span class="note">No matches yet</span>';
    }
  }

  return `
    <div class="player-card">
      <div class="player-header">
        <img src="${badgeUrl}" alt="${esc(league || 'League')}" class="player-badge">
        <div>
          <div class="player-name">${esc(team.team)}</div>
          <div class="player-league">${league ? esc(league)+' League' : 'eFPL player'}</div>
        </div>
      </div>
      <div class="player-grid">
        <div class="pg-label">Matches</div>
        <div class="pg-value">${team.gp}</div>

        <div class="pg-label">Points</div>
        <div class="pg-value">${team.pts}</div>

        <div class="pg-label">Record</div>
        <div class="pg-value">${team.w}-${team.d}-${team.l}</div>

        <div class="pg-label">Goals</div>
        <div class="pg-value">${team.gf} / ${team.ga} (${gdText})</div>

        <div class="pg-label">Form (last 5)</div>
        <div class="pg-value pg-form">${formHtml}</div>
      </div>
    </div>
  `;
}

function renderSelectedPlayer(teamName){
  const team = TEAM_INDEX.get(teamName);
  const panel = byId('player-panel-content');
  if(!panel || !team) return;
  panel.innerHTML = buildPlayerProfileHtml(team);
}

function applySelectionHighlight(){
  document.querySelectorAll('tr.row-selected').forEach(tr=>tr.classList.remove('row-selected'));
  if(!CURRENT_TEAM) return;
  document.querySelectorAll('tr[data-team]').forEach(tr=>{
    if(tr.dataset.team === CURRENT_TEAM){
      tr.classList.add('row-selected');
    }
  });
}

/* Player flyout */
let playerFlyout = null;
function ensureFlyout(){
  if(playerFlyout) return playerFlyout;
  playerFlyout = document.createElement('div');
  playerFlyout.className = 'player-flyout';
  document.body.appendChild(playerFlyout);
  return playerFlyout;
}
function showFlyoutFor(teamName, anchorEl){
  const team = TEAM_INDEX.get(teamName);
  if(!team) return;
  const fly = ensureFlyout();
  fly.innerHTML = buildPlayerProfileHtml(team);
  fly.style.display = 'block';

  const rect = anchorEl.getBoundingClientRect();
  const viewportWidth = document.documentElement.clientWidth;
  const scrollY = window.scrollY || document.documentElement.scrollTop || 0;

  const width = fly.offsetWidth || 260;
  let top = rect.top + scrollY - 4;
  let left = rect.right + 8;
  const maxLeft = viewportWidth - width - 8;
  if(left > maxLeft) left = Math.max(8, rect.left - width - 8);

  fly.style.top = `${top}px`;
  fly.style.left = `${left}px`;
}
function hideFlyout(){
  if(playerFlyout) playerFlyout.style.display = 'none';
}

/* Click + hover for team profile */
document.addEventListener('click', (e)=>{
  const wrap = e.target.closest('.teamwrap');
  if(wrap && wrap.dataset.team){
    CURRENT_TEAM = wrap.dataset.team;
    renderSelectedPlayer(CURRENT_TEAM);
    applySelectionHighlight();
  }
});

const supportsHover = window.matchMedia && window.matchMedia('(hover:hover)').matches;
if(supportsHover){
  let hoverTimeout = null;
  document.addEventListener('mouseover', (e)=>{
    const wrap = e.target.closest('.teamwrap');
    if(!wrap || !wrap.dataset.team) return;
    const teamName = wrap.dataset.team;
    clearTimeout(hoverTimeout);
    showFlyoutFor(teamName, wrap);
  });
  document.addEventListener('mouseout', (e)=>{
    const to = e.relatedTarget;
    if(to && to.closest && to.closest('.player-flyout')) return;
    hoverTimeout = setTimeout(hideFlyout, 80);
  });
}

/* Latest Results */
function renderLatestResults(matches){
  const host = byId('latest-results');
  if(!host) return;

  const recent = [...matches]
    .filter(m => Number.isFinite(m.hg) && Number.isFinite(m.ag))
    .sort((a,b)=>{
      const ta = (a.doneOn instanceof Date) ? a.doneOn.getTime() : 0;
      const tb = (b.doneOn instanceof Date) ? b.doneOn.getTime() : 0;
      return tb - ta;
    })
    .slice(0,5);

  if(!recent.length){
    host.innerHTML = '<div class="note">No completed matches yet.</div>';
    return;
  }

  host.innerHTML = recent.map(m=>{
    const parts = formatLatestDateParts(m);
    const leagueName = m.league || '';
    const leagueSafe = esc(leagueName);
    return `
      <div class="latest-item">
        <div class="latest-meta">
          <div class="latest-date-day">${esc(parts.day)}</div>
          <div class="latest-date-mon">${esc(parts.mon)}</div>
        </div>
        <img class="latest-badge"
          src="${BADGE_BASE}${leagueName}-League.png"
          alt="${leagueSafe} badge">
        <div class="latest-main">
          <div class="latest-teams">
            <span class="latest-team">${esc(m.home)}</span>
            <span class="latest-team">${esc(m.away)}</span>
          </div>
          <div class="latest-scores">
            <span class="latest-score-num">${m.hg}</span>
            <span class="latest-score-num">${m.ag}</span>
          </div>
          <div class="latest-league-wrapper">
            <span class="latest-league-pill ${leagueSafe}">${leagueSafe}</span>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

/* MAIN */
async function run(selectedKeys){
  if(!selectedKeys||!selectedKeys.length) selectedKeys=['All'];

  const selected = selectedKeys.includes('All')
    ? LEAGUES.filter(x=>x.id)
    : LEAGUES.filter(x=>x.id && selectedKeys.includes(x.key));

  const leagueResults = await Promise.all(
    selected.map(lg => loadLeagueBundle(lg))
  );

  const matches = [];
  const perLeague = {};
  const formByTeam = new Map();
  let scheduledTotal = 0;

  leagueResults.forEach(res=>{
    perLeague[res.key] = res.bucket;
    scheduledTotal += res.scheduledTotal;
    res.matches.forEach(m => matches.push(m));
    res.formMap.forEach((val,key)=>{
      if(!formByTeam.has(key)) formByTeam.set(key,val);
    });
  });

  const leagues = selected.map(x=>x.key);
  const agg = aggregate(matches);
  const minis = leagueAggregates(perLeague);
  const activity = buildActivityStats(matches);

  TEAM_INDEX = new Map();
  agg.teams.forEach(t => TEAM_INDEX.set(t.team, t));
  FORM_INDEX = formByTeam;

  renderRails(agg, leagues, scheduledTotal);
  renderLeaderboard(agg.teams);
  renderHighlights(agg);
  renderLatestResults(matches);
  renderPower(agg.teams);
  renderTopTables(agg.teams);
  renderMini(minis);
  applySelectionHighlight();

  if(activity){
    const sa = byId('season-activity');
    const mt = byId('matchday-trends');
    if(sa) sa.innerHTML = activity.activityHtml;
    if(mt) mt.innerHTML = activity.trendHtml;
  }
}

/* Boot */
(function boot(){
  renderBadges();
  run(['All']);
})();
</script>
</body>
</html>
