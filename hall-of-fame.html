<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>eFPL Hall of Fame</title>

<link rel="preconnect" href="https://docs.google.com" crossorigin>
<link rel="preconnect" href="https://www.google.com" crossorigin>

<style>
:root{
  --bg: transparent;
  --card:#00143b;
  --text:#ffffff;
  --muted:#cbd5e1;

  --header-bg:#f9d71c;
  --header-text:#00143b;

  --row1:#001a4d;
  --row2:#002060;
  --hover:#002b80;

  --accent:#f9d71c;
  --fx-border:rgba(249,215,28,.55);
}

html,body{background:var(--bg);}
body{margin:0;font:15px/1.5 "Segoe UI",Arial,sans-serif;color:var(--text);}

.wrap{max-width:1100px;margin:24px auto;padding:16px;}
.card{background:var(--card);border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25);}

.title{
  display:flex;justify-content:space-between;align-items:center;
  margin:0;padding:12px 14px;border-bottom:1px solid rgba(249,215,28,.22);
}
.title h1{font-size:20px;margin:0;display:flex;align-items:center;gap:10px}
.badge{background:var(--accent);color:#000;padding:4px 12px;border-radius:999px;font-weight:800;font-size:12px}

.tabs{
  display:flex;gap:10px;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08);
  background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
}
.tab{
  appearance:none;border:1px solid rgba(249,215,28,.25);
  background:rgba(5,34,90,.35);
  color:var(--text);
  padding:8px 12px;border-radius:999px;
  font-weight:800;cursor:pointer;
  transition:transform .15s ease, background .15s ease, border-color .15s ease;
}
.tab:hover{transform:translateY(-1px);border-color:rgba(249,215,28,.5)}
.tab.active{
  background:rgba(249,215,28,.16);
  border-color:rgba(249,215,28,.75);
}

.panel{padding:12px 14px 16px;}
.panel[hidden]{display:none;}

.skeleton{
  background:linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.12), rgba(255,255,255,.05));
  background-size:200% 100%;
  animation:sk 1.1s infinite;
  border-radius:12px;min-height:220px;
}
@keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}

.table-wrap{
  margin-top:12px;
  border-radius:12px;
  overflow:auto;
  border:1px solid rgba(255,255,255,.08);
}

/* Tables */
table{width:100%;border-collapse:collapse;min-width:720px}
thead th{
  position:sticky; top:0;
  background:var(--header-bg);color:var(--header-text);
  font-size:12px;text-transform:uppercase;letter-spacing:.03em;
  padding:10px;text-align:center;
  z-index:1;
}
tbody td{
  padding:12px;
  text-align:center;
  font-weight:600;
  white-space:nowrap;
}
tbody tr:nth-child(odd){background:var(--row1)}
tbody tr:nth-child(even){background:var(--row2)}
tbody tr:hover{background:var(--hover)}
td.left{text-align:left}
td.right{text-align:right}
td:first-child{font-weight:900}

/* Leaderboard top highlight (based on Rank column values 1/2/3) */
tbody tr.pos-1 td{
  background:linear-gradient(90deg, rgba(249,215,28,.18), rgba(249,215,28,.08)) !important;
  font-weight:900;
}
tbody tr.pos-1 td:first-child{position:relative}
tbody tr.pos-1 td:first-child::before{
  content:"";position:absolute;left:0;top:0;bottom:0;width:5px;background:var(--accent);
}
tbody tr.pos-2 td{opacity:.98}
tbody tr.pos-3 td{opacity:.96}

.note{margin:10px 0 0;color:var(--muted);font-size:13px;opacity:.9}
.err{
  margin-top:12px;
  padding:10px 12px;
  border-radius:10px;
  background:rgba(220,38,38,.12);
  border:1px solid rgba(220,38,38,.35);
  color:#fecaca;
  font-weight:700;
}

@media(max-width:680px){
  .wrap{padding:12px}
  .title{flex-wrap:wrap;gap:8px}
  .title h1{font-size:18px}
  table{min-width:820px} /* History is wide, allow horizontal scroll */
}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="title">
      <h1>üèÜ eFPL Hall of Fame</h1>
      <span class="badge" id="updated">Loading‚Ä¶</span>
    </div>

    <div class="tabs" role="tablist" aria-label="Hall of Fame tabs">
      <button class="tab active" id="tab-history" role="tab" aria-selected="true" aria-controls="panel-history">Season History</button>
      <button class="tab" id="tab-leaderboard" role="tab" aria-selected="false" aria-controls="panel-leaderboard">Leaderboard</button>
    </div>

    <div class="panel" id="panel-history" role="tabpanel" aria-labelledby="tab-history">
      <div id="sk-history" class="skeleton"></div>
      <div id="err-history" class="err" hidden></div>
      <div class="table-wrap" id="wrap-history" hidden>
        <table id="t-history"></table>
      </div>
      <div class="note">Tip: scroll sideways on mobile to view all competitions.</div>
    </div>

    <div class="panel" id="panel-leaderboard" role="tabpanel" aria-labelledby="tab-leaderboard" hidden>
      <div id="sk-leader" class="skeleton"></div>
      <div id="err-leader" class="err" hidden></div>
      <div class="table-wrap" id="wrap-leader" hidden>
        <table id="t-leader"></table>
      </div>
      <div class="note">Ranked by total trophies won (highest first).</div>
    </div>

  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SHEET_ID = "1DaYTkVVWiQVg7aianACoIfxXBZSKYqtycyuofX8WXj8";

/* Lock to gid (reliable) */
const HISTORY_GID = "1032615815";
const LEADERBOARD_GID = "1964938799";

/* Ranges */
const HISTORY_RANGE = "A1:L";   // season history grid
const LEADER_RANGE  = "A1:E";   // leaderboard (auto grows)

/* Cache bucket */
const BUCKET_MS = 5 * 60 * 1000;
const CB = Math.floor(Date.now() / BUCKET_MS);

/* ===== Helpers ===== */
function esc(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}
function parseGviz(text){
  const a = text.indexOf("{");
  const b = text.lastIndexOf("}");
  if(a === -1 || b === -1) throw new Error("Invalid GViz response");
  return JSON.parse(text.slice(a, b+1));
}
function cellVal(c){
  if(!c) return "";
  return (c.f ?? c.v ?? "");
}
function isNumeric(v){
  return /^-?\d+(\.\d+)?$/.test(String(v).trim());
}

function renderTable(tableEl, cols, rows, opts={}){
  const headers = cols.map(c => c.label || "");
  let html = "<thead><tr>" + headers.map(h => `<th>${esc(h)}</th>`).join("") + "</tr></thead><tbody>";

  for(let r=0; r<rows.length; r++){
    const row = rows[r].c || [];
    const vals = row.map(cellVal);

    if(vals.every(v => String(v).trim()==="")) continue;

    let trClass = "";
    if(opts.leaderboard){
      const pos = parseInt(String(vals[0]).trim(), 10);
      if(pos === 1) trClass = "pos-1";
      else if(pos === 2) trClass = "pos-2";
      else if(pos === 3) trClass = "pos-3";
    }

    html += `<tr class="${trClass}">`;
    for(let i=0; i<vals.length; i++){
      const v = vals[i];
      const cls =
        (i === 1 ? "left " : "") +
        (isNumeric(v) ? "right " : "");
      html += `<td class="${cls.trim()}">${esc(v)}</td>`;
    }
    html += "</tr>";
  }

  html += "</tbody>";
  tableEl.innerHTML = html;
}

async function fetchGvizJSONByGid(gid, range){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?` +
              `tqx=out:json&gid=${encodeURIComponent(gid)}` +
              `&range=${encodeURIComponent(range)}&cachebust=${CB}`;
  const res = await fetch(url);
  const text = await res.text();
  if(!res.ok) throw new Error("HTTP " + res.status);
  return parseGviz(text);
}

function setUpdatedBadge(ok=true){
  const el = document.getElementById("updated");
  if(!ok){ el.textContent = "Check sharing"; return; }
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  el.textContent = `Updated ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${String(d.getFullYear()).slice(-2)}`;
}

/* ===== Loaders ===== */
async function loadHistory(){
  const sk = document.getElementById("sk-history");
  const err = document.getElementById("err-history");
  const wrap = document.getElementById("wrap-history");
  const t = document.getElementById("t-history");

  try{
    const json = await fetchGvizJSONByGid(HISTORY_GID, HISTORY_RANGE);
    renderTable(t, json.table.cols, json.table.rows || []);
    sk.hidden = true;
    wrap.hidden = false;
    err.hidden = true;
    setUpdatedBadge(true);
  }catch(e){
    sk.hidden = true;
    wrap.hidden = true;
    err.hidden = false;
    err.textContent = "History load error: " + e.message + " (Make sure the sheet is shared or published.)";
    setUpdatedBadge(false);
  }
}

async function loadLeaderboard(){
  const sk = document.getElementById("sk-leader");
  const err = document.getElementById("err-leader");
  const wrap = document.getElementById("wrap-leader");
  const t = document.getElementById("t-leader");

  try{
    const json = await fetchGvizJSONByGid(LEADERBOARD_GID, LEADER_RANGE);
    renderTable(t, json.table.cols, json.table.rows || [], { leaderboard:true });
    sk.hidden = true;
    wrap.hidden = false;
    err.hidden = true;
    setUpdatedBadge(true);
  }catch(e){
    sk.hidden = true;
    wrap.hidden = true;
    err.hidden = false;
    err.textContent = "Leaderboard load error: " + e.message + " (Make sure the sheet is shared or published.)";
    setUpdatedBadge(false);
  }
}

/* ===== Tabs ===== */
const tabHistory = document.getElementById("tab-history");
const tabLeader  = document.getElementById("tab-leaderboard");
const panelHistory = document.getElementById("panel-history");
const panelLeader  = document.getElementById("panel-leaderboard");

let leaderLoaded = false;

function activate(which){
  const isHistory = which === "history";
  tabHistory.classList.toggle("active", isHistory);
  tabLeader.classList.toggle("active", !isHistory);
  tabHistory.setAttribute("aria-selected", isHistory ? "true":"false");
  tabLeader.setAttribute("aria-selected", !isHistory ? "true":"false");
  panelHistory.hidden = !isHistory;
  panelLeader.hidden = isHistory;

  if(!isHistory && !leaderLoaded){
    leaderLoaded = true;
    loadLeaderboard();
  }
}

tabHistory.addEventListener("click", ()=>activate("history"));
tabLeader.addEventListener("click", ()=>activate("leader"));

/* initial */
loadHistory();
</script>
</body>
</html>
