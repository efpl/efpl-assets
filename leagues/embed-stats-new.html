<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>eFPL Season 2 - Live Stats (Embed)</title>
<meta name="color-scheme" content="dark" />

<style>
/* ========= Base / Palette ========= */
:root{
  --bg:#00143b;
  --card:#0f1e49; --card2:#13265b;
  --ink:#fff; --muted:#b8c6e3; --accent:#f9d71c;
  --line:rgba(249,215,28,.28);
  --ok:#2fbf71; --mid:#9aa4b2; --away:#5aa4ff;

  /* League accent colours */
  --diamond:#99ecff;
  --ruby:#e01c71;
  --sapphire:#008af1;
  --crystal:#868af1;
  --emerald:#3d9a5c;
  --gold:#d4af37;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif}
img{max-width:100%;height:auto;display:inline-block}

/* ========= Layout ========= */
.wrap{width:100%;padding:8px 8px 24px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}

/* Hero */
.hero{
  display:flex;justify-content:space-between;align-items:center;
  gap:10px;margin-bottom:10px;padding:10px 12px;
  background:linear-gradient(135deg,rgba(249,215,28,0.18),rgba(11,27,61,0.9));
  border-radius:12px;border:1px solid rgba(249,215,28,0.35);
}
.hero-left{display:flex;align-items:center;gap:10px}
.hero-left img{height:32px;width:auto;border-radius:999px;object-fit:cover;box-shadow:0 0 12px rgba(0,0,0,.5)}
.hero-text{display:flex;flex-direction:column}
.hero-eyebrow{
  font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;
  color:#0b1b3d;background:var(--accent);padding:2px 8px;border-radius:999px;align-self:flex-start;
}
.hero-title{font-size:16px;font-weight:800}
.hero-right{
  font-size:12.5px;color:var(--muted);text-align:right;max-width:220px
}

/* League badges */
.badges{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 10px}
.badge{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:6px 10px;display:flex;align-items:center;gap:8px;cursor:pointer}
.badge img{height:20px;width:auto;object-fit:contain}
.badge.active{background:var(--accent);color:#0b1b3d;border-color:transparent}

/* KPI rail */
.rail{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0}
.kpi{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:10px}
.kpi .t{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
.kpi .v{font-weight:900;font-size:20px}

/* Bars + grids */
.mini{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
.bar{height:10px;border-radius:999px;background:rgba(255,255,255,.07);overflow:hidden;border:1px solid var(--line);display:flex}
.seg{height:100%}
.home{background:var(--ok)} .draw{background:var(--mid)} .away{background:var(--away)}
.note{color:var(--muted);font-size:12px}

.two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.mini-grid{display:grid;grid-template-columns:1fr;gap:10px}

/* ========= Tables ========= */
table{width:100%;border-collapse:collapse;table-layout:auto}
thead th{background:var(--accent);color:#0b1b3d;padding:10px 10px;font-size:12px;text-transform:uppercase;letter-spacing:.03em}
tbody td{padding:10px 10px;font-weight:600;vertical-align:middle}
tbody tr:nth-child(odd){background:var(--card)}
tbody tr:nth-child(even){background:var(--card2)}
.left{text-align:left}.right{text-align:right}.center{text-align:center}
.numeric{font-variant-numeric:tabular-nums;font-feature-settings:"tnum" 1}

/* Leaderboard width hints */
#tbl-leader col.c-rank{width:4.2ch}
#tbl-leader col.c-team{width:auto}
#tbl-leader col.c-p,
#tbl-leader col.c-w,
#tbl-leader col.c-d,
#tbl-leader col.c-l,
#tbl-leader col.c-gd{width:4.2ch}
#tbl-leader col.c-pts{width:5ch}

/* ===== League-coloured left bar + badge glow ===== */
.teamwrap{
  display:flex;align-items:flex-start;gap:10px;min-width:0;position:relative;padding-left:12px;
  cursor:pointer;
}
.teamwrap::before{
  content:"";position:absolute;left:0;top:4px;bottom:4px;width:5px;
  border-radius:2px;background:transparent;transition:box-shadow .25s ease, transform .25s ease;
}
.teamwrap.Diamond::before{ background:var(--diamond); }
.teamwrap.Ruby::before{    background:var(--ruby); }
.teamwrap.Sapphire::before{background:var(--sapphire); }
.teamwrap.Crystal::before{ background:var(--crystal); }
.teamwrap.Emerald::before{ background:var(--emerald); }
.teamwrap.Gold::before{    background:var(--gold); }

.lg{height:21px;width:auto;object-fit:contain;flex:0 0 auto;filter:drop-shadow(0 0 2px rgba(0,0,0,.6))}
.lg.Diamond{ filter:drop-shadow(0 0 4px rgba(153,236,255,.9)); }
.lg.Ruby{    filter:drop-shadow(0 0 4px rgba(224,28,113,.9)); }
.lg.Sapphire{filter:drop-shadow(0 0 4px rgba(0,138,241,.9)); }
.lg.Crystal{ filter:drop-shadow(0 0 4px rgba(134,138,241,.9)); }
.lg.Emerald{ filter:drop-shadow(0 0 4px rgba(61,154,92,.9)); }
.lg.Gold{    filter:drop-shadow(0 0 4px rgba(212,175,55,.9)); }

.teamname{display:block;min-width:0;white-space:normal;overflow:visible;line-height:1.25;word-break:break-word;color:var(--ink)}
.teamwrap:hover .teamname{text-decoration:underline}

/* Row hover glow */
#tbl-leader tbody tr:hover,
#tbl-gf tbody tr:hover,
#tbl-ga tbody tr:hover{
  position:relative;z-index:1;background-color:rgba(255,255,255,0.05);
  box-shadow:0 0 12px rgba(255,255,255,0.07) inset;transition:box-shadow .25s ease, background-color .25s ease;
}
#tbl-leader tbody tr:hover .teamwrap::before,
#tbl-gf tbody tr:hover .teamwrap::before,
#tbl-ga tbody tr:hover .teamwrap::before{ transform:scaleX(1.15); }

#tbl-leader tbody tr:hover .teamwrap.Diamond::before,
#tbl-gf tbody tr:hover .teamwrap.Diamond::before,
#tbl-ga tbody tr:hover .teamwrap.Diamond::before{ box-shadow:0 0 16px 2px rgba(153,236,255,.85); }
#tbl-leader tbody tr:hover .teamwrap.Ruby::before,
#tbl-gf tbody tr:hover .teamwrap.Ruby::before,
#tbl-ga tbody tr:hover .teamwrap.Ruby::before{ box-shadow:0 0 16px 2px rgba(224,28,113,.85); }
#tbl-leader tbody tr:hover .teamwrap.Sapphire::before,
#tbl-gf tbody tr:hover .teamwrap.Sapphire::before,
#tbl-ga tbody tr:hover .teamwrap.Sapphire::before{ box-shadow:0 0 16px 2px rgba(0,138,241,.85); }
#tbl-leader tbody tr:hover .teamwrap.Crystal::before,
#tbl-gf tbody tr:hover .teamwrap.Crystal::before,
#tbl-ga tbody tr:hover .teamwrap.Crystal::before{ box-shadow:0 0 16px 2px rgba(134,138,241,.85); }
#tbl-leader tbody tr:hover .teamwrap.Emerald::before,
#tbl-gf tbody tr:hover .teamwrap.Emerald::before,
#tbl-ga tbody tr:hover .teamwrap.Emerald::before{ box-shadow:0 0 16px 2px rgba(61,154,92,.85); }
#tbl-leader tbody tr:hover .teamwrap.Gold::before,
#tbl-gf tbody tr:hover .teamwrap.Gold::before,
#tbl-ga tbody tr:hover .teamwrap.Gold::before{ box-shadow:0 0 16px 2px rgba(212,175,55,.85); }

/* Highlights wrap */
#tbl-hi td{white-space:normal;line-height:1.35}

/* Form pills (for profile + flyout) */
.form{
  display:inline-flex;gap:4px;align-items:center;justify-content:center;
  vertical-align:middle;white-space:nowrap;
}
.fpill{
  display:inline-block;width:16px;height:16px;border-radius:999px;
  font-size:10px;line-height:16px;font-weight:800;text-align:center;
  box-shadow:0 0 0 1px rgba(0,0,0,.15), inset 0 0 0 1px rgba(255,255,255,.12);
}
.f-W{background:#16a34a;color:#fff}
.f-D{background:#e5e7eb;color:#111}
.f-L{background:#dc2626;color:#fff}

/* Player profile panel */
.player-panel-header{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.player-panel-badge{height:32px;width:auto;border-radius:8px;object-fit:contain;box-shadow:0 0 10px rgba(0,0,0,.6)}
.player-panel-name{font-weight:800;font-size:15px}
.player-panel-league{font-size:12px;color:var(--muted)}
.player-panel-table{width:100%;border-collapse:collapse;font-size:13px;margin-top:4px}
.player-panel-table td{padding:3px 0}

/* Flyout profile */
.flyout{
  position:absolute;z-index:20;min-width:200px;max-width:260px;
  background:var(--card2);border-radius:10px;border:1px solid var(--line);
  padding:8px;box-shadow:0 12px 30px rgba(0,0,0,.6);
  font-size:12px;pointer-events:none;
}
.flyout-header{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.flyout-badge{height:22px;width:auto;border-radius:6px;object-fit:contain}
.flyout-name{font-weight:700;font-size:13px}
.flyout-league{font-size:11px;color:var(--muted)}
.flyout-table{width:100%;border-collapse:collapse;font-size:12px}
.flyout-table td{padding:2px 0}

/* Per-league cards */
.league-card{
  display:flex;align-items:center;gap:10px;
  background:var(--card);border:1px solid var(--line);border-radius:10px;
  padding:10px;position:relative;overflow:hidden;
}
.league-card::before{
  content:"";position:absolute;left:0;top:0;bottom:0;width:4px;border-radius:10px;
  background:var(--accent);opacity:.8;
}
.league-card.Diamond::before{background:var(--diamond);}
.league-card.Ruby::before{background:var(--ruby);}
.league-card.Sapphire::before{background:var(--sapphire);}
.league-card.Crystal::before{background:var(--crystal);}
.league-card.Emerald::before{background:var(--emerald);}
.league-card.Gold::before{background:var(--gold);}
.league-card img{height:26px;width:auto;object-fit:contain;flex:0 0 auto}
.league-card-title{font-weight:700}
.league-card-sub{font-size:12px;color:var(--muted)}

/* Footer */
.footer-nav{
  margin-top:8px;font-size:12px;color:var(--muted);text-align:right;
}
.footer-nav a{color:var(--accent);text-decoration:none}
.footer-nav a:hover{text-decoration:underline}

/* ========= Responsive ========= */
@media (max-width:1100px){
  .rail{grid-template-columns:repeat(2,1fr)}
}
@media (max-width:900px){
  .two-col{grid-template-columns:1fr}
  .mini{grid-template-columns:1fr}
}
@media (max-width:520px){
  .hero{flex-direction:column;align-items:flex-start}
  .hero-right{text-align:left;max-width:none}
  .rail{grid-template-columns:1fr}
  thead th{padding:8px;font-size:11.5px}
  tbody td{padding:8px;font-size:14px}
  .lg{height:18px}
  .teamwrap{ padding-left:10px; gap:8px; }
  .teamwrap::before{ left:0; top:6px; bottom:6px; width:5px; }

  /* hide D and L on tiny screens */
  #tbl-leader th:nth-child(5),
  #tbl-leader td:nth-child(5),
  #tbl-leader th:nth-child(6),
  #tbl-leader td:nth-child(6){
    display:none !important;
  }
  #tbl-leader{
    table-layout:auto !important;
  }
  #tbl-leader col{width:auto !important;}
}
@media (max-width:360px){
  tbody td{font-size:13px}
}
</style>
</head>
<body>
  <div class="wrap">

    <!-- Hero mini header -->
    <section class="hero">
      <div class="hero-left">
        <img src="https://efpl-assets.pages.dev/img/e-avatar.jpg" alt="eFPL avatar">
        <div class="hero-text">
          <span class="hero-eyebrow">Season 2 live hub</span>
          <span class="hero-title">eFPL Stats Center</span>
        </div>
      </div>
      <div class="hero-right" id="hero-summary">
        Loading live data...
      </div>
    </section>

    <!-- League badge filter -->
    <nav class="badges" id="badges"></nav>

    <!-- KPI rail -->
    <section class="rail" aria-label="Key metrics">
      <div class="kpi"><div class="t">Matches</div><div class="v" id="kpi-matches">-</div></div>
      <div class="kpi"><div class="t">Goals</div><div class="v" id="kpi-goals">-</div></div>
      <div class="kpi"><div class="t">Avg per match</div><div class="v" id="kpi-avg">-</div></div>
      <div class="kpi"><div class="t">Leagues</div><div class="v" id="kpi-leagues">-</div></div>
    </section>

    <!-- Result + Completion bars -->
    <section class="mini" style="margin-top:10px">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <strong>Result split</strong>
          <span id="split-text" class="note">-</span>
        </div>
        <div class="bar" title="Home / Draw / Away">
          <span id="seg-home" class="seg home" style="width:0%"></span>
          <span id="seg-draw" class="seg draw" style="width:0%"></span>
          <span id="seg-away" class="seg away" style="width:0%"></span>
        </div>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <strong>Completion</strong>
          <span id="prog-text" class="note">-</span>
        </div>
        <div class="bar" title="Completed / Scheduled">
          <span id="seg-prog" class="seg" style="width:0%;background:linear-gradient(90deg,#ffd03b,#f9d71c)"></span>
        </div>
      </div>
    </section>

    <!-- NEW: Season activity + Matchday trends -->
    <section class="mini" style="margin-top:2px">
      <div class="card">
        <h3 style="margin:0 0 6px">Season activity</h3>
        <div id="act-main" class="note" style="margin-bottom:4px">-</div>
        <div id="act-extra" class="note"></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 6px">Matchday trends</h3>
        <div id="trend-main" class="note" style="margin-bottom:4px">-</div>
        <div id="trend-extra" class="note"></div>
      </div>
    </section>

    <!-- Leaderboard + Highlights + Selected player -->
    <section class="two-col" style="margin-top:10px">
      <div class="card">
        <h3 style="margin:0 0 8px">Leaderboard</h3>
        <table id="tbl-leader">
          <colgroup>
            <col class="c-rank"><col class="c-team">
            <col class="c-p"><col class="c-w"><col class="c-d"><col class="c-l">
            <col class="c-gd"><col class="c-pts">
          </colgroup>
          <thead><tr>
            <th>#</th><th class="left">Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <!-- Selected player panel -->
        <div class="card" id="player-panel">
          <div class="player-panel-header">
            <img src="https://efpl-assets.pages.dev/img/leagues/Diamond-League.png" alt="League badge" class="player-panel-badge" id="player-panel-badge">
            <div>
              <div class="player-panel-name" id="player-panel-name">Selected player</div>
              <div class="player-panel-league" id="player-panel-league">Tap a team to view their profile.</div>
            </div>
          </div>
          <div id="player-panel-body" class="note">
            Tap a team name in the leaderboard or goal/defence tables to view their profile here.
          </div>
        </div>

        <h3 style="margin:10px 0 8px">Highlights</h3>
        <table id="tbl-hi">
          <tbody>
            <tr><td class="left">Biggest win</td><td id="hi-big" class="right">-</td></tr>
            <tr><td class="left">Highest scoring game</td><td id="hi-hsg" class="right">-</td></tr>
            <tr><td class="left">Top scoring team</td><td id="hi-topgf" class="right">-</td></tr>
            <tr><td class="left">Most conceded</td><td id="hi-mostga" class="right">-</td></tr>
            <tr><td class="left">Most clean sheets</td><td id="hi-mostcs" class="right">-</td></tr>
          </tbody>
        </table>

        <div class="mini-grid" style="margin-top:10px">
          <div class="card">
            <strong>Top scoring teams (Top 10)</strong>
            <table id="tbl-gf" style="margin-top:6px">
              <colgroup>
                <col class="c-rank"><col class="c-team">
                <col class="c-gf"><col class="c-pts">
              </colgroup>
              <thead><tr><th>#</th><th class="left">Team</th><th>GF</th><th>Pts</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="card">
            <strong>Best defence (Top 10)</strong>
            <table id="tbl-ga" style="margin-top:6px">
              <colgroup>
                <col class="c-rank"><col class="c-team">
                <col class="c-ga"><col class="c-pts">
              </colgroup>
              <thead><tr><th>#</th><th class="left">Team</th><th>GA</th><th>Pts</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Per-league compact cards -->
    <section class="card" style="margin-top:10px">
      <h3 style="margin:0 0 8px">Per league comparison</h3>
      <div id="league-mini" class="mini"></div>
      <div class="note">Each card shows: average goals, home/draw/away share, and completion percentage.</div>
    </section>

    <div class="footer-nav">
      <a href="#top" onclick="window.scrollTo({top:0,behavior:'smooth'});return false;">Back to top</a>
    </div>

    <!-- Hover flyout for quick player profile -->
    <div id="player-flyout" class="flyout" style="display:none"></div>
  </div>

<script>
/* ====== CONFIG ====== */
const LEAGUES = [
  { key:'All',      name:'All Leagues', badge:null, id:null }, // synthetic
  { key:'Diamond',  name:'Diamond',  badge:'Diamond-League.png',  id:'1vkDOFfwBJJnSHOPM0BFcrNyZd-2nIbiDKNnWGKT3OP0' },
  { key:'Ruby',     name:'Ruby',     badge:'Ruby-League.png',     id:'12Qg5yi3yQtsPSrd6EHxROkPNurVn5ylzELPvU4UOmGU' },
  { key:'Sapphire', name:'Sapphire', badge:'Sapphire-League.png', id:'1qa03hOquzVg8ithFLdhrel2O3k3nTQCQZp81AWFvECg' },
  { key:'Crystal',  name:'Crystal',  badge:'Crystal-League.png',  id:'1LqRM7ICWpENmsKH5tTuu7Bf7VQa7YoJ-9TAivruymvo' },
  { key:'Emerald',  name:'Emerald',  badge:'Emerald-League.png',  id:'1rD_03y276wGjjlukus6icgwq_FPcOgc70654dOOG6sg' },
  { key:'Gold',     name:'Gold',     badge:'Gold-League.png',     id:'1ACOQ3dffrjczk1LmBmPiC-wV37t9nQKEDwApOEEeFU8' },
];
const BADGE_BASE = 'https://efpl-assets.pages.dev/img/leagues/';

const FX_TAB = 'Fixtures', FX_RANGE='C4:I94'; // Home|HG|-|AG|Away|Completed|Completed On
const EM_TAB = 'Embed',    EM_RANGE='A15:C105'; // Home|mid|Away
const BUCKET_MS = 5*60*1000, CB = Math.floor(Date.now()/BUCKET_MS);

let TEAM_INDEX = new Map();    // team -> aggregated object
let TEAM_FORM = new Map();     // team -> raw form string (optional, future use)

/* ====== Utils ====== */
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function parseGviz(txt){const a=txt.indexOf('{'),b=txt.lastIndexOf('}');if(a===-1||b===-1)throw new Error('Bad GViz');return JSON.parse(txt.slice(a,b+1))}
function num(x){const n=Number(x);return Number.isFinite(n)?n:null}
function truthy(v){return v===true || String(v).toLowerCase()==='true' || v==='☑'}
function pct(p,t){return t?((p*100/t).toFixed(1)+'%'):'0.0%'}
function fmt(n){return Number.isFinite(n)?n.toLocaleString():'0'}
function setTxt(id,txt){const el=document.getElementById(id); if(el) el.textContent=txt;}
function byId(id){return document.getElementById(id)}
function safeDate(v){
  if(!v) return null;
  const d=new Date(v);
  return isNaN(d.getTime())?null:d;
}
function formatShortDate(d){
  if(!d) return '-';
  const opts={day:'2-digit',month:'short'};
  return d.toLocaleDateString(undefined,opts);
}
function formatShortDateRange(s,e){
  if(!s||!e) return '-';
  const sameMonth = s.getMonth()===e.getMonth() && s.getFullYear()===e.getFullYear();
  if(s.getFullYear()!==e.getFullYear()){
    return s.toLocaleDateString(undefined,{day:'2-digit',month:'short',year:'2-digit'}) +
      ' - ' +
      e.toLocaleDateString(undefined,{day:'2-digit',month:'short',year:'2-digit'});
  }
  if(sameMonth){
    return `${s.getDate()} - ${e.getDate()} ${s.toLocaleDateString(undefined,{month:'short'})}`;
  }
  return s.toLocaleDateString(undefined,{day:'2-digit',month:'short'}) +
    ' - ' +
    e.toLocaleDateString(undefined,{day:'2-digit',month:'short'});
}

/* ====== Fetchers ====== */
async function fetchRange(id, sheet, range){
  const url=`https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}&range=${encodeURIComponent(range)}&cachebust=${CB}`;
  const res=await fetch(url); const txt=await res.text();
  if(!res.ok) throw new Error(res.status+' '+txt.slice(0,160));
  return parseGviz(txt);
}
async function loadFromFixtures(id){
  const data=await fetchRange(id, FX_TAB, FX_RANGE);
  const rows=(data.table.rows||[]).map(r=>(r.c||[]).map(c=>c?c.v:'')); let scheduled=0;
  const items=rows.map(c=>{
    const home=c[0]??'', hg=num(c[1]), ag=num(c[3]), away=c[4]??'', completed=truthy(c[5]), doneOn=safeDate(c[6]);
    if(home&&away) scheduled++;
    return {home,away,hg,ag,completed,doneOn};
  });
  return {items, scheduled};
}
async function loadFromEmbed(id){
  const data=await fetchRange(id, EM_TAB, EM_RANGE);
  const rows=(data.table.rows||[]).map(r=>(r.c||[]).map(c=>c?c.v:'')).filter(r=>r && !r.every(x=>String(x).trim()===''));
  const scheduled=rows.filter(r=>(r[0]||'').trim()&&(r[2]||'').trim()).length;
  const items=rows.map(r=>{
    const mid=r[1]??'', clean=String(mid).replace(/[^0-9\-]/g,'').trim();
    const m=clean.match(/^(\d+)\s*-\s*(\d+)$/);
    return {home:r[0]??'',away:r[2]??'',hg:m?Number(m[1]):null,ag:m?Number(m[2]):null,completed:!!m,doneOn:null};
  });
  return {items, scheduled};
}

async function loadAll(selectedKeys){
  const selected = selectedKeys.includes('All')
    ? LEAGUES.filter(x=>x.id)
    : LEAGUES.filter(x=>x.id && selectedKeys.includes(x.key));
  const matches=[], perLeague={}, leagues=selected.map(x=>x.key);
  let scheduledTotal=0;

  for(const lg of selected){
    perLeague[lg.key]={matches:[],scheduled:0};
    let gotAny=false;
    try{
      const {items,scheduled}=await loadFromFixtures(lg.id);
      scheduledTotal+=scheduled; perLeague[lg.key].scheduled+=scheduled;
      items.forEach(r=>{
        if(r.completed && Number.isFinite(r.hg) && Number.isFinite(r.ag)){
          const m={league:lg.key,home:r.home,away:r.away,hg:r.hg,ag:r.ag,doneOn:r.doneOn};
          matches.push(m); perLeague[lg.key].matches.push(m); gotAny=true;
        }
      });
      if(gotAny) continue;
    }catch(e){}
    try{
      const {items,scheduled}=await loadFromEmbed(lg.id);
      scheduledTotal+=scheduled; perLeague[lg.key].scheduled+=scheduled;
      items.forEach(r=>{
        if(r.completed && Number.isFinite(r.hg) && Number.isFinite(r.ag)){
          const m={league:lg.key,home:r.home,away:r.away,hg:r.hg,ag:r.ag,doneOn:null};
          matches.push(m); perLeague[lg.key].matches.push(m);
        }
      });
    }catch(e){}
  }
  return {matches, leagues, perLeague, scheduledTotal};
}

/* ====== Aggregation ====== */
function aggregate(matches){
  const played=matches.length;
  const goals=matches.reduce((s,m)=>s+m.hg+m.ag,0);
  const avg=played?goals/played:0;

  let homeW=0,draw=0,awayW=0;
  let biggest=null, highest=null;

  const teams=new Map();
  function add(name){
    if(!teams.has(name)){
      teams.set(name,{
        team:name,league:null,
        gp:0,w:0,d:0,l:0,gf:0,ga:0,gd:0,pts:0,cs:0,
        results:[]
      });
    }
    return teams.get(name);
  }

  matches.forEach(m=>{
    if(m.hg>m.ag) homeW++; else if(m.hg<m.ag) awayW++; else draw++;

    const diff=Math.abs(m.hg-m.ag);
    if(!biggest || diff>biggest.diff){
      const text = m.hg>=m.ag ? `${m.home} ${m.hg}-${m.ag} ${m.away}` : `${m.away} ${m.ag}-${m.hg} ${m.home}`;
      biggest={diff,text,sub:`${m.league}`};
    }
    const total=m.hg+m.ag;
    if(!highest || total>highest.total){
      highest={total,text:`${m.home} ${m.hg}-${m.ag} ${m.away}`,sub:`${m.league}`};
    }

    const H=add(m.home), A=add(m.away);
    if(!H.league) H.league = m.league;
    if(!A.league) A.league = m.league;

    H.gp++; A.gp++;
    H.gf+=m.hg; H.ga+=m.ag;
    A.gf+=m.ag; A.ga+=m.hg;

    let hRes='D', aRes='D';
    if(m.hg>m.ag){
      H.w++; H.pts+=3; A.l++;
      hRes='W'; aRes='L';
    } else if(m.hg<m.ag){
      A.w++; A.pts+=3; H.l++;
      hRes='L'; aRes='W';
    } else {
      H.d++; A.d++; H.pts++; A.pts++;
      hRes='D'; aRes='D';
    }
    if(m.ag===0) H.cs++; if(m.hg===0) A.cs++;

    H.results.push(hRes);
    A.results.push(aRes);
  });

  const list=Array.from(teams.values()).map(t=>({...t,gd:t.gf-t.ga}));
  const topGF = [...list].sort((a,b)=> b.gf-a.gf || a.team.localeCompare(b.team))[0] || null;
  const mostGA = [...list].sort((a,b)=> b.ga-a.ga || a.team.localeCompare(b.team))[0] || null;
  const mostCS = [...list].sort((a,b)=> b.cs-a.cs || a.team.localeCompare(b.team))[0] || null;

  return {played,goals,avg,homeW,draw,awayW,teams:list,biggest,highest,topGF,mostGA,mostCS};
}

function leagueAggregates(perLeague){
  const out=[];
  for(const key of Object.keys(perLeague)){
    const bucket=perLeague[key];
    const ms=bucket.matches, scheduled=bucket.scheduled;
    const played=ms.length;
    const goals=ms.reduce((s,m)=>s+m.hg+m.ag,0);
    const avg=played?goals/played:0;
    const homeW=ms.filter(m=>m.hg>m.ag).length;
    const draw =ms.filter(m=>m.hg===m.ag).length;
    const awayW=ms.filter(m=>m.hg<m.ag).length;
    out.push({league:key,played,scheduled,avg,homeW,draw,awayW});
  }
  return out.sort((a,b)=>a.league.localeCompare(b.league));
}

/* ====== NEW: Activity + matchday stats from dates ====== */
function computeActivity(matches){
  const dated = matches.filter(m=>m.doneOn instanceof Date);
  const total = dated.length;
  if(!total) return null;

  const DAY_MS = 24*60*60*1000;
  const now = Date.now();
  const last7 = now - 7*DAY_MS;
  const last30 = now - 30*DAY_MS;

  let last7Count=0,last30Count=0,weekend=0,weekday=0;
  const dowCounts = new Array(7).fill(0); // 0-6
  const dayCounts = new Map(); // 'YYYY-MM-DD' -> count
  const weekCounts = new Map(); // weekStartKey -> count
  const weekStartMap = new Map(); // key -> Date

  dated.forEach(m=>{
    const d=m.doneOn;
    const t=d.getTime();
    if(t>=last7) last7Count++;
    if(t>=last30) last30Count++;

    const dow=d.getDay(); // 0=Sun..6=Sat
    dowCounts[dow]++;
    if(dow===0 || dow===6) weekend++; else weekday++;

    const dayKey=d.toISOString().slice(0,10);
    dayCounts.set(dayKey,(dayCounts.get(dayKey)||0)+1);

    // week start = Monday
    const jsDow=d.getDay();
    const offset=(jsDow+6)%7; // days since Monday
    const wkStart=new Date(d); wkStart.setHours(0,0,0,0); wkStart.setDate(wkStart.getDate()-offset);
    const wkKey=wkStart.toISOString().slice(0,10);
    weekCounts.set(wkKey,(weekCounts.get(wkKey)||0)+1);
    if(!weekStartMap.has(wkKey)) weekStartMap.set(wkKey,wkStart);
  });

  // most common day of week
  let maxDowIdx=null,maxDowCount=0;
  for(let i=0;i<7;i++){
    if(dowCounts[i]>maxDowCount){maxDowCount=dowCounts[i];maxDowIdx=i;}
  }

  // busiest day
  let busiestDayKey=null,busiestDayCount=0;
  dayCounts.forEach((cnt,key)=>{
    if(cnt>busiestDayCount){busiestDayCount=cnt;busiestDayKey=key;}
  });

  // busiest week
  let busiestWeekKey=null,busiestWeekCount=0;
  weekCounts.forEach((cnt,key)=>{
    if(cnt>busiestWeekCount){busiestWeekCount=cnt;busiestWeekKey=key;}
  });

  function parseDateKey(key){
    const [y,m,d]=key.split('-').map(Number);
    return new Date(y,m-1,d);
  }

  const busiestDayDate = busiestDayKey?parseDateKey(busiestDayKey):null;
  const bestWeekStart = busiestWeekKey?weekStartMap.get(busiestWeekKey):null;
  let bestWeekEnd=null;
  if(bestWeekStart){
    bestWeekEnd=new Date(bestWeekStart);
    bestWeekEnd.setDate(bestWeekEnd.getDate()+6);
  }

  return {
    total,last7:last7Count,last30:last30Count,
    weekend,weekday,
    maxDowIdx,maxDowCount,dowCounts,
    busiestDayDate,busiestDayCount,
    bestWeekStart,bestWeekEnd,bestWeekCount:busiestWeekCount
  };
}

/* ====== Render helpers ====== */
function renderBadges(){
  const host=byId('badges'); host.innerHTML='';
  const all=document.createElement('div');
  all.className='badge active'; all.dataset.key='All';
  all.innerHTML=`<img src="https://efpl-assets.pages.dev/img/logo.png" alt="All"><span>All</span>`;
  all.onclick=()=>selectLeague('All');
  host.appendChild(all);
  LEAGUES.filter(x=>x.id).forEach(lg=>{
    const div=document.createElement('div');
    div.className='badge'; div.dataset.key=lg.key;
    div.innerHTML=`<img src="${BADGE_BASE}${lg.badge}" alt="${esc(lg.key)}"><span>${esc(lg.key)}</span>`;
    div.onclick=()=>selectLeague(lg.key);
    host.appendChild(div);
  });
}
function selectLeague(key){
  [...document.querySelectorAll('.badge')].forEach(b=>b.classList.toggle('active', b.dataset.key===key));
  run([key]);
}

function teamCell(t){
  const lg = t.league || 'Diamond';
  return `<span class="teamwrap ${esc(lg)}" data-team="${esc(t.team)}">
    <img class="lg ${esc(lg)}" src="${BADGE_BASE}${lg}-League.png" alt="${esc(lg)}">
    <span class="teamname" title="View profile: ${esc(t.team)}">${esc(t.team)}</span>
  </span>`;
}

function renderRails(agg, leagues, scheduledTotal, activity){
  setTxt('kpi-matches', fmt(agg.played));
  setTxt('kpi-goals', fmt(agg.goals));
  setTxt('kpi-avg', agg.avg.toFixed(2));
  setTxt('kpi-leagues', leagues.length);

  byId('split-text').textContent = `${fmt(agg.homeW)} H • ${fmt(agg.draw)} D • ${fmt(agg.awayW)} A • ${pct(agg.homeW,agg.played)} / ${pct(agg.draw,agg.played)} / ${pct(agg.awayW,agg.played)}`;
  byId('seg-home').style.width = (agg.played?agg.homeW*100/agg.played:0) + '%';
  byId('seg-draw').style.width = (agg.played?agg.draw*100/agg.played:0) + '%';
  byId('seg-away').style.width = (agg.played?agg.awayW*100/agg.played:0) + '%';

  byId('prog-text').textContent = scheduledTotal ? `${fmt(agg.played)} / ${fmt(scheduledTotal)} • ${pct(agg.played,scheduledTotal)}` : '0 / 0 • 0.0%';
  byId('seg-prog').style.width = scheduledTotal ? (agg.played*100/scheduledTotal)+'%' : '0%';

  const hero = byId('hero-summary');
  if(hero){
    hero.textContent = `${fmt(agg.played)} matches across ${leagues.length} league${leagues.length!==1?'s':''}. Data updates automatically.`;
  }

  // Season activity + trends
  const actMain = byId('act-main');
  const actExtra = byId('act-extra');
  const trendMain = byId('trend-main');
  const trendExtra = byId('trend-extra');

  if(!activity){
    actMain.textContent = 'Not enough completed match dates yet.';
    actExtra.textContent = '';
    trendMain.textContent = 'Matchday trends will appear once more games are dated.';
    trendExtra.textContent = '';
  }else{
    actMain.textContent = `${fmt(activity.last7)} matches in the last 7 days • ${fmt(activity.last30)} in the last 30 days (based on dated fixtures).`;
    if(activity.bestWeekStart){
      const range = formatShortDateRange(activity.bestWeekStart, activity.bestWeekEnd);
      const dayStr = activity.busiestDayDate ? formatShortDate(activity.busiestDayDate) : '-';
      actExtra.textContent = `Busiest week: ${range} (${fmt(activity.bestWeekCount)} matches) • Busiest day: ${dayStr} (${fmt(activity.busiestDayCount)} matches).`;
    }else{
      actExtra.textContent = '';
    }

    const dayNames=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    if(activity.maxDowIdx!=null){
      const name=dayNames[activity.maxDowIdx];
      const share = pct(activity.maxDowCount, activity.total);
      trendMain.textContent = `Most games are played on ${name} (${share} of dated fixtures).`;
    }else{
      trendMain.textContent = 'Most common matchday will appear once more dates are available.';
    }
    trendExtra.textContent = `Weekend vs weekday: ${pct(activity.weekend,activity.total)} / ${pct(activity.weekday,activity.total)}.`;
  }
}

function renderLeaderboard(teams){
  const tbody = byId('tbl-leader').querySelector('tbody'); tbody.innerHTML='';
  const rows=[...teams].sort((a,b)=> b.pts-a.pts || (b.gd-a.gd) || (b.gf-a.gf) || a.team.localeCompare(b.team));
  rows.forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="right numeric">${i+1}</td>
      <td class="left">${teamCell(t)}</td>
      <td class="right numeric">${t.gp}</td>
      <td class="right numeric">${t.w}</td>
      <td class="right numeric">${t.d}</td>
      <td class="right numeric">${t.l}</td>
      <td class="right numeric">${t.gd}</td>
      <td class="right numeric"><strong>${t.pts}</strong></td>`;
    tbody.appendChild(tr);
  });
}

function renderHighlights(agg){
  setTxt('hi-big', agg.biggest ? `${agg.biggest.text} (${agg.biggest.sub})` : '-');
  setTxt('hi-hsg', agg.highest ? `${agg.highest.text} (${agg.highest.total} goals • ${agg.highest.sub})` : '-');
  setTxt('hi-topgf', agg.topGF ? `${agg.topGF.team} - ${agg.topGF.gf}` : '-');
  setTxt('hi-mostga', agg.mostGA ? `${agg.mostGA.team} - ${agg.mostGA.ga}` : '-');
  setTxt('hi-mostcs', agg.mostCS ? `${agg.mostCS.team} - ${agg.mostCS.cs}` : '-');
}

function renderTopTables(teams){
  const gf = [...teams].sort((a,b)=> b.gf-a.gf || a.team.localeCompare(b.team)).slice(0,10);
  const gfBody = byId('tbl-gf').querySelector('tbody'); gfBody.innerHTML='';
  gf.forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td class="right numeric">${i+1}</td><td class="left">${teamCell(t)}</td><td class="right numeric">${t.gf}</td><td class="right numeric">${t.pts}</td>`;
    gfBody.appendChild(tr);
  });
  const ga = [...teams].sort((a,b)=> a.ga-b.ga || a.team.localeCompare(b.team)).slice(0,10);
  const gaBody = byId('tbl-ga').querySelector('tbody'); gaBody.innerHTML='';
  ga.forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td class="right numeric">${i+1}</td><td class="left">${teamCell(t)}</td><td class="right numeric">${t.ga}</td><td class="right numeric">${t.pts}</td>`;
    gaBody.appendChild(tr);
  });
}

function renderMini(minis){
  const host=byId('league-mini'); host.innerHTML='';
  minis.forEach(m=>{
    const line = `${m.played?m.avg.toFixed(2):'0.00'} avg • ${pct(m.homeW,m.played)} / ${pct(m.draw,m.played)} / ${pct(m.awayW,m.played)} • ${pct(m.played,m.scheduled||0)}`;
    const lg = esc(m.league);
    const div=document.createElement('div');
    div.innerHTML = `<div class="league-card ${lg}">
      <img src="${BADGE_BASE}${lg}-League.png" alt="${lg}">
      <div>
        <div class="league-card-title">${lg} League</div>
        <div class="league-card-sub">${line}</div>
      </div>
    </div>`;
    host.appendChild(div.firstElementChild);
  });
}

/* ====== Form pills (from results array) ====== */
function normaliseFormArray(results){
  if(!Array.isArray(results) || !results.length) return [];
  const clean = results.slice(-5); // last 5 already in match order (old -> new)
  return clean.map(ch=>{
    const c=(ch||'').toString().toUpperCase();
    return (c==='W'||c==='D'||c==='L')?c:null;
  }).filter(Boolean);
}
function renderFormPillsFromResults(results){
  const arr = normaliseFormArray(results);
  if(!arr.length) return 'No matches yet';
  const aria = 'Form: ' + arr.join(' ');
  return '<span class="form" aria-label="'+esc(aria)+'">'+
    arr.map(ch=>{
      const cls = ch==='W' ? 'f-W' : ch==='D' ? 'f-D' : 'f-L';
      return `<span class="fpill ${cls}">${ch}</span>`;
    }).join('')+
  '</span>';
}

/* ====== Selected player panel ====== */
function renderSelectedPlayer(teamName){
  const team = TEAM_INDEX.get(teamName);
  const badgeEl = byId('player-panel-badge');
  const nameEl = byId('player-panel-name');
  const leagueEl = byId('player-panel-league');
  const bodyEl = byId('player-panel-body');
  if(!team || !badgeEl || !nameEl || !leagueEl || !bodyEl) return;

  const league = team.league || '';
  const badgeUrl = `${BADGE_BASE}${league || 'Diamond'}-League.png`;
  const gdText = (team.gd>=0?'+':'') + team.gd;
  const formHtml = renderFormPillsFromResults(team.results);

  badgeEl.src = badgeUrl;
  badgeEl.alt = esc(league || 'League');
  nameEl.textContent = team.team;
  leagueEl.textContent = league ? `${league} League` : 'eFPL player';

  bodyEl.innerHTML = `
    <table class="player-panel-table">
      <tbody>
        <tr>
          <td class="note">Matches</td>
          <td class="right" style="font-weight:600">${team.gp}</td>
          <td class="note">Points</td>
          <td class="right" style="font-weight:600">${team.pts}</td>
        </tr>
        <tr>
          <td class="note">Record</td>
          <td class="right" colspan="3" style="font-weight:600">${team.w}-${team.d}-${team.l}</td>
        </tr>
        <tr>
          <td class="note">Goals</td>
          <td class="right" colspan="3" style="font-weight:600">${team.gf} / ${team.ga} (${gdText})</td>
        </tr>
        <tr>
          <td class="note">Form (last 5)</td>
          <td class="right" colspan="3">${formHtml}</td>
        </tr>
      </tbody>
    </table>
  `;
}

/* ====== Hover flyout ====== */
const flyout = document.getElementById('player-flyout');
let flyoutTimer = null;

function showFlyout(teamName, anchor){
  const team = TEAM_INDEX.get(teamName);
  if(!team || !flyout || !anchor) return;

  const league = team.league || '';
  const badgeUrl = `${BADGE_BASE}${league || 'Diamond'}-League.png`;
  const gdText = (team.gd>=0?'+':'') + team.gd;
  const formHtml = renderFormPillsFromResults(team.results);

  flyout.innerHTML = `
    <div class="flyout-header">
      <img src="${badgeUrl}" alt="${esc(league || 'League')}" class="flyout-badge">
      <div>
        <div class="flyout-name">${esc(team.team)}</div>
        <div class="flyout-league">${league ? esc(league)+' League' : 'eFPL player'}</div>
      </div>
    </div>
    <table class="flyout-table">
      <tbody>
        <tr>
          <td class="note">Matches</td>
          <td class="right" style="font-weight:600">${team.gp}</td>
          <td class="note">Pts</td>
          <td class="right" style="font-weight:600">${team.pts}</td>
        </tr>
        <tr>
          <td class="note">Goals</td>
          <td class="right" colspan="3" style="font-weight:600">${team.gf} / ${team.ga} (${gdText})</td>
        </tr>
        <tr>
          <td class="note">Form</td>
          <td class="right" colspan="3">${formHtml}</td>
        </tr>
      </tbody>
    </table>
  `;

  const rect = anchor.getBoundingClientRect();
  const scrollY = window.scrollY || document.documentElement.scrollTop || 0;
  const scrollX = window.scrollX || document.documentElement.scrollLeft || 0;

  const top = rect.top + scrollY - 6;
  const left = rect.right + scrollX + 8;

  flyout.style.top = top + 'px';
  flyout.style.left = left + 'px';
  flyout.style.display = 'block';
}

function hideFlyoutSoon(){
  if(flyoutTimer) clearTimeout(flyoutTimer);
  flyoutTimer = setTimeout(()=>{
    if(flyout) flyout.style.display='none';
  }, 120);
}

/* Hover + click handlers */
document.addEventListener('mouseover', (e)=>{
  const wrap = e.target.closest('.teamwrap');
  if(!wrap || !wrap.dataset.team) return;
  // Only show on devices that likely have a mouse
  if(matchMedia('(pointer:fine)').matches){
    showFlyout(wrap.dataset.team, wrap);
  }
});
document.addEventListener('mouseout', (e)=>{
  const wrap = e.target.closest('.teamwrap');
  if(wrap && flyout) hideFlyoutSoon();
});
if(flyout){
  flyout.addEventListener('mouseenter', ()=>{ if(flyoutTimer) clearTimeout(flyoutTimer); });
  flyout.addEventListener('mouseleave', hideFlyoutSoon);
}

document.addEventListener('click', (e)=>{
  const wrap = e.target.closest('.teamwrap');
  if(wrap && wrap.dataset.team){
    renderSelectedPlayer(wrap.dataset.team);
  }
});

/* ====== Controller ====== */
async function run(selectedKeys){
  if(!selectedKeys||!selectedKeys.length) selectedKeys=['All'];
  const {matches, leagues, perLeague, scheduledTotal} = await loadAll(selectedKeys);
  const agg = aggregate(matches);
  const minis = leagueAggregates(perLeague);
  const activity = computeActivity(matches);

  // index teams (incl. results) for the profile & flyout
  TEAM_INDEX = new Map();
  agg.teams.forEach(t => TEAM_INDEX.set(t.team, t));

  renderRails(agg, leagues, scheduledTotal, activity);
  renderLeaderboard(agg.teams);
  renderHighlights(agg);
  renderTopTables(agg.teams);
  renderMini(minis);
}

(function boot(){
  renderBadges();
  run(['All']);
})();
</script>
</body>
</html>
