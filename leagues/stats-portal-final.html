<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>eFPL Season 2 - Live Stats</title>
<meta name="description" content="Live eFPL Season 2 stats across Diamond, Ruby, Sapphire, Crystal, Gold, and Emerald leagues: matches, goals, standings, biggest wins and more." />
<link rel="icon" href="https://efpl-assets.pages.dev/img/logo.png" />
<link rel="preconnect" href="https://docs.google.com" crossorigin>
<link rel="preconnect" href="https://www.google.com" crossorigin>
<link rel="preconnect" href="https://efpl-assets.pages.dev" crossorigin>

<style>
:root{
  --bg:#0b1636; --card:#0f1e49; --card2:#13265b;
  --ink:#fff;   --muted:#b8c6e3; --accent:#f9d71c;
  --line:rgba(249,215,28,.3);
  --ok:#2fbf71; --mid:#9aa4b2; --away:#5aa4ff;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:15.5px/1.55 system-ui,Segoe UI,Roboto,Arial,sans-serif}

/* layout */
.wrap{max-width:1220px;margin:0 auto;padding:16px 16px 28px;width:100%}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;width:100%}
.hdr{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0}
.brand{display:flex;align-items:center;gap:10px}
.brand img{height:36px;width:auto;border-radius:8px;object-fit:contain}
.brand h1{margin:0;font-size:18px;letter-spacing:.4px}
.eyebrow{display:inline-block;background:var(--accent);color:#0b1b3d;padding:2px 8px;border-radius:999px;font-weight:900;font-size:11px}

.badges{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0 12px}
.badge{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:6px 10px;display:flex;align-items:center;gap:8px;cursor:pointer}
.badge img{height:22px;width:auto;display:block;object-fit:contain}
.badge.active{background:var(--accent);color:#0b1b3d;border-color:transparent}

.rail{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kpi{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}
.kpi .t{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
.kpi .v{font-weight:900;font-size:20px}

.mini{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px}

/* bars */
.bar{height:10px;border-radius:999px;background:rgba(255,255,255,.06);overflow:hidden;border:1px solid var(--line);display:flex;align-items:stretch}
.seg{height:100%;display:block}
.home{background:var(--ok)} .draw{background:var(--mid)} .away{background:var(--away)}

/* tables */
table{width:100%;border-collapse:collapse;table-layout:fixed}
thead th{background:var(--accent);color:#0b1b3d;padding:10px;font-size:12px;text-transform:uppercase;letter-spacing:.03em}
tbody td{padding:10px 12px;font-weight:600;white-space:nowrap;overflow:visible;text-overflow:clip}
tbody tr:nth-child(odd){background:var(--card)} tbody tr:nth-child(even){background:var(--card2)}
.left{text-align:left} .center{text-align:center}
.right{text-align:right;font-variant-numeric:tabular-nums;font-feature-settings:"tnum" 1}

/* team + badge */
.teamname{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:inline-block;max-width:100%}
.lg{height:28px;width:auto;vertical-align:middle;margin-right:8px;object-fit:contain;filter:drop-shadow(0 0 3px rgba(0,0,0,.6))}

/* Leaderboard desktop widths */
#tbl-leader col.c-rank{width:6%}
#tbl-leader col.c-team{width:42%}
#tbl-leader col.c-gp, #tbl-leader col.c-w, #tbl-leader col.c-d, #tbl-leader col.c-l{width:6%}
#tbl-leader col.c-gf, #tbl-leader col.c-ga, #tbl-leader col.c-gd, #tbl-leader col.c-pts{width:7%}
#tbl-leader td.right:first-child{padding-right:14px}

/* Highlights table wraps (never ellipsis) */
#tbl-hi{table-layout:auto;width:100%}
#tbl-hi td{white-space:normal;overflow:visible;text-overflow:clip;line-height:1.35;padding:10px 12px}
#tbl-hi td.right{text-align:right}

/* Top tables desktop widths */
#tbl-gf, #tbl-ga{width:100%;table-layout:fixed}
#tbl-gf col.c-rank, #tbl-ga col.c-rank{width:6%}
#tbl-gf col.c-team, #tbl-ga col.c-team{width:46%}
#tbl-gf col.c-gp,   #tbl-ga col.c-gp{width:10%}
#tbl-gf col.c-gf{width:12%}  #tbl-ga col.c-ga{width:12%}
#tbl-gf col.c-gd,  #tbl-ga col.c-gd{width:12%}
#tbl-gf col.c-pts, #tbl-ga col.c-pts{width:14%}
#tbl-gf td, #tbl-ga td{overflow:visible;text-overflow:clip}
#tbl-gf td.left .teamname, #tbl-ga td.left .teamname{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:inline-block;max-width:100%}

/* ====== responsive ====== */

/* stack columns on tablets/phones, simplify tables */
@media (max-width:900px){
  .two-col{grid-template-columns:1fr;gap:12px}

  /* Leaderboard: hide GA & GD, let table auto fill width */
  #tbl-leader th:nth-child(8), #tbl-leader td:nth-child(8),
  #tbl-leader th:nth-child(9), #tbl-leader td:nth-child(9){display:none !important}
  #tbl-leader col.c-ga, #tbl-leader col.c-gd{display:none !important}
  #tbl-leader{table-layout:auto}
  #tbl-leader col.c-rank{width:7% !important}
  #tbl-leader col.c-team{width:50% !important}

  thead th{padding:8px;font-size:12px}
  tbody td{padding:8px 8px;font-size:14px}
  .lg{height:22px;margin-right:6px}

  /* Top scoring / Best defence: hide GP & GD */
  #tbl-gf th:nth-child(3), #tbl-gf td:nth-child(3),
  #tbl-gf th:nth-child(5), #tbl-gf td:nth-child(5){display:none !important}
  #tbl-gf col.c-gp, #tbl-gf col.c-gd{display:none !important}

  #tbl-ga th:nth-child(3), #tbl-ga td:nth-child(3),
  #tbl-ga th:nth-child(5), #tbl-ga td:nth-child(5){display:none !important}
  #tbl-ga col.c-gp, #tbl-ga col.c-gd{display:none !important}

  #tbl-gf, #tbl-ga{table-layout:auto}
  #tbl-gf col.c-rank, #tbl-ga col.c-rank{width:8% !important}
  #tbl-gf col.c-team, #tbl-ga col.c-team{width:58% !important}
}

/* phones: compact Leaderboard: # Team W D L GD Pts */
@media (max-width:420px){
  #tbl-leader thead{display:none}
  /* hide GP & GF; GA already hidden at 900 */
  #tbl-leader td:nth-child(3), #tbl-leader td:nth-child(7){display:none !important}
  #tbl-leader col.c-gp, #tbl-leader col.c-gf{display:none !important}

  /* per-row grid mapping to avoid smashed headers */
  #tbl-leader tbody tr{display:grid;grid-template-columns:2.8ch 1fr 2.6ch 2.6ch 2.6ch 3.2ch 3.2ch;column-gap:10px;align-items:center}
  #tbl-leader td:nth-child(1){grid-column:1;text-align:right;padding-right:6px}
  #tbl-leader td:nth-child(2){grid-column:2}
  #tbl-leader td:nth-child(4){grid-column:3;text-align:center}
  #tbl-leader td:nth-child(5){grid-column:4;text-align:center}
  #tbl-leader td:nth-child(6){grid-column:5;text-align:center}
  #tbl-leader td:nth-child(9){grid-column:6;text-align:center}
  #tbl-leader td:nth-child(10){grid-column:7;text-align:right;font-weight:800}

  #tbl-leader tbody td{font-size:13px;padding:8px 8px}
  .lg{height:20px;margin-right:6px}
  .teamname{max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* Top tables: give team more room */
  #tbl-gf col.c-rank, #tbl-ga col.c-rank{width:8% !important}
  #tbl-gf col.c-team, #tbl-ga col.c-team{width:64% !important}
}

/* foot */
details{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}
summary{cursor:pointer;font-weight:900}
summary::marker{content:""} summary::after{content:"▾";margin-left:6px}
details[open] summary::after{content:"▴"}
.note{color:var(--muted);font-size:12.5px}
.foot{display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-top:14px;color:var(--muted);font-size:12.5px}
</style>
</head>
<body>
  <div class="wrap">
    <header class="hdr">
      <div class="brand">
        <img src="https://efpl-assets.pages.dev/img/logo.png" alt="eFPL logo" />
        <div>
          <div class="eyebrow">Season 2</div>
          <h1>eFPL Live Stats</h1>
        </div>
      </div>
      <div id="updated" class="eyebrow">Loading...</div>
    </header>

    <nav class="badges" id="badges"></nav>

    <section class="rail">
      <div class="kpi"><div class="t">Matches</div><div class="v" id="kpi-matches">-</div></div>
      <div class="kpi"><div class="t">Goals</div><div class="v" id="kpi-goals">-</div></div>
      <div class="kpi"><div class="t">Avg / match</div><div class="v" id="kpi-avg">-</div></div>
      <div class="kpi"><div class="t">Leagues</div><div class="v" id="kpi-leagues">-</div></div>
    </section>

    <section class="mini" style="margin-top:10px">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <strong>Result split</strong><span id="split-text" class="note">-</span>
        </div>
        <div class="bar"><span id="seg-home" class="seg home" style="width:0%"></span><span id="seg-draw" class="seg draw" style="width:0%"></span><span id="seg-away" class="seg away" style="width:0%"></span></div>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <strong>Completion</strong><span id="prog-text" class="note">-</span>
        </div>
        <div class="bar"><span id="seg-prog" class="seg" style="width:0%;background:linear-gradient(90deg,#ffd03b,#f9d71c)"></span></div>
      </div>
    </section>

    <section class="two-col" style="margin-top:10px">
      <div class="card">
        <h3 style="margin:0 0 8px">Leaderboard</h3>
        <table id="tbl-leader" aria-label="Leaderboard">
          <colgroup>
            <col class="c-rank"><col class="c-team">
            <col class="c-gp"><col class="c-w"><col class="c-d"><col class="c-l">
            <col class="c-gf"><col class="c-ga"><col class="c-gd"><col class="c-pts">
          </colgroup>
          <thead><tr>
            <th>#</th><th class="left">Team</th><th>GP</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">Highlights</h3>
        <table id="tbl-hi" aria-label="Highlights">
          <tbody>
            <tr><td class="left">Biggest win</td><td id="hi-big" class="right">-</td></tr>
            <tr><td class="left">Highest scoring game</td><td id="hi-hsg" class="right">-</td></tr>
            <tr><td class="left">Top scoring team</td><td id="hi-topgf" class="right">-</td></tr>
            <tr><td class="left">Most conceded</td><td id="hi-mostga" class="right">-</td></tr>
            <tr><td class="left">Most clean sheets</td><td id="hi-mostcs" class="right">-</td></tr>
          </tbody>
        </table>

        <details style="margin-top:10px">
          <summary>More tables</summary>
          <div style="margin-top:8px">
            <div class="card" style="margin-bottom:8px">
              <strong>Top scoring teams (Top 10)</strong>
              <table id="tbl-gf" style="margin-top:6px" aria-label="Top scoring teams">
                <colgroup>
                  <col class="c-rank"><col class="c-team">
                  <col class="c-gp"><col class="c-gf"><col class="c-gd"><col class="c-pts">
                </colgroup>
                <thead><tr><th>#</th><th class="left">Team</th><th>GP</th><th>GF</th><th>GD</th><th>Pts</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="card">
              <strong>Best defence (Top 10)</strong>
              <table id="tbl-ga" style="margin-top:6px" aria-label="Best defence">
                <colgroup>
                  <col class="c-rank"><col class="c-team">
                  <col class="c-gp"><col class="c-ga"><col class="c-gd"><col class="c-pts">
                </colgroup>
                <thead><tr><th>#</th><th class="left">Team</th><th>GP</th><th>GA</th><th>GD</th><th>Pts</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </details>
      </div>
    </section>

    <section class="card" style="margin-top:10px">
      <h3 style="margin:0 0 8px">Per-league comparison</h3>
      <div id="league-mini" class="mini"></div>
      <div class="note">Each card: Avg goals • Home/Draw/Away % • Completion %.</div>
    </section>

    <footer class="foot">
      <span>All statistics are compiled and produced by eFPL.</span>
      <span id="foot-scope">Scope: All Leagues</span>
    </footer>
  </div>

<script>
/* ===== config ===== */
const LEAGUES = [
  { key:'All', name:'All Leagues', id:null, badge:null },
  { key:'Diamond',  name:'Diamond',  id:'1vkDOFfwBJJnSHOPM0BFcrNyZd-2nIbiDKNnWGKT3OP0', badge:'Diamond-League.png' },
  { key:'Ruby',     name:'Ruby',     id:'12Qg5yi3yQtsPSrd6EHxROkPNurVn5ylzELPvU4UOmGU', badge:'Ruby-League.png' },
  { key:'Sapphire', name:'Sapphire', id:'1qa03hOquzVg8ithFLdhrel2O3k3nTQCQZp81AWFvECg', badge:'Sapphire-League.png' },
  { key:'Crystal',  name:'Crystal',  id:'1LqRM7ICWpENmsKH5tTuu7Bf7VQa7YoJ-9TAivruymvo', badge:'Crystal-League.png' },
  { key:'Emerald',  name:'Emerald',  id:'1rD_03y276wGjjlukus6icgwq_FPcOgc70654dOOG6sg', badge:'Emerald-League.png' },
  { key:'Gold',     name:'Gold',     id:'1ACOQ3dffrjczk1LmBmPiC-wV37t9nQKEDwApOEEeFU8', badge:'Gold-League.png' },
];
const BADGE_BASE = 'https://efpl-assets.pages.dev/img/leagues/';
const FX_TAB='Fixtures', FX_RANGE='C4:I94';
const EM_TAB='Embed',    EM_RANGE='A15:C105';
const BUCKET_MS=5*60*1000, CB=Math.floor(Date.now()/BUCKET_MS);

/* ===== utils ===== */
const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const parseGviz = txt => { const a=txt.indexOf('{'), b=txt.lastIndexOf('}'); if(a<0||b<0) throw new Error('Bad GViz'); return JSON.parse(txt.slice(a,b+1)); };
const num = x => { const n=Number(x); return Number.isFinite(n)?n:null; };
const truthy = v => v===true || String(v).toLowerCase()==='true' || v==='☑';
const pct = (p,t) => t?((p*100/t).toFixed(1)+'%'):'0.0%';
const fmt = n => Number.isFinite(n)?n.toLocaleString():'0';
const byId = id => document.getElementById(id);
const safeDate = v => { const d=new Date(v); return isNaN(d)?null:d; };

async function fetchRange(id, sheet, range){
  const url=`https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}&range=${encodeURIComponent(range)}&cachebust=${CB}`;
  const res=await fetch(url); const txt=await res.text();
  if(!res.ok) throw new Error(res.status+' '+txt.slice(0,160));
  return parseGviz(txt);
}

async function fromFixtures(id){
  const data=await fetchRange(id, FX_TAB, FX_RANGE);
  const rows=(data.table.rows||[]).map(r=>(r.c||[]).map(c=>c?c.v:''));
  let scheduled=0;
  const items=rows.map(c=>{
    const home=c[0]??'', hg=num(c[1]), ag=num(c[3]), away=c[4]??'', completed=truthy(c[5]), doneOn=safeDate(c[6]);
    if(home&&away) scheduled++;
    return {home,away,hg,ag,completed,doneOn};
  });
  return {items, scheduled};
}
async function fromEmbed(id){
  const data=await fetchRange(id, EM_TAB, EM_RANGE);
  const rows=(data.table.rows||[]).map(r=>(r.c||[]).map(c=>c?c.v:'')).filter(r=>!r.every(x=>String(x).trim()===''));
  const scheduled=rows.filter(r=>(r[0]||'').trim()&&(r[2]||'').trim()).length;
  const items=rows.map(r=>{
    const m=String(r[1]??'').replace(/[^0-9\-]/g,'').trim().match(/^(\d+)\s*-\s*(\d+)$/);
    return {home:r[0]??'', away:r[2]??'', hg:m?Number(m[1]):null, ag:m?Number(m[2]):null, completed:!!m, doneOn:null};
  });
  return {items, scheduled};
}

async function loadLeague(lg){
  try{
    const fx=await fromFixtures(lg.id);
    const played=fx.items.filter(r=>r.completed && Number.isFinite(r.hg) && Number.isFinite(r.ag))
                         .map(r=>({league:lg.key,home:r.home,away:r.away,hg:r.hg,ag:r.ag,doneOn:r.doneOn}));
    if(played.length) return {matches:played, scheduled:fx.scheduled};
  }catch(_){}
  try{
    const em=await fromEmbed(lg.id);
    const played=em.items.filter(r=>r.completed && Number.isFinite(r.hg) && Number.isFinite(r.ag))
                         .map(r=>({league:lg.key,home:r.home,away:r.away,hg:r.hg,ag:r.ag,doneOn:null}));
    return {matches:played, scheduled:em.scheduled};
  }catch(_){}
  return {matches:[], scheduled:0};
}

async function loadAll(selectedKeys){
  const selected = (selectedKeys.includes('All')? LEAGUES.filter(x=>x.id) : LEAGUES.filter(x=>x.id && selectedKeys.includes(x.key)));
  const results = await Promise.allSettled(selected.map(loadLeague));

  const matches=[]; const perLeague={}; let scheduledTotal=0;
  selected.forEach((lg,i)=>{
    const r=results[i].status==='fulfilled'?results[i].value:{matches:[],scheduled:0};
    perLeague[lg.key]={matches:r.matches, scheduled:r.scheduled};
    scheduledTotal+=r.scheduled;
    matches.push(...r.matches);
  });
  return {matches, leagues:selected.map(x=>x.key), perLeague, scheduledTotal};
}

/* aggregates */
function aggregate(matches){
  const played=matches.length;
  let goals=0, homeW=0, draw=0, awayW=0, biggest=null, highest=null;
  const teams=new Map();
  const add=t=>teams.get(t)||teams.set(t,{team:t,league:null,gp:0,w:0,d:0,l:0,gf:0,ga:0,gd:0,pts:0,cs:0}).get(t);

  for(const m of matches){
    goals+=m.hg+m.ag;
    if(m.hg>m.ag) homeW++; else if(m.hg<m.ag) awayW++; else draw++;

    const diff=Math.abs(m.hg-m.ag);
    if(!biggest||diff>biggest.diff){
      biggest={diff,text:(m.hg>=m.ag?`${m.home} ${m.hg}-${m.ag} ${m.away}`:`${m.away} ${m.ag}-${m.hg} ${m.home}`),sub:m.league};
    }
    const total=m.hg+m.ag;
    if(!highest||total>highest.total){ highest={total,text:`${m.home} ${m.hg}-${m.ag} ${m.away}`,sub:m.league}; }

    const H=add(m.home), A=add(m.away);
    if(!H.league) H.league=m.league; if(!A.league) A.league=m.league;
    H.gp++; A.gp++; H.gf+=m.hg; H.ga+=m.ag; A.gf+=m.ag; A.ga+=m.hg;
    if(m.hg>m.ag){ H.w++; H.pts+=3; A.l++; }
    else if(m.hg<m.ag){ A.w++; A.pts+=3; H.l++; }
    else { H.d++; A.d++; H.pts++; A.pts++; }
    if(m.ag===0) H.cs++; if(m.hg===0) A.cs++;
  }

  const list=[...teams.values()].map(t=>{t.gd=t.gf-t.ga; return t;});
  const topGF = list.length? [...list].sort((a,b)=>b.gf-a.gf || a.team.localeCompare(b.team))[0] : null;
  const mostGA = list.length? [...list].sort((a,b)=>b.ga-a.ga || a.team.localeCompare(b.team))[0] : null;
  const mostCS = list.length? [...list].sort((a,b)=>b.cs-a.cs || a.team.localeCompare(b.team))[0] : null;

  return {played,goals,avg:played?goals/played:0,homeW,draw,awayW,teams:list,biggest,highest,topGF,mostGA,mostCS};
}

function leagueAggregates(perLeague){
  const out=[];
  for(const key in perLeague){
    const {matches,scheduled}=perLeague[key];
    const played=matches.length;
    const goals=matches.reduce((s,m)=>s+m.hg+m.ag,0);
    const avg=played?goals/played:0;
    const homeW=matches.filter(m=>m.hg>m.ag).length;
    const draw =matches.filter(m=>m.hg===m.ag).length;
    const awayW=matches.filter(m=>m.hg<m.ag).length;
    out.push({league:key,played,scheduled,avg,homeW,draw,awayW});
  }
  return out.sort((a,b)=>a.league.localeCompare(b.league));
}

/* render */
function renderBadges(){
  const host=byId('badges'); host.innerHTML='';
  const mk=(key,html,active)=>{const d=document.createElement('div'); d.className='badge'+(active?' active':''); d.dataset.key=key; d.innerHTML=html; d.onclick=()=>selectLeague(key); host.appendChild(d);};
  mk('All', `<img src="https://efpl-assets.pages.dev/img/logo.png" alt="All"><span>All</span>`, true);
  LEAGUES.filter(x=>x.id).forEach(lg=> mk(lg.key, `<img src="${BADGE_BASE}${lg.badge}" alt="${esc(lg.key)}"><span>${esc(lg.key)}</span>`, false));
}
function selectLeague(key){
  document.querySelectorAll('.badge').forEach(b=>b.classList.toggle('active', b.dataset.key===key));
  run([key]);
  byId('foot-scope').textContent = 'Scope: ' + (key==='All'?'All Leagues':key);
}
function renderRails(agg, leagues, scheduledTotal){
  byId('kpi-matches').textContent = fmt(agg.played);
  byId('kpi-goals').textContent   = fmt(agg.goals);
  byId('kpi-avg').textContent     = agg.avg.toFixed(2);
  byId('kpi-leagues').textContent = leagues.length;
  byId('split-text').textContent  = `${fmt(agg.homeW)} H • ${fmt(agg.draw)} D • ${fmt(agg.awayW)} A • ${pct(agg.homeW,agg.played)} / ${pct(agg.draw,agg.played)} / ${pct(agg.awayW,agg.played)}`;
  byId('seg-home').style.width = (agg.played?agg.homeW*100/agg.played:0)+'%';
  byId('seg-draw').style.width = (agg.played?agg.draw*100/agg.played:0)+'%';
  byId('seg-away').style.width = (agg.played?agg.awayW*100/agg.played:0)+'%';
  byId('prog-text').textContent = scheduledTotal? `${fmt(agg.played)} / ${fmt(scheduledTotal)} • ${pct(agg.played,scheduledTotal)}` : '0 / 0 • 0.0%';
  byId('seg-prog').style.width = scheduledTotal? (agg.played*100/scheduledTotal)+'%' : '0%';
  const up=byId('updated'); if(up) up.textContent='Updated '+new Date().toLocaleString();
}
const teamCell = t => `<img class="lg" src="${BADGE_BASE}${(t.league||'Diamond')}-League.png" alt="${esc(t.league||'Diamond')}"><span class="teamname" title="${esc(t.team)}">${esc(t.team)}</span>`;
function renderLeaderboard(teams){
  const tbody=byId('tbl-leader').querySelector('tbody'); tbody.innerHTML='';
  const rows=[...teams].sort((a,b)=> b.pts-a.pts || b.gd-a.gd || b.gf-a.gf || a.team.localeCompare(b.team));
  for(let i=0;i<rows.length;i++){
    const t=rows[i]; const tr=document.createElement('tr');
    tr.innerHTML=`<td class="right">${i+1}</td><td class="left">${teamCell(t)}</td>
      <td class="right">${t.gp}</td><td class="right">${t.w}</td><td class="right">${t.d}</td><td class="right">${t.l}</td>
      <td class="right">${t.gf}</td><td class="right">${t.ga}</td><td class="right">${t.gd}</td><td class="right"><strong>${t.pts}</strong></td>`;
    tbody.appendChild(tr);
  }
}
function renderHighlights(agg){
  byId('hi-big').textContent   = agg.biggest ? `${agg.biggest.text} (${agg.biggest.sub})` : '-';
  byId('hi-hsg').textContent   = agg.highest ? `${agg.highest.text} (${agg.highest.total} goals • ${agg.highest.sub})` : '-';
  byId('hi-topgf').textContent = agg.topGF ? `${agg.topGF.team} - ${agg.topGF.gf}` : '-';
  byId('hi-mostga').textContent= agg.mostGA ? `${agg.mostGA.team} - ${agg.mostGA.ga}` : '-';
  byId('hi-mostcs').textContent= agg.mostCS ? `${agg.mostCS.team} - ${agg.mostCS.cs}` : '-';
}
function renderTopTables(teams){
  const gf=[...teams].sort((a,b)=> b.gf-a.gf || a.team.localeCompare(b.team)).slice(0,10);
  const ga=[...teams].sort((a,b)=> a.ga-b.ga || a.team.localeCompare(b.team)).slice(0,10);
  const gfBody=byId('tbl-gf').querySelector('tbody'); gfBody.innerHTML='';
  const gaBody=byId('tbl-ga').querySelector('tbody'); gaBody.innerHTML='';
  gf.forEach((t,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td class="right">${i+1}</td><td class="left">${teamCell(t)}</td><td class="right">${t.gp}</td><td class="right">${t.gf}</td><td class="right">${t.gd}</td><td class="right">${t.pts}</td>`; gfBody.appendChild(tr); });
  ga.forEach((t,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td class="right">${i+1}</td><td class="left">${teamCell(t)}</td><td class="right">${t.gp}</td><td class="right">${t.ga}</td><td class="right">${t.gd}</td><td class="right">${t.pts}</td>`; gaBody.appendChild(tr); });
}

/* controller */
async function run(selectedKeys=['All']){
  const {matches, leagues, perLeague, scheduledTotal}=await loadAll(selectedKeys);
  const agg = aggregate(matches);
  renderRails(agg, leagues, scheduledTotal);
  renderLeaderboard(agg.teams);
  renderHighlights(agg);
  renderTopTables(agg.teams);
  renderMini(leagueAggregates(perLeague));
}
function renderMini(minis){
  const host=byId('league-mini'); host.innerHTML='';
  minis.forEach(m=>{
    const line = `${m.played?m.avg.toFixed(2):'0.00'} avg • ${pct(m.homeW,m.played)} / ${pct(m.draw,m.played)} / ${pct(m.awayW,m.played)} • ${pct(m.played,m.scheduled||0)}`;
    const div=document.createElement('div'); div.className='badge'; div.style.width='100%';
    div.innerHTML=`<img src="${BADGE_BASE}${m.league}-League.png" alt="${esc(m.league)}"><div><div><strong>${esc(m.league)}</strong></div><div class="note">${line}</div></div>`;
    host.appendChild(div);
  });
}
(function boot(){ renderBadges(); run(['All']); })();
</script>
</body>
</html>