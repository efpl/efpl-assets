<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>eFPL ‚Äî Season 2 Master Stats (Compact)</title>
<meta name="description" content="Live eFPL Season 2 stats across Diamond, Ruby, Sapphire, Crystal, Gold, and Emerald leagues. Biggest wins, top scoring teams, clean sheets, league comparison and more." />
<link rel="icon" href="https://efpl-assets.pages.dev/img/logo.png" />

<style>
  :root{
    --bg:#0b1636; --card:#0f1e49; --card2:#13265b;
    --row1:#101e46; --row2:#0f1c41; --hover:#182a5e;
    --ink:#ffffff; --muted:#b8c6e3; --accent:#f9d71c; --ink-dark:#0b1b3d;
    --line:rgba(249,215,28,.28);
    --ok:#2fbf71; --mid:#9aa4b2; --away:#5aa4ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 system-ui,Segoe UI,Roboto,Arial,sans-serif}

  .wrap{max-width:1160px;margin:0 auto;padding:16px 16px 28px}

  /* Header (fix: no squish) */
  .hdr{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 0 10px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand .logo{
    height:40px; width:auto; /* keep natural aspect ratio */
    display:block; object-fit:contain; image-rendering:auto;
  }
  .brand h1{margin:0;font-size:18px;font-weight:900;letter-spacing:.3px}
  .eyebrow{display:inline-block;background:var(--accent);color:var(--ink-dark);padding:2px 8px;border-radius:999px;font-weight:900;font-size:11px}

  /* Filters (fix: badge ratio) */
  .filters{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 12px}
  .chip, .badge{border:1px solid var(--line);border-radius:12px;padding:6px 10px;background:var(--card);display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none}
  .badge img{height:22px;width:auto;display:block;object-fit:contain} /* no squish */
  .badge.active{background:var(--accent);color:var(--ink-dark);border-color:transparent}

  /* Grid + cards */
  .grid{display:grid;gap:10px}
  @media (min-width:820px){ .grid{grid-template-columns:repeat(12,1fr)} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}

  /* KPIs (same IDs as full version) */
  .kpi{grid-column:span 6}
  .kpi.big{grid-column:span 6}
  .kpi h3{margin:0 0 4px;font-size:12px;text-transform:uppercase;color:var(--muted);letter-spacing:.04em}
  .kpi .val{font-size:20px;font-weight:900}
  .kpi .sub{color:var(--muted);font-weight:700}
  @media (min-width:820px){ .kpi{grid-column:span 3} .kpi.big{grid-column:span 6} }

  /* Tables */
  table{width:100%;border-collapse:collapse}
  thead th{
    background:var(--accent);color:var(--ink-dark);
    font-size:12px;text-transform:uppercase;letter-spacing:.03em;
    padding:8px;text-align:center
  }
  tbody td{padding:8px;text-align:center;font-weight:600}
  tbody tr:nth-child(odd){background:var(--row1)}
  tbody tr:nth-child(even){background:var(--row2)}
  tbody tr:hover{background:var(--hover)}
  .tbl-card{grid-column:1/-1}
  .tbl-card h2{margin:0 0 8px;font-size:17px}
  .left{text-align:left}.right{text-align:right}

  /* Bars */
  .segbar,.bar{height:10px;border-radius:999px;overflow:hidden;background:rgba(255,255,255,.06);border:1px solid var(--line)}
  .seg{height:100%;display:inline-block}
  .home{background:var(--ok)} .draw{background:var(--mid)} .away{background:var(--away)}

  /* Skeleton + fades */
  .skeleton{background:linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.12), rgba(255,255,255,.05));
    background-size:200% 100%;animation:sk 1.1s infinite;border-radius:12px;min-height:120px}
  @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .fade{opacity:0;transition:opacity .18s ease}
  .fade.ready{opacity:1}

  .note{color:var(--muted);font-size:12.5px;margin-top:6px}

  /* Collapsibles (compact) */
  details{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}
  summary{cursor:pointer;font-weight:900}
  summary::marker{content:""}
  summary::after{content:"‚ñæ";margin-left:6px}
  details[open] summary::after{content:"‚ñ¥"}

  /* Footer */
  .foot{display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-top:14px;color:var(--muted);font-size:12.5px}
</style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <header class="hdr">
      <div class="brand">
        <img class="logo" src="https://efpl-assets.pages.dev/img/logo.png" alt="eFPL">
        <div>
          <div class="eyebrow">Season 2</div>
          <h1>eFPL Master Stats (Compact)</h1>
        </div>
      </div>
      <div id="updated" class="eyebrow">Loading‚Ä¶</div>
    </header>

    <!-- League badges (no squish) -->
    <nav class="filters" id="filters"></nav>

    <!-- KPIs (same IDs as ‚Äúfull‚Äù version) -->
    <div class="grid" id="kpi-grid">
      <div class="card kpi"><h3>Matches played</h3><div class="val" id="kpi-matches">‚Äî</div></div>
      <div class="card kpi"><h3>Total goals</h3><div class="val" id="kpi-goals">‚Äî</div></div>
      <div class="card kpi"><h3>Avg goals per match</h3><div class="val" id="kpi-avg">‚Äî</div></div>
      <div class="card kpi"><h3>Leagues included</h3><div class="val" id="kpi-leagues">‚Äî</div></div>

      <div class="card kpi big">
        <h3>Result split</h3>
        <div class="val" id="kpi-split">‚Äî</div>
        <div class="segbar" aria-hidden="true">
          <span id="seg-home" class="seg home" style="width:0%"></span>
          <span id="seg-draw" class="seg draw" style="width:0%"></span>
          <span id="seg-away" class="seg away" style="width:0%"></span>
        </div>
        <div class="sub" id="kpi-split-sub"></div>
      </div>

      <div class="card kpi big">
        <h3>Total games completed</h3>
        <div class="val" id="kpi-progress">‚Äî</div>
        <div class="sub" id="kpi-progress-sub"></div>
      </div>

      <div class="card kpi">
        <h3>Biggest win</h3>
        <div class="val" id="kpi-biggest">‚Äî</div>
        <div class="sub" id="kpi-biggest-sub"></div>
      </div>

      <div class="card kpi">
        <h3>Highest scoring game</h3>
        <div class="val" id="kpi-hsg">‚Äî</div>
        <div class="sub" id="kpi-hsg-sub"></div>
      </div>

      <div class="card kpi">
        <h3>Top scoring team</h3>
        <div class="val" id="kpi-topgf">‚Äî</div>
        <div class="sub" id="kpi-topgf-sub"></div>
      </div>

      <div class="card kpi">
        <h3>Most goals conceded</h3>
        <div class="val" id="kpi-mostga">‚Äî</div>
        <div class="sub" id="kpi-mostga-sub"></div>
      </div>

      <div class="card kpi">
        <h3>Most clean sheets</h3>
        <div class="val" id="kpi-cleansheets">‚Äî</div>
        <div class="sub" id="kpi-cleansheets-sub"></div>
      </div>
    </div>

    <!-- Per-league comparison (compact cards) -->
    <div class="grid" style="margin-top:10px">
      <div class="card tbl-card">
        <h2>Per-league comparison</h2>
        <div class="filters" id="league-mini"></div>
        <div class="note">Each card: Avg goals ‚Ä¢ Home/Draw/Away % ‚Ä¢ Completion %.</div>
      </div>
    </div>

    <!-- Leaderboards -->
    <div class="grid" style="margin-top:10px">
      <div class="card tbl-card fade" id="leaderboard-card">
        <h2>Team leaderboard</h2>
        <div class="skeleton" id="sk-leader"></div>
        <table id="tbl-leader" style="display:none"></table>
      </div>

      <div class="card tbl-card fade" id="gf-card">
        <h2>Top scoring teams</h2>
        <div class="skeleton" id="sk-gf"></div>
        <table id="tbl-gf" style="display:none"></table>
      </div>

      <div class="card tbl-card fade" id="ga-card">
        <h2>Best defence (fewest conceded)</h2>
        <div class="skeleton" id="sk-ga"></div>
        <table id="tbl-ga" style="display:none"></table>
      </div>

      <div class="card tbl-card fade" id="cs-card">
        <h2>Clean sheet leaders</h2>
        <div class="skeleton" id="sk-cs"></div>
        <table id="tbl-cs" style="display:none"></table>
      </div>
    </div>

    <!-- Optional extras as collapsibles (kept but compact) -->
    <div class="grid" style="margin-top:10px">
      <details class="tbl-card" id="timeline-card" style="display:none">
        <summary>Goals timeline</summary>
        <div class="card" style="margin-top:8px">
          <div class="note">Uses ‚ÄúCompleted On‚Äù from Fixtures. Hidden if dates aren‚Äôt available.</div>
          <div style="width:100%;height:240px"><canvas id="goals-canvas" width="800" height="260"></canvas></div>
        </div>
      </details>
    </div>

    <div class="grid" style="margin-top:10px">
      <details class="tbl-card" id="form-card" style="display:none">
        <summary>Form table (last 5)</summary>
        <div class="card" style="margin-top:8px">
          <table id="tbl-form"></table>
          <div class="note">Order uses ‚ÄúCompleted On‚Äù. Hidden if dates aren‚Äôt available.</div>
        </div>
      </details>
    </div>

    <footer class="foot">
      <span>Live from Google Sheets (Fixtures & Embed).</span>
      <span id="foot-scope">Scope: All Leagues</span>
    </footer>
  </div>

<script>
/* ========= CONFIG ========= */
const LEAGUES = [
  { key:'All',      name:'All Leagues', id:null, badge:null }, // synthetic
  { key:'Diamond',  name:'Diamond',  id:'1vkDOFfwBJJnSHOPM0BFcrNyZd-2nIbiDKNnWGKT3OP0', badge:'Diamond-League.png' },
  { key:'Ruby',     name:'Ruby',     id:'12Qg5yi3yQtsPSrd6EHxROkPNurVn5ylzELPvU4UOmGU', badge:'Ruby-League.png' },
  { key:'Sapphire', name:'Sapphire', id:'1qa03hOquzVg8ithFLdhrel2O3k3nTQCQZp81AWFvECg', badge:'Sapphire-League.png' },
  { key:'Crystal',  name:'Crystal',  id:'1LqRM7ICWpENmsKH5tTuu7Bf7VQa7YoJ-9TAivruymvo', badge:'Crystal-League.png' },
  { key:'Emerald',  name:'Emerald',  id:'1rD_03y276wGjjlukus6icgwq_FPcOgc70654dOOG6sg', badge:'Emerald-League.png' },
  { key:'Gold',     name:'Gold',     id:'1ACOQ3dffrjczk1LmBmPiC-wV37t9nQKEDwApOEEeFU8', badge:'Gold-League.png' },
];
const BADGE_BASE = 'https://efpl-assets.pages.dev/img/leagues/';

const FX_TAB='Fixtures', FX_RANGE='C4:I94'; // Home|HG|-|AG|Away|Completed|Completed On
const EM_TAB='Embed',    EM_RANGE='A15:C105';
const BUCKET_MS=5*60*1000, CB=Math.floor(Date.now()/BUCKET_MS);

/* ========= Helpers ========= */
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function parseGviz(txt){const a=txt.indexOf('{'),b=txt.lastIndexOf('}');if(a===-1||b===-1)throw new Error('Bad GViz');return JSON.parse(txt.slice(a,b+1))}
function num(x){const n=Number(x);return Number.isFinite(n)?n:null}
function truthy(v){return v===true || String(v).toLowerCase()==='true' || v==='‚òë'}
function pct(p,t){return t?((p*100/t).toFixed(1)+'%'):'0.0%'}
function fmt(n){return Number.isFinite(n)?n.toLocaleString():'0'}
function set(id,txt){const el=document.getElementById(id); if(el) el.textContent=txt;}
function safeDate(v){const d=new Date(v); return isNaN(d.getTime())?null:d}
function $(id){return document.getElementById(id)}

/* ========= Fetchers ========= */
async function fetchRange(id, sheet, range){
  const url=`https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}&range=${encodeURIComponent(range)}&cachebust=${CB}`;
  const res=await fetch(url); const txt=await res.text();
  if(!res.ok) throw new Error(res.status+' '+txt.slice(0,180));
  return parseGviz(txt);
}
async function loadFromFixtures(id){
  const data=await fetchRange(id, FX_TAB, FX_RANGE);
  const rows=(data.table.rows||[]).map(r=>(r.c||[]).map(c=>c?c.v:''));
  let scheduled=0;
  const items=rows.map(c=>{
    const home=c[0]??'', hg=num(c[1]), ag=num(c[3]), away=c[4]??'', completed=truthy(c[5]), doneOn=safeDate(c[6]);
    if(home&&away) scheduled++;
    return {home,away,hg,ag,completed,doneOn};
  });
  return {items, scheduled};
}
async function loadFromEmbed(id){
  const data=await fetchRange(id, EM_TAB, EM_RANGE);
  const rows=(data.table.rows||[]).map(r=>(r.c||[]).map(c=>c?c.v:'')).filter(r=>r && !r.every(x => String(x).trim()===''));
  const scheduled=rows.filter(r=>(r[0]||'').trim() && (r[2]||'').trim()).length;
  const items=rows.map(r=>{
    const mid=r[1]??'', clean=String(mid).replace(/[^0-9\-]/g,'').trim();
    const m=clean.match(/^(\d+)\s*-\s*(\d+)$/);
    return {home:r[0]??'', away:r[2]??'', hg:m?Number(m[1]):null, ag:m?Number(m[2]):null, completed:!!m, doneOn:null};
  });
  return {items, scheduled};
}
async function loadAll(selectedKeys){
  const selected = selectedKeys.includes('All') ? LEAGUES.filter(x=>x.id) : LEAGUES.filter(x=>x.id && selectedKeys.includes(x.key));
  const matches=[]; let scheduledTotal=0; const perLeague={};
  for(const lg of selected){
    perLeague[lg.key]={matches:[],scheduled:0};
    let gotAny=false;
    try{
      const {items,scheduled}=await loadFromFixtures(lg.id);
      scheduledTotal+=scheduled; perLeague[lg.key].scheduled+=scheduled;
      items.forEach(r=>{
        if(r.completed && Number.isFinite(r.hg) && Number.isFinite(r.ag)){
          const m={league:lg.key,home:r.home,away:r.away,hg:r.hg,ag:r.ag,doneOn:r.doneOn};
          matches.push(m); perLeague[lg.key].matches.push(m); gotAny=true;
        }
      });
      if(gotAny) continue;
    }catch(e){}
    try{
      const {items,scheduled}=await loadFromEmbed(lg.id);
      scheduledTotal+=scheduled; perLeague[lg.key].scheduled+=scheduled;
      items.forEach(r=>{
        if(r.completed && Number.isFinite(r.hg) && Number.isFinite(r.ag)){
          const m={league:lg.key,home:r.home,away:r.away,hg:r.hg,ag:r.ag,doneOn:null};
          matches.push(m); perLeague[lg.key].matches.push(m);
        }
      });
    }catch(e){}
  }
  return {matches, perLeague, scheduledTotal, leagues:selected.map(x=>x.key)};
}

/* ========= Aggregation ========= */
function aggregate(matches){
  const played=matches.length;
  const goals=matches.reduce((s,m)=>s+m.hg+m.ag,0);
  const avg=played?goals/played:0;
  let homeW=0,draw=0,awayW=0;
  let biggest=null, highest=null;

  const T=new Map(); const perTeamMatches={};
  const add=(name)=>{ if(!T.has(name)) T.set(name,{team:name,gp:0,w:0,d:0,l:0,gf:0,ga:0,gd:0,pts:0,cs:0}); return T.get(name); };

  matches.forEach(m=>{
    if(m.hg>m.ag) homeW++; else if(m.hg<m.ag) awayW++; else draw++;
    const diff=Math.abs(m.hg-m.ag);
    if(!biggest || diff>biggest.diff){
      const text=m.hg>=m.ag?`${m.home} ${m.hg}-${m.ag} ${m.away}`:`${m.away} ${m.ag}-${m.hg} ${m.home}`;
      biggest={diff,text,sub:`League: ${m.league}`};
    }
    const total=m.hg+m.ag;
    if(!highest || total>highest.total){
      highest={total,text:`${m.home} ${m.hg}-${m.ag} ${m.away}`,sub:`League: ${m.league}`};
    }
    const H=add(m.home), A=add(m.away);
    H.gp++; A.gp++; H.gf+=m.hg; H.ga+=m.ag; A.gf+=m.ag; A.ga+=m.hg;
    if(m.hg>m.ag){ H.w++; H.pts+=3; A.l++; }
    else if(m.hg<m.ag){ A.w++; A.pts+=3; H.l++; }
    else { H.d++; A.d++; H.pts++; A.pts++; }
    if(m.ag===0) H.cs++; if(m.hg===0) A.cs++;
    (perTeamMatches[m.home] ||= []).push({date:m.doneOn, res: m.hg>m.ag?'W':(m.hg<m.ag?'L':'D')});
    (perTeamMatches[m.away] ||= []).push({date:m.doneOn, res: m.ag>m.hg?'W':(m.ag<m.hg?'L':'D')});
  });

  const teams=Array.from(T.values()).map(t=>({...t,gd:t.gf-t.ga}));
  const topGF=[...teams].sort((a,b)=> b.gf-a.gf || a.team.localeCompare(b.team))[0] || null;
  const mostGA=[...teams].sort((a,b)=> b.ga-a.ga || a.team.localeCompare(b.team))[0] || null;
  const mostCS=[...teams].sort((a,b)=> b.cs-a.cs || a.team.localeCompare(b.team))[0] || null;

  return {played,goals,avg,homeW,draw,awayW,teams,biggest,highest,topGF,mostGA,mostCS,perTeamMatches};
}

function leagueAggregates(perLeague){
  const out=[];
  for(const k of Object.keys(perLeague)){
    const ms=perLeague[k].matches, scheduled=perLeague[k].scheduled;
    const played=ms.length, goals=ms.reduce((s,m)=>s+m.hg+m.ag,0), avg=played?goals/played:0;
    const homeW=ms.filter(m=>m.hg>m.ag).length, draw=ms.filter(m=>m.hg===m.ag).length, awayW=ms.filter(m=>m.hg<m.ag).length;
    out.push({league:k,played,scheduled,avg,homeW,draw,awayW});
  }
  return out.sort((a,b)=>a.league.localeCompare(b.league));
}

/* ========= Rendering ========= */
function renderFilters(){
  const host=$('filters'); host.innerHTML='';
  // All
  const all=document.createElement('div');
  all.className='badge active'; all.dataset.key='All';
  all.innerHTML=`<img src="https://efpl-assets.pages.dev/img/logo.png" alt="All"><span>All</span>`;
  all.onclick=()=>select('All');
  host.appendChild(all);
  // Each league
  LEAGUES.filter(x=>x.id).forEach(l=>{
    const div=document.createElement('div');
    div.className='badge'; div.dataset.key=l.key;
    div.innerHTML=`<img src="${BADGE_BASE}${l.badge}" alt="${esc(l.key)}"><span>${esc(l.key)}</span>`;
    div.onclick=()=>select(l.key);
    host.appendChild(div);
  });
}
function select(key){
  [...document.querySelectorAll('.badge')].forEach(b=>b.classList.toggle('active', b.dataset.key===key));
  run([key]);
  set('foot-scope','Scope: '+(key==='All'?'All Leagues':key));
}

function renderKPIsBase(agg, leagues, scheduledTotal){
  set('kpi-matches', fmt(agg.played));
  set('kpi-goals', fmt(agg.goals));
  set('kpi-avg', agg.avg.toFixed(2));
  set('kpi-leagues', leagues.length);
  set('kpi-split', `${fmt(agg.homeW)} home ‚Ä¢ ${fmt(agg.draw)} draws ‚Ä¢ ${fmt(agg.awayW)} away`);
  set('kpi-split-sub', `${pct(agg.homeW,agg.played)} ‚Ä¢ ${pct(agg.draw,agg.played)} ‚Ä¢ ${pct(agg.awayW,agg.played)}`);
  // bars
  const total=agg.played;
  $('seg-home').style.width = total?(agg.homeW*100/total)+'%':'0%';
  $('seg-draw').style.width = total?(agg.draw*100/total)+'%':'0%';
  $('seg-away').style.width = total?(agg.awayW*100/total)+'%':'0%';
  // completion
  set('kpi-progress', scheduledTotal ? `${fmt(agg.played)} / ${fmt(scheduledTotal)}` : `${fmt(agg.played)} / ‚Äî`);
  set('kpi-progress-sub', scheduledTotal ? pct(agg.played, scheduledTotal) : '‚Äî');
  $('updated').textContent = 'Updated ' + new Date().toLocaleString();

  // highlights
  if(agg.biggest){ set('kpi-biggest', agg.biggest.text); set('kpi-biggest-sub', `Goal difference: ${agg.biggest.diff} ‚Ä¢ ${agg.biggest.sub}`); } else { set('kpi-biggest','‚Äî'); set('kpi-biggest-sub',''); }
  if(agg.highest){ set('kpi-hsg', agg.highest.text); set('kpi-hsg-sub', `Total goals: ${agg.highest.total} ‚Ä¢ ${agg.highest.sub}`); } else { set('kpi-hsg','‚Äî'); set('kpi-hsg-sub',''); }
  if(agg.topGF){ set('kpi-topgf', agg.topGF.team); set('kpi-topgf-sub', `Goals scored: ${agg.topGF.gf}`); } else { set('kpi-topgf','‚Äî'); set('kpi-topgf-sub',''); }
  if(agg.mostGA){ set('kpi-mostga', agg.mostGA.team); set('kpi-mostga-sub', `Goals conceded: ${agg.mostGA.ga}`); } else { set('kpi-mostga','‚Äî'); set('kpi-mostga-sub',''); }
  if(agg.mostCS){ set('kpi-cleansheets', agg.mostCS.team); set('kpi-cleansheets-sub', `Clean sheets: ${agg.mostCS.cs}`); } else { set('kpi-cleansheets','‚Äî'); set('kpi-cleansheets-sub',''); }
}

function renderLeader(teams){
  const sk=$('sk-leader'); if(sk) sk.style.display='none';
  const tbl=$('tbl-leader');
  if(!teams.length){ tbl.style.display='none'; return; }
  const sorted=[...teams].sort((a,b)=> b.pts-a.pts || (b.gd-a.gd) || (b.gf-a.gf) || a.team.localeCompare(b.team));
  let h='<thead><tr><th>#</th><th class="left">Team</th><th>GP</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th><th>CS</th></tr></thead><tbody>';
  sorted.forEach((t,i)=>{
    h+=`<tr>
      <td class="right">${i+1}</td>
      <td class="left">${esc(t.team)}</td>
      <td class="right">${t.gp}</td>
      <td class="right">${t.w}</td>
      <td class="right">${t.d}</td>
      <td class="right">${t.l}</td>
      <td class="right">${t.gf}</td>
      <td class="right">${t.ga}</td>
      <td class="right">${t.gd}</td>
      <td class="right"><strong>${t.pts}</strong></td>
      <td class="right">${t.cs}</td>
    </tr>`;
  });
  h+='</tbody>'; tbl.innerHTML=h; tbl.style.display='table';
  $('leaderboard-card').classList.add('ready');
}

function renderTopTables(teams){
  const gf=[...teams].sort((a,b)=> b.gf-a.gf || a.team.localeCompare(b.team)).slice(0,10);
  const ga=[...teams].sort((a,b)=> a.ga-b.ga || a.team.localeCompare(b.team)).slice(0,10);

  const gfBody=$('tbl-gf'); const gaBody=$('tbl-ga');
  $('sk-gf').style.display='none'; $('sk-ga').style.display='none';

  let gfh='<thead><tr><th>#</th><th class="left">Team</th><th>GP</th><th>GF</th><th>GD</th><th>Pts</th></tr></thead><tbody>';
  gf.forEach((t,i)=> gfh+=`<tr><td class="right">${i+1}</td><td class="left">${esc(t.team)}</td><td class="right">${t.gp}</td><td class="right">${t.gf}</td><td class="right">${t.gd}</td><td class="right">${t.pts}</td></tr>`);
  gfh+='</tbody>'; gfBody.innerHTML=gfh; gfBody.style.display='table'; $('gf-card').classList.add('ready');

  let gah='<thead><tr><th>#</th><th class="left">Team</th><th>GP</th><th>GA</th><th>GD</th><th>Pts</th></tr></thead><tbody>';
  ga.forEach((t,i)=> gah+=`<tr><td class="right">${i+1}</td><td class="left">${esc(t.team)}</td><td class="right">${t.gp}</td><td class="right">${t.ga}</td><td class="right">${t.gd}</td><td class="right">${t.pts}</td></tr>`);
  gah+='</tbody>'; gaBody.innerHTML=gah; gaBody.style.display='table'; $('ga-card').classList.add('ready');
}

function renderCS(teams){
  const sk=$('sk-cs'); if(sk) sk.style.display='none';
  const tbl=$('tbl-cs');
  const sorted=[...teams].sort((a,b)=> b.cs-a.cs || a.team.localeCompare(b.team)).slice(0,10);
  if(!sorted.length){ tbl.style.display='none'; return; }
  let h='<thead><tr><th>#</th><th class="left">Team</th><th>GP</th><th>CS</th><th>GA</th><th>Pts</th></tr></thead><tbody>';
  sorted.forEach((t,i)=>{ h+=`<tr><td class="right">${i+1}</td><td class="left">${esc(t.team)}</td><td class="right">${t.gp}</td><td class="right">${t.cs}</td><td class="right">${t.ga}</td><td class="right">${t.pts}</td></tr>`; });
  h+='</tbody>'; tbl.innerHTML=h; tbl.style.display='table'; $('cs-card').classList.add('ready');
}

function renderLeagueMini(minis){
  const host=$('league-mini'); host.innerHTML='';
  minis.forEach(m=>{
    const line = `${m.played?m.avg.toFixed(2):'0.00'} avg ‚Ä¢ ${pct(m.homeW,m.played)} / ${pct(m.draw,m.played)} / ${pct(m.awayW,m.played)} ‚Ä¢ ${pct(m.played,m.scheduled||0)}`;
    const div=document.createElement('div');
    div.className='badge'; div.style.width='100%';
    div.innerHTML = `<img src="${BADGE_BASE}${m.league}-League.png" alt="${esc(m.league)}"><div><div><strong>${esc(m.league)}</strong></div><div class="note">${line}</div></div>`;
    host.appendChild(div);
  });
}

function renderTimeline(matches){
  const dated=matches.filter(m=>m.doneOn);
  const card=$('timeline-card');
  if(dated.length<3){ card.style.display='none'; return; }
  card.style.display='block';

  const byDay={}; dated.forEach(m=>{const k=m.doneOn.toISOString().slice(0,10); byDay[k]=(byDay[k]||0)+(m.hg+m.ag);});
  const keys=Object.keys(byDay).sort(); const vals=keys.map(k=>byDay[k]);

  const canvas=$('goals-canvas'), ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const pad=28,W=canvas.width,H=canvas.height, max=Math.max(...vals,5);
  const x=i=> pad + i*(W-2*pad)/Math.max(1,(keys.length-1));
  const y=v=> H-pad - (v/max)*(H-2*pad);

  ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.moveTo(pad,pad); ctx.lineTo(pad,H-pad); ctx.stroke();

  ctx.strokeStyle='#f9d71c'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(x(0),y(vals[0])); for(let i=1;i<vals.length;i++) ctx.lineTo(x(i),y(vals[i])); ctx.stroke();
  ctx.fillStyle='#ffffff'; vals.forEach((v,i)=>{ ctx.beginPath(); ctx.arc(x(i),y(v),3,0,Math.PI*2); ctx.fill(); });
}

function renderFormTable(perTeamMatches){
  const entries=[];
  for(const t of Object.keys(perTeamMatches)){
    const list = perTeamMatches[t].filter(x=>x.date).sort((a,b)=> a.date-b.date);
    if(!list.length) continue;
    const last5 = list.slice(-5).map(x=>x.res);
    const pts = last5.reduce((s,r)=>s+(r==='W'?3:(r==='D'?1:0)),0);
    entries.push({team:t,last5,pts});
  }
  const card=$('form-card');
  if(!entries.length){ card.style.display='none'; return; }
  card.style.display='block';
  entries.sort((a,b)=> b.pts-a.pts || a.team.localeCompare(b.team));
  const top=entries.slice(0,12);
  const icon=r=>({W:'üü©',D:'üü®',L:'üü•'})[r]||'‚¨ú';
  let h='<thead><tr><th>#</th><th class="left">Team</th><th>Form</th><th>Pts (5)</th></tr></thead><tbody>';
  top.forEach((e,i)=>{ h+=`<tr><td class="right">${i+1}</td><td class="left">${esc(e.team)}</td><td>${e.last5.map(icon).join(' ')}</td><td class="right">${e.pts}</td></tr>`; });
  h+='</tbody>'; $('tbl-form').innerHTML=h;
}

/* ========= Controller ========= */
async function run(selectedKeys){
  if(!selectedKeys||!selectedKeys.length) selectedKeys=['All'];

  // reset loaders
  ['sk-leader','sk-gf','sk-ga','sk-cs'].forEach(id=>{ const el=$(id); if(el) el.style.display='block'; });
  ['tbl-leader','tbl-gf','tbl-ga','tbl-cs'].forEach(id=>{ const el=$(id); if(el) el.style.display='none'; });
  ['leaderboard-card','gf-card','ga-card','cs-card'].forEach(id=>$(id).classList.remove('ready'));

  const {matches, perLeague, scheduledTotal, leagues} = await loadAll(selectedKeys);
  const agg = aggregate(matches);
  const minis = leagueAggregates(perLeague);

  renderKPIsBase(agg, leagues, scheduledTotal);
  renderLeader(agg.teams);
  renderTopTables(agg.teams);
  renderCS(agg.teams);
  renderLeagueMini(minis);
  renderTimeline(matches);
  renderFormTable(agg.perTeamMatches);
}

function boot(){
  // render league filter row using badges (no squish)
  const host=$('filters'); host.innerHTML='';
  // All
  const all=document.createElement('div'); all.className='badge active'; all.dataset.key='All';
  all.innerHTML=`<img src="https://efpl-assets.pages.dev/img/logo.png" alt="All"><span>All</span>`;
  all.onclick=()=>select('All'); host.appendChild(all);
  // Leagues
  LEAGUES.filter(x=>x.id).forEach(l=>{
    const div=document.createElement('div'); div.className='badge'; div.dataset.key=l.key;
    div.innerHTML=`<img src="${BADGE_BASE}${l.badge}" alt="${esc(l.key)}"><span>${esc(l.key)}</span>`;
    div.onclick=()=>select(l.key); host.appendChild(div);
  });
  run(['All']);
}
boot();
</script>
</body>
</html>
