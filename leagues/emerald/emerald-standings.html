<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>eFPL Emerald Standings â€” Season 2</title>

<link rel="preconnect" href="https://docs.google.com" crossorigin>
<link rel="preconnect" href="https://www.google.com" crossorigin>

<style>
:root{
  --card:#00143b; --text:#ffffff;
  --header-bg:#f9d71c; --header-text:#00143b;
  --row1:#001a4d; --row2:#002060; --hover:#002b80;
  --accent:#f9d71c; --fx-border:rgba(249,215,28,.55);
}
html,body{background:transparent}
body{margin:0;font:15px/1.5 "Segoe UI",Arial,sans-serif;color:var(--text);}
.wrap{max-width:1000px;margin:24px auto;padding:16px;}
.card{background:var(--card);border-radius:12px;overflow:hidden}

/* Title */
.title{display:flex;justify-content:space-between;align-items:center;margin:0 0 12px;padding:12px}
.title h1{font-size:20px;margin:0;color:var(--text);display:flex;align-items:center;gap:10px}
.badge{background:var(--accent);color:#000;padding:4px 12px;border-radius:999px;font-weight:700}
.title-sponsor-logo{height:26px;vertical-align:middle;transition:transform .2s}
.title-sponsor-logo:hover{transform:scale(1.08)}

/* Tables */
table{width:100%;border-collapse:collapse}
thead th{
  background:var(--header-bg);color:var(--header-text);
  font-size:13px;text-transform:uppercase;letter-spacing:.03em;
  padding:10px;text-align:center;
}
tbody td{padding:12px;text-align:center;font-weight:500}
tbody tr:nth-child(odd){background:var(--row1)}
tbody tr:nth-child(even){background:var(--row2)}
tbody tr:hover{background:var(--hover)}
td.right{text-align:right}
td.points{font-weight:800}
td:first-child{font-weight:800}

/* Top 6 qualification band */
tbody tr.pos-top6 td{
  position:relative;
  background:var(--row1)!important;
  color:var(--text);
}
tbody tr.pos-top6 td:first-child::before{
  content:"";position:absolute;left:0;top:0;bottom:0;width:3px;background:#f9d71c;
}

/* 7â€“10 playoff band */
tbody tr.pos-7-10 td{
  position:relative;
  background:linear-gradient(90deg, rgba(255,255,255,.12), rgba(255,255,255,.05)) !important;
  color:var(--text);
}
tbody tr.pos-7-10 td:first-child::before{
  content:"";position:absolute;left:0;top:0;bottom:0;width:3px;background:#a8b5c8;
}

/* Champion row still gets subtle glow */
tbody tr.pos-1 td{
  background:linear-gradient(90deg, rgba(249,215,28,.18), rgba(249,215,28,.08)) !important;
  color:var(--text);font-weight:800;position:relative;
}
tbody tr.pos-1 td:first-child::before{
  content:"";position:absolute;left:0;top:0;bottom:0;width:5px;
  background:var(--accent);border-top-left-radius:10px;border-bottom-left-radius:10px;
}
tbody tr.pos-1 td:nth-child(2)::before{
  content:"ðŸ‘‘";margin-right:8px;display:inline-block;transform:translateY(1px);
}

/* Cut line after top 6 */
tbody tr.after-top6 td{border-top:2px dashed var(--fx-border);}
tbody tr:last-child td{box-shadow:inset 0 -1px 0 rgba(255,255,255,.12)}

/* Form pills (refined) */
.form{
  display:inline-flex;gap:4px;align-items:center;justify-content:center;
  vertical-align:middle;white-space:nowrap;
}
.fpill{
  display:inline-block;width:16px;height:16px;border-radius:999px;
  font-size:10px;line-height:16px;font-weight:800;text-align:center;
  box-shadow:0 0 0 1px rgba(0,0,0,.15), inset 0 0 0 1px rgba(255,255,255,.12);
}
.f-W{background:#16a34a;color:#fff}
.f-D{background:#e5e7eb;color:#111}
.f-L{background:#dc2626;color:#fff}
@media(max-width:680px){.fpill{width:14px;height:14px;line-height:14px;font-size:9px}}

/* Responsive tables */
.table-desktop{display:block!important}
.table-mobile{display:none!important}
@media(max-width:680px){
  .wrap{padding:12px}
  .card{border-radius:10px}
  .table-desktop{display:none!important}
  .table-mobile{display:block!important}
  .table-mobile th,.table-mobile td{padding:10px;font-size:14px}
  #t-compact .form{display:none!important}
}

/* Skeleton + fade */
.skeleton{
  background:linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.12), rgba(255,255,255,.05));
  background-size:200% 100%;animation:sk 1.1s infinite;
  border-radius:12px;min-height:200px;margin:0 12px 16px;
}
@keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}
.fade-in{opacity:0;transition:opacity .18s ease}
.fade-in.ready{opacity:1}

/* Bottom color key (Horizon Cup) */
.qual-key{
  display:flex;flex-wrap:wrap;gap:14px;align-items:center;
  padding:8px 12px 0;margin:2px 0 4px;color:#cbd5e1;font-size:12px;opacity:.9;
}
.k-item{display:inline-flex;align-items:center;gap:8px;white-space:nowrap}
.k-swatch{
  display:inline-block;width:22px;height:10px;border-radius:3px;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.15);
}
.k-top6{background:#f9d71c;border:1px solid #f9d71c;}
.k-playoff{background:#a8b5c8;border:1px solid #a8b5c8;}
.k-label{color:#e5e7eb}
@media(max-width:680px){.qual-key{font-size:11px;gap:10px}.k-swatch{width:18px;height:8px}}

/* Footer */
.sponsor-footer{
  text-align:center;font-size:13px;color:#cbd5e1;opacity:.9;
  padding:10px;border-top:1px solid rgba(249,215,28,.25);line-height:1.6;
}
.sponsor-footer .footer-logo{height:28px;vertical-align:middle;margin:0 6px;transition:transform .2s}
.sponsor-footer a:hover .footer-logo{transform:scale(1.08)}

@media(max-width:560px){
  .title{flex-wrap:wrap;gap:8px}
  .title h1{flex:1 1 100%;font-size:18px;line-height:1.2}
  .title-sponsor-logo{height:20px}
  .title .badge{order:2;width:100%;font-size:12px;padding:6px 10px;text-align:left}
}
@media(max-width:380px){
  .title h1{font-size:16px}
  .title-sponsor-logo{height:18px}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="title">
      <h1>
        <a href="https://www.instant-gaming.com/?igr=eFPL"
           target="_blank" rel="sponsored noopener noreferrer nofollow"
           aria-label="Instant Gaming - save on games">
          <img src="https://efpl-assets.pages.dev/img/instant-gaming.png"
               alt="Instant Gaming" class="title-sponsor-logo">
        </a>
        Emerald League | Season 2
      </h1>
      <span class="badge" id="updated">Loadingâ€¦</span>
    </div>

    <div id="sk-standings" class="skeleton"></div>

    <div class="table-desktop fade-in"><table id="t"></table></div>
    <div class="table-mobile fade-in"><table id="t-compact"></table></div>

    <div class="qual-key" aria-label="Qualification color key">
      <div class="k-item"><span class="k-swatch k-top6" aria-hidden="true"></span><span class="k-label">Horizon Cup qualification</span></div>
      <div class="k-item"><span class="k-swatch k-playoff" aria-hidden="true"></span><span class="k-label">Horizon Cup playoff</span></div>
    </div>

    <p id="deductions-note" style="display:none;color:#cbd5e1;font-size:13px;text-align:left;margin:6px 12px 0;opacity:.85">
      * denotes points deduction
    </p>

    <div class="sponsor-footer">
      This league is sponsored by
      <a href="https://www.instant-gaming.com/?igr=eFPL"
         target="_blank" rel="sponsored noopener noreferrer nofollow"
         aria-label="Instant Gaming - save on games">
        <img src="https://efpl-assets.pages.dev/img/instant-gaming.png"
             alt="Instant Gaming" class="footer-logo">
      </a>
      Save up to <strong>90%</strong> on all digital games!
    </div>
  </div>
</div>

<script>
/* ===== CONFIG (Emerald - Horizon Cup bands) ===== */
const SHEET_ID='1rD_03y276wGjjlukus6icgwq_FPcOgc70654dOOG6sg';
const SHEET_TAB='Embed';
const RANGE='A1:K11';
const BUCKET_MS=5*60*1000;
const CB=Math.floor(Date.now()/BUCKET_MS);

/* Helpers */
function isNumeric(v){return /^-?\\d+(\\.\\d+)?$/.test(String(v));}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function parseGviz(t){const a=t.indexOf('{'),b=t.lastIndexOf('}');if(a===-1||b===-1)throw new Error('Invalid GViz');return JSON.parse(t.slice(a,b+1));}

function setTableMode(){
  const compact=window.matchMedia('(max-width:680px)').matches;
  document.querySelector('.table-desktop').style.display=compact?'none':'block';
  document.querySelector('.table-mobile').style.display=compact?'block':'none';
}
window.addEventListener('resize',setTableMode);
window.addEventListener('orientationchange',setTableMode);

function paintInstant(elId,key,skId){
  try{
    const c=localStorage.getItem(key);
    if(c){
      document.getElementById(elId).innerHTML=c;
      document.querySelectorAll('.fade-in').forEach(n=>n.classList.add('ready'));
      if(skId)document.getElementById(skId).style.display='none';
      checkForDeductions();setTableMode();
    }
  }catch(e){}
}
function saveHTML(k,h){try{localStorage.setItem(k,h);}catch(e){}}

function checkForDeductions(){
  const note=document.getElementById('deductions-note');
  if(!note)return;
  const hasStar=(document.getElementById('t').textContent.includes('*')||
                 document.getElementById('t-compact').textContent.includes('*'));
  note.style.display=hasStar?'block':'none';
}

/* Normalised W/D/L pills */
function renderFormLetters(s){
  const raw = String(s ?? "")
    .replace(/[,\s\\-_/|.]+/g,"")
    .toUpperCase()
    .replace(/[^WDL]/g,"")
    .slice(-5);
  if(!raw) return '';
  const aria = 'Form: ' + [...raw].join(' ');
  return '<span class="form" aria-label="'+esc(aria)+'">'+
    [...raw].map(ch=>{
      const cls = ch==='W' ? 'f-W' : ch==='D' ? 'f-D' : 'f-L';
      return `<span class="fpill ${cls}">${ch}</span>`;
    }).join('')+
  '</span>';
}

/* Instant paint from cache */
paintInstant('t','efpl:emerald:horizon:full','sk-standings');
paintInstant('t-compact','efpl:emerald:horizon:mob','sk-standings');

async function loadStandings(){
  const statusEl=document.getElementById('updated');
  try{
    const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_TAB)}&range=${encodeURIComponent(RANGE)}&cachebust=${CB}`;
    const res=await fetch(url);
    const text=await res.text();
    if(!res.ok) throw new Error('HTTP '+res.status);
    const json=parseGviz(text);

    const headers=json.table.cols.map(c=>c.label||'');
    /* prefer formatted value (c.f) for text like "W D L W D" */
    const rows=(json.table.rows||[]).map(r=>(r.c||[]).map(c=>c?(c.f ?? c.v ?? ''):''));
    const iForm=headers.findIndex(h=>String(h||'').toLowerCase().trim().includes('form'));

    let html='<thead><tr>'+headers.map(h=>`<th>${esc(h)}</th>`).join('')+'</tr></thead><tbody>';
    for(let idx=0; idx<rows.length; idx++){
      const r=rows[idx]; if(!r || r.every(x=>String(x).trim()==='')) continue;

      const posClass=(idx<=5)?'pos-top6':(idx<=9)?'pos-7-10':''; // 0-based idx
      const cutTop6=(idx===6)?'after-top6':'';
      const rowClass=['pos-'+(idx+1), posClass, cutTop6].filter(Boolean).join(' ');

      html+=`<tr class="${rowClass}">`;
      r.forEach((cell,i)=>{
        const s=esc(cell??'');
        const right=isNumeric(s)?' right':'';
        const pts=(headers[i]||'').toLowerCase().includes('pts')?' points':'';
        const val=(i===iForm)?renderFormLetters(cell):s;
        html+=`<td class="${right}${pts}">${val}</td>`;
      });
      html+='</tr>';
    }
    html+='</tbody>';
    document.getElementById('t').innerHTML=html;
    saveHTML('efpl:emerald:horizon:full',html);

    buildCompact(headers,rows);
    saveHTML('efpl:emerald:horizon:mob',document.getElementById('t-compact').innerHTML);

    document.querySelectorAll('.fade-in').forEach(n=>n.classList.add('ready'));
    document.getElementById('sk-standings').style.display='none';
    const d=new Date(),pad=n=>String(n).padStart(2,'0'),yy=String(d.getFullYear()).slice(-2);
    statusEl.textContent=`Updated ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${yy}`;
    checkForDeductions(); setTableMode();
  }catch(e){
    statusEl.textContent='Error - '+e.message;
  }
}

function buildCompact(headers,rows){
  function findCol(names){
    const lower=headers.map(h=>(h||'').toLowerCase());
    for(const n of names){const i=lower.indexOf(n); if(i!==-1) return i;}
    return -1;
  }
  const iPos=findCol(['pos','#','position','rank']);
  const iTeam=findCol(['team','club','name']);
  const iP=findCol(['p','pl','played']);
  const iPts=findCol(['pts','points']);
  const cols=[iPos,iTeam,iP,iPts].map((i,k)=>i!==-1?i:k);

  let out='<thead><tr><th>POS</th><th>Team</th><th>P</th><th>PTS</th></tr></thead><tbody>';
  for(let idx=0; idx<rows.length; idx++){
    const r=rows[idx]; if(!r || r.every(x=>String(x).trim()==='')) continue;

    const pos=r[cols[0]]??'', team=r[cols[1]]??'', p=r[cols[2]]??'', pts=r[cols[3]]??'';

    const posClass=(idx<=5)?'pos-top6':(idx<=9)?'pos-7-10':'';
    const cutTop6=(idx===6)?'after-top6':'';
    const rowClass=[posClass, cutTop6].filter(Boolean).join(' ');

    out+=`<tr class="${rowClass}">
      <td class="right">${esc(pos)}</td>
      <td>${esc(team)}</td>
      <td class="right">${esc(p)}</td>
      <td class="right points">${esc(pts)}</td>
    </tr>`;
  }
  out+='</tbody>';
  document.getElementById('t-compact').innerHTML=out;
}

loadStandings();
</script>
</body>
</html>
